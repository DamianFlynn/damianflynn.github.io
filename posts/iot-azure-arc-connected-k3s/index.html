<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,height=device-height,initial-scale=1,minimum-scale=1"><meta name=robots content="noodp"><title>IoT - Azure Arc Connected K3s - Incredible Technology, Incredibly Simple</title><meta name=Description content><meta property="og:url" content="https://damianflynn.github.io/posts/iot-azure-arc-connected-k3s/"><meta property="og:site_name" content="Incredible Technology, Incredibly Simple"><meta property="og:title" content="IoT - Azure Arc Connected K3s "><meta property="og:description" content="Transform your on-premises infrastructure into a cloud-integrated powerhouse by combining K3s Kubernetes with Azure Arc on an Ubuntu server. This guide walks you through every stepâ€”from deploying K3s and configuring user access to connecting your cluster to Azure Arc, enabling observability with Grafana, and integrating full-scale monitoring with Azure Monitor. Whether youâ€™re building edge deployments or hybrid IoT solutions, this tutorial gives you a production-grade environment with the flexibility of the cloud and control of local resources."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-04-24T12:24:00+00:00"><meta property="article:modified_time" content="2025-05-13T22:43:00+00:00"><meta property="article:tag" content="IaC"><meta property="article:tag" content="Linux"><meta property="article:tag" content="Docker"><meta property="article:tag" content="IoT"><meta property="og:image" content="https://damianflynn.github.io/images/avatar.webp"><meta property="og:see_also" content="https://damianflynn.github.io/posts/iot-nodered-on-arc-enabled-edge/"><meta property="og:see_also" content="https://damianflynn.github.io/posts/azure-arc-enabling-an-ubuntu-server/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://damianflynn.github.io/images/avatar.webp"><meta name=twitter:title content="IoT - Azure Arc Connected K3s "><meta name=twitter:description content="Transform your on-premises infrastructure into a cloud-integrated powerhouse by combining K3s Kubernetes with Azure Arc on an Ubuntu server. This guide walks you through every stepâ€”from deploying K3s and configuring user access to connecting your cluster to Azure Arc, enabling observability with Grafana, and integrating full-scale monitoring with Azure Monitor. Whether youâ€™re building edge deployments or hybrid IoT solutions, this tutorial gives you a production-grade environment with the flexibility of the cloud and control of local resources."><meta name=twitter:site content="@damian_flynn"><meta name=application-name content="TechSimplified"><meta name=apple-mobile-web-app-title content="TechSimplified"><meta name=theme-color content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><meta name=twitter:creator content="@damian_flynn"><link rel="shortcut icon" type=image/x-icon href=/favicons/img-favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicons/img-favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicons/img-favicon-16x16.png><link rel=icon type=image/png sizes=192x192 href=/favicons/img-android-chrome-192x192.png><link rel=icon type=image/png sizes=512x512 href=/favicons/img-android-chrome-512x512.png><link rel=apple-touch-icon sizes=180x180 href=/favicons/img-apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=https://damianflynn.github.io/posts/iot-azure-arc-connected-k3s/><link rel=prev href=https://damianflynn.github.io/posts/azure-arc-enabling-an-ubuntu-server/><link rel=next href=https://damianflynn.github.io/posts/iot-nodered-on-arc-enabled-edge/><link rel=stylesheet href=/css/css-styles.min.css><link rel=stylesheet href=/css/n8n-chat.min.css><script type=module>
	import { createChat } from 'https://cdn.jsdelivr.net/npm/@n8n/chat/dist/chat.bundle.es.js';

	createChat({
		webhookUrl: 'https://n8n.deercrest.info/webhook/b76d02c0-b406-4d21-b6bf-8ad2c623def3/chat',
    initialMessages: [
      'Hi there! ðŸ‘‹',
      'My name is Nathan. How can I assist you today?'
    ],
    i18n: {
      en: {
        title: 'Search ðŸ”Ž & Chat! ðŸ‘‹',
        subtitle: "Start a chat. We're here to help you 24/7.",
        footer: '',
        getStarted: 'New Conversation',
        inputPlaceholder: 'Type your question..',
      },
    },
    showWelcomeScreen: false,
	  defaultLanguage: 'en'
	});
</script><script src=/js/alpinejs.js defer></script><style>[x-cloak]{display:none!important}</style><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"IoT - Azure Arc Connected K3s ","inLanguage":"en-us","mainEntityOfPage":{"@type":"WebPage","@id":"https://damianflynn.github.io/posts/iot-azure-arc-connected-k3s/"},"image":["https://damianflynn.github.io/images/series/azure-iot-featured.png"],"genre":"posts","keywords":["IaC","Linux","Docker","IoT"],"wordcount":4121,"url":"https://damianflynn.github.io/posts/iot-azure-arc-connected-k3s/","datePublished":"2025-04-24T12:24:00+00:00","dateModified":"2025-05-13T22:43:00+00:00","publisher":{"@type":"Organization","name":"xxxx","logo":{"@type":"ImageObject","url":"https://damianflynn.github.io/images/avatar.webp","width":400,"height":400}},"author":{"@type":"Person","name":"damian","url":"/"},"description":""}</script></head><body data-instant-intensity=viewport class="bg-white font-sans tracking-wide text-base text-gray-700 print:text-black font-medium break-words hyphens antialiased flex flex-col min-h-screen ta-page-scrolling"><div role=navigation class="absolute inset-x-0 top-0 z-10 w-full text-center h-16 sm:h-20 lg:h-24 xl:h-28" x-data=taNavigation><a href=/ class="absolute left-0 top-0 h-full flex-center w-16 sm:w-20 lg:w-24 xl:w-28 p-3 sm:p-4 lg:p-5 xl:p-6 bg-secondary-500"><span class=sr-only>To the home page</span>
<img src=/images/img-logo-damian-flynn-white.svg alt="Logo Damian Flynn" class=w-full></a><div class="absolute lg:hidden right-0 top-0 text-white w-16 h-16 sm:w-20 sm:h-20 p-3 sm:p-4"><svg class="w-full h-full" viewbox="0 0 20 20" fill="currentcolor"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4A1 1 0 013 5zm0 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/></svg></div><div class="hidden lg:flex items-center justify-between w-full h-full max-w-screen-2xl mx-auto px-40"><div class="flex h-full text-base font-semibold uppercase"><div class="relative flex-center text-primary-500 px-4"><a class=menu-item href=/>Home</a></div><div class="relative flex-center text-primary-500 px-4"><a class=menu-item href=/posts/>Articles</a></div><div class="relative flex-center text-primary-500 px-4"><a class=menu-item href=/series/>Topics</a></div><div class="relative flex-center text-primary-500 px-4"><a class=menu-item href=/about/>About</a></div></div><div class="flex items-center -mr-2 xl:-mr-4"><a href=https://www.youtube.com/channel/UCC-9OqE4nfLxDf-TonKqIRw/ class="block text-primary-500 h-6 w-6 mx-2 xl:mx-4 drop-shadow-sharp" target=_blank title="Opens in new Window"><span class=sr-only>Youtube </span><svg class="w-full h-full" fill="currentcolor" viewbox="0 0 576 512"><path d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78.0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"/></svg>
</a><a href=https://github.com/damianflynn class="block text-primary-500 h-6 w-6 mx-2 xl:mx-4 drop-shadow-sharp" target=_blank title="Opens in new Window"><span class=sr-only>GitHub </span><svg class="w-full h-full" fill="currentcolor" viewbox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8.0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8.0-21.5 4.9-32.3 14.6-51.8 45.3.0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8.0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9.0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2.0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8.0-73.5 38.7-73.5 82.6.0 87.8 80.4 101.3 150.4 101.3h48.2c70.3.0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8.0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
</a><a href=https://www.x.com/damian_flynn class="block text-primary-500 h-6 w-6 mx-2 xl:mx-4 drop-shadow-sharp" target=_blank title="Opens in new Window"><span class=sr-only>X </span><svg class="w-full h-full" fill="currentcolor" viewbox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645.0 138.72-105.583 298.558-298.558 298.558-59.452.0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055.0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421.0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391.0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04.0-57.828 46.782-104.934 104.934-104.934 30.213.0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
</a><a href=https://www.linkedin.com/in/damianflynn class="block text-primary-500 h-6 w-6 mx-2 xl:mx-4 drop-shadow-sharp" target=_blank title="Opens in new Window"><span class=sr-only>Linkedin</span>
<svg class="w-full h-full" fill="currentcolor" viewbox="0 0 448 512"><path d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg></a></div></div><div class="fixed lg:hidden inset-0 backdrop-filter backdrop-blur-sm bg-gray-900 bg-opacity-75 z-50" x-show=modal x-transition.opacity.duration.500ms></div><div class="ta-navigation-modal fixed lg:hidden inset-y-0 right-0 w-10/12 sm:w-2/3 bg-white pt-32 z-50" x-ref=modal><div class="absolute top-0 right-0 text-primary-500 w-16 h-16 p-2"><svg class="w-full h-full" viewbox="0 0 20 20" fill="currentcolor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414.0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg></div><div class="flex flex-col justify-between text-left text-3xl h-full ml-12"><div class="flex flex-col"><div class="font-semibold text-primary-500 p-2 sm:my-2"><a href=/>Home</a></div><div class="font-semibold text-primary-500 p-2 sm:my-2"><a href=/posts/>Articles</a></div><div class="font-semibold text-primary-500 p-2 sm:my-2"><a href=/series/>Topics</a></div><div class="font-semibold text-primary-500 p-2 sm:my-2"><a href=/about/>About</a></div></div><div class="flex flex-wrap mb-12"><a href=https://www.youtube.com/channel/UCC-9OqE4nfLxDf-TonKqIRw/ class="block text-primary-500 h-8 w-8 mx-4 sm:mx-6" target=_blank title="Opens in new Window"><span class=sr-only>Youtube </span><svg class="w-full h-full" fill="currentcolor" viewbox="0 0 576 512"><path d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78.0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"/></svg>
</a><a href=https://github.com/damianflynn class="block text-primary-500 h-8 w-8 mx-4 sm:mx-6" target=_blank title="Opens in new Window"><span class=sr-only>GitHub </span><svg class="w-full h-full" fill="currentcolor" viewbox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8.0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8.0-21.5 4.9-32.3 14.6-51.8 45.3.0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8.0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9.0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2.0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8.0-73.5 38.7-73.5 82.6.0 87.8 80.4 101.3 150.4 101.3h48.2c70.3.0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8.0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
</a><a href=https://www.x.com/damian_flynn class="block text-primary-500 h-8 w-8 mx-4 sm:mx-6" target=_blank title="Opens in new Window"><span class=sr-only>X </span><svg class="w-full h-full" fill="currentcolor" viewbox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645.0 138.72-105.583 298.558-298.558 298.558-59.452.0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055.0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421.0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391.0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04.0-57.828 46.782-104.934 104.934-104.934 30.213.0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
</a><a href=https://www.linkedin.com/in/damianflynn class="block text-primary-500 h-8 w-8 mx-4 sm:mx-6" target=_blank title="Opens in new Window"><span class=sr-only>Linkedin</span>
<svg class="w-full h-full" fill="currentcolor" viewbox="0 0 448 512"><path d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg></a></div></div></div><div class="ta-navigation-scroll top-0 inset-x-0 z-40" x-ref=scroll><div class="flex justify-between items-center lg:hidden"><a href=/index.html class="flex-center w-16 sm:w-20 p-3 sm:p-4 h-16 sm:h-20 bg-secondary-500"><span class=sr-only>To the home page</span>
<img src=/images/img-logo-damian-flynn-white.svg alt="Logo Damian Flynn" class=w-full></a><div class="flex-shrink-0 text-primary-500 w-16 h-16 p-3"><svg class="w-full h-full" viewbox="0 0 20 20" fill="currentcolor"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4A1 1 0 013 5zm0 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/></svg></div></div><div class="relative hidden lg:flex justify-between items-center h-20"><a href=/index.html class="absolute top-0 left-0 flex-center w-20 h-20 p-4 bg-secondary-500"><span class=sr-only>To the home page</span>
<img src=/images/img-logo-damian-flynn-white.svg alt="Logo Damian Flynn" class=w-full></a><div class="flex items-center justify-between max-w-screen-2xl w-full h-full mx-auto px-40"><div class="flex h-full text-base font-semibold uppercase -ml-4"><div class="relative flex-center font-semibold text-primary-500 p-2 sm:my-2"><a class=menu-item href=/>Home</a></div><div class="relative flex-center font-semibold text-primary-500 p-2 sm:my-2"><a class=menu-item href=/posts/>Articles</a></div><div class="relative flex-center font-semibold text-primary-500 p-2 sm:my-2"><a class=menu-item href=/series/>Topics</a></div><div class="relative flex-center font-semibold text-primary-500 p-2 sm:my-2"><a class=menu-item href=/about/>About</a></div></div><div class="flex items-center -mr-2 xl:-mr-4"><a href=https://www.youtube.com/channel/UCC-9OqE4nfLxDf-TonKqIRw/ class="block text-primary-500 h-6 w-6 mx-2 xl:mx-4" target=_blank title="Opens in new Window"><span class=sr-only>Youtube </span><svg class="w-full h-full" fill="currentcolor" viewbox="0 0 576 512"><path d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78.0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"/></svg>
</a><a href=https://github.com/damianflynn class="block text-primary-500 h-6 w-6 mx-2 xl:mx-4" target=_blank title="Opens in new Window"><span class=sr-only>GitHub </span><svg class="w-full h-full" fill="currentcolor" viewbox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8.0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8.0-21.5 4.9-32.3 14.6-51.8 45.3.0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8.0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9.0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2.0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8.0-73.5 38.7-73.5 82.6.0 87.8 80.4 101.3 150.4 101.3h48.2c70.3.0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8.0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
</a><a href=https://www.x.com/damian_flynn class="block text-primary-500 h-6 w-6 mx-2 xl:mx-4" target=_blank title="Opens in new Window"><span class=sr-only>X </span><svg class="w-full h-full" fill="currentcolor" viewbox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645.0 138.72-105.583 298.558-298.558 298.558-59.452.0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055.0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421.0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391.0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04.0-57.828 46.782-104.934 104.934-104.934 30.213.0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
</a><a href=https://www.linkedin.com/in/damianflynn class="block text-primary-500 h-6 w-6 mx-2 xl:mx-4" target=_blank title="Opens in new Window"><span class=sr-only>Linkedin</span>
<svg class="w-full h-full" fill="currentcolor" viewbox="0 0 448 512"><path d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg></a></div></div></div><div class="absolute inset-0 bg-white bg-opacity-90 shadow-lg backdrop-filter backdrop-blur-xs -z-1"></div></div></div><main role=main class="flex-grow-1 full"><div class="relative bg-gradient-article pt-16 sm:pt-20 lg:pt-24 xl:pt-28 isolate"><div class="absolute inset-x-0 -bottom-72 h-96"><div class="w-full h-full flex-center overflow-hidden"><img src=/images/img-exclude-white.svg alt class="w-full h-full min-w-[768px]"></div></div><div class="flex flex-col-reverse lg:flex-row justify-between w-full max-w-screen-2xl mx-auto text-secondary-500 px-12 lg:pl-40 xl:pr-0 pt-12 xl:pt-16 pb-16 isolate"><div class="max-w-2xl lg:mr-12 break-hyphen"><nav aria-label=breadcrumb><ol class="flex flex-wrap items-center text-sm leading-none font-bold mb-4 sm:mb-2"><li class=pr-1><a href=/index.html class="flex items-center text-primary-500 py-1"><div class="h-5 w-5"><svg class="w-full h-full" fill="currentcolor" viewbox="0 0 576 512"><path d="M280.37 148.26 96 300.11V464a16 16 0 0016 16l112.06-.29a16 16 0 0015.92-16V368a16 16 0 0116-16h64a16 16 0 0116 16v95.64a16 16 0 0016 16.05L464 480a16 16 0 0016-16V3e2L295.67 148.26a12.19 12.19.0 00-15.3.0zM571.6 251.47 488 182.56V44.05a12 12 0 00-12-12h-56a12 12 0 00-12 12v72.61L318.47 43a48 48 0 00-61 0L4.34 251.47a12 12 0 00-1.6 16.9l25.5 31A12 12 0 0045.15 301l235.22-193.74a12.19 12.19.0 0115.3.0L530.9 301a12 12 0 0016.9-1.6l25.5-31a12 12 0 00-1.7-16.93z"/></svg></div><span class=ml-2>Home</span></a></li><li class="flex items-center"><div class="h-4 w-4"><svg class="w-full h-full" fill="currentcolor" viewbox="0 0 512 512" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="m15 0h525.355a15 15 0 0115 15v38.555a15 15 0 01-15 15H15a15 15 0 01-15-15V15A15 15 0 0115 0z" transform="matrix(-.5 .8660254 -.8660254 -.5 424.048 32.277)"/></svg></div><a href=/posts class="flex items-center text-primary-500 px-1 py-1">Articles</a></li><li class="flex items-center text-secondary-500"><div class="h-4 w-4"><svg class="w-full h-full" fill="currentcolor" viewbox="0 0 512 512" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="m15 0h525.355a15 15 0 0115 15v38.555a15 15 0 01-15 15H15a15 15 0 01-15-15V15A15 15 0 0115 0z" transform="matrix(-.5 .8660254 -.8660254 -.5 424.048 32.277)"/></svg></div><span class="px-1 py-1">IoT - Azure Arc Connected K3s</span></li></ol></nav><div class="text-6xl leading-none font-bold mb-2">IoT - Azure Arc Connected K3s</div><div class="text-2xl leading-snug mb-4">Transform your on-premises infrastructure into a cloud-integrated powerhouse by combining K3s Kubernetes with Azure Arc on an Ubuntu server. This guide walks you through every stepâ€”from deploying K3s and configuring user access to connecting your cluster to Azure Arc, enabling observability with Grafana, and integrating full-scale monitoring with Azure Monitor. Whether you&rsquo;re building edge deployments or hybrid IoT solutions, this tutorial gives you a production-grade environment with the flexibility of the cloud and control of local resources.</div><div class="flex flex-wrap items-center -ml-2 mb-8"><a href=/tags/iac/ class="flex items-center text-xs uppercase text-primary-500 font-bold m-2"><span class="h-5 w-5 mr-1"><svg class="w-full h-full" fill="none" viewbox="0 0 24 24" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512.0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828.0l-7-7A1.994 1.994.0 013 12V7a4 4 0 014-4z"/></svg> </span>IaC</a>,&nbsp;<a href=/tags/linux/ class="flex items-center text-xs uppercase text-primary-500 font-bold m-2">
<span class="h-5 w-5 mr-1"><svg class="w-full h-full" fill="none" viewbox="0 0 24 24" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512.0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828.0l-7-7A1.994 1.994.0 013 12V7a4 4 0 014-4z"/></svg> </span>Linux</a>,&nbsp;<a href=/tags/docker/ class="flex items-center text-xs uppercase text-primary-500 font-bold m-2">
<span class="h-5 w-5 mr-1"><svg class="w-full h-full" fill="none" viewbox="0 0 24 24" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512.0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828.0l-7-7A1.994 1.994.0 013 12V7a4 4 0 014-4z"/></svg> </span>Docker</a>,&nbsp;<a href=/tags/iot/ class="flex items-center text-xs uppercase text-primary-500 font-bold m-2">
<span class="h-5 w-5 mr-1"><svg class="w-full h-full" fill="none" viewbox="0 0 24 24" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512.0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828.0l-7-7A1.994 1.994.0 013 12V7a4 4 0 014-4z"/></svg> </span>IoT</a></div><div class="flex items-center"><div class="w-16 h-16 overflow-hidden rounded-full shadow-lg"><img src=/images/damian_flynn.webp alt="Damian Flynn avatar" class="w-full h-full object-cover"><a href=https://linkedin.com/in/damianflynn class=author title=Author rel=author>Damian Flynn</a></div><div class=ml-4><div class="text-secondary-500 text-lg font-bold">Author: <a href=/ title=Author rel=author class=author>damian</a></div><div class="text-gray-500 text-md font-semibold">Published: <time datetime="24 Apr, 2025">24 Apr, 2025</time></div><div class="text-gray-500 text-md font-semibold">Updated: <time datetime="13 May, 2025">13 May, 2025</time></div></div></div></div><div class="relative flex-shrink-0 flex-grow max-w-lg min-w-80 pb-8 lg:pb-0 -mt-12 lg:mt-0 transform md:transform-none scale-110 -z-1"><img class="w-full lg:absolute-center drop-shadow-glow" src=/images/series/azure-iot-featured.png></div></div></div><div id=main class="w-full max-w-screen-2xl mx-auto px-8 lg:px-40 my-24 isolate"><main><div class="grid grid-cols-1 lg:grid-cols-3 gap-x-12 xl:gap-x-24"><div class="lg:col-span-2 copy text-base leading-loose"><p>Starting from an Ubuntu server, which has be Arc Enabled, we can use this as a base for the Azure IoT Operations.</p><ol><li>Arc Enabled Ubuntu Server</li><li>K3s Kubernetes on Ubuntu (Single or Multi-Node)</li></ol><h2 class="relative text-3xl font-bold leading-tight text-secondary-500 mb-2 mt-12 -ml-px"><div id=installing-k3s class="absolute -top-28"></div>Installing K3s</h2><p>K3s provides an installation script that is a convenient way to install it as a service on <code>systemd</code> or <code>openrc</code> based systems. This script is available atÂ <a href=https://get.k3s.io/ target=_blank rel="noopener noreferrer">https://get.k3s.io</a>. To install K3s using this method, connect to the server using <code>ssh</code> and then run:</p><div class="code-block highlight is-closed show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>bash</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-1 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>sysadmin@otedge001:~$ curl -sfL https://get.k3s.io <span class=p>|</span> sh -
</span></span><span class=line><span class=cl><span class=o>[</span>sudo<span class=o>]</span> password <span class=k>for</span> sysadmin: 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span>  Finding release <span class=k>for</span> channel stable
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span>  Using v1.32.3+k3s1 as release
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span>  Downloading <span class=nb>hash</span> https://github.com/k3s-io/k3s/releases/download/v1.32.3+k3s1/sha256sum-amd64.txt
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span>  Downloading binary https://github.com/k3s-io/k3s/releases/download/v1.32.3+k3s1/k3s
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span>  Verifying binary download
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span>  Installing k3s to /usr/local/bin/k3s
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span>  Skipping installation of SELinux RPM
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span>  Creating /usr/local/bin/kubectl symlink to k3s
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span>  Creating /usr/local/bin/crictl symlink to k3s
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span>  Creating /usr/local/bin/ctr symlink to k3s
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span>  Creating killall script /usr/local/bin/k3s-killall.sh
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span>  Creating uninstall script /usr/local/bin/k3s-uninstall.sh
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span>  env: Creating environment file /etc/systemd/system/k3s.service.env
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span>  systemd: Creating service file /etc/systemd/system/k3s.service
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span>  systemd: Enabling k3s unit
</span></span><span class=line><span class=cl>Created symlink /etc/systemd/system/multi-user.target.wants/k3s.service â†’ /etc/systemd/system/k3s.service.
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span>  systemd: Starting k3s</span></span></code></pre></div><p>After running this installation:</p><ul><li>The K3s service will be configured to automatically restart after node reboots or if the process crashes or is killed</li><li>Additional utilities will be installed, includingÂ kubectl,Â crictl,Â ctr,Â k3s-killall.sh, andÂ k3s-uninstall.sh</li><li>AÂ kubeconfigÂ file will be written toÂ /etc/rancher/k3s/k3s.yamlÂ and the kubectl installed by K3s will automatically use it
A single-node server installation is a fully-functional Kubernetes cluster, including all the datastore, control-plane, kubelet, and container runtime components necessary to host workload pods. It is not necessary to add additional server or agents nodes, but you may want to do so to add additional capacity or redundancy to your cluster.</li></ul><p>To install additional agent nodes and add them to the cluster, run the installation script with theÂ <code>K3S_URL</code>Â andÂ <code>K3S_TOKEN</code>Â environment variables. Here is an example showing how to join an agent:</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>shell</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-2 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>curl -sfL https://get.k3s.io <span class=p>|</span> <span class=nv>K3S_URL</span><span class=o>=</span>https://myserver:6443 <span class=nv>K3S_TOKEN</span><span class=o>=</span>mynodetoken sh -</span></span></code></pre></div><p>Setting theÂ <code>K3S_URL</code>Â parameter causes the installer to configure K3s as an agent, instead of a server. The K3s agent will register with the K3s server listening at the supplied URL. The value to use forÂ <code>K3S_TOKEN</code>Â is stored atÂ <code>/var/lib/rancher/k3s/server/node-token</code>Â on your server node.</p><blockquote class=blockquote style=text-align:right><p>Each machine must have a unique hostname. If your machines do not have unique hostnames, pass theÂ K3S_NODE_NAMEÂ environment variable and provide a value with a valid and unique hostname for each node.</p></blockquote><h3 class="text-xl font-bold text-primary-500 leading-tight mb-2" id=k3s-configuration><a href=#k3s-configuration class=header-mark aria-label="Header mark for 'K3s Configuration'"></a>K3s Configuration</h3><p>When you install K3s on Ubuntu using the quick install script, it places the Kubernetes configuration file at <code>/etc/rancher/k3s/k3s.yaml</code>, which is only accessible by the root user. To use <code>kubectl</code> as a non-root user, itâ€™s best to create your own user-level kubeconfig file.</p><p>The following commands will create a <code>.kube</code> directory in your home folder, merge the system kubeconfig with your local config, and generate a flattened, self-contained kubeconfig that you can safely use without needing root access. This setup is particularly useful when you&rsquo;re managing clusters through automation or integrating with tools like Azure Arc, Helm, or GitOps pipelines.</p><div class="code-block highlight is-closed show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>bash</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-3 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=c1># Create the .kube directory in your home folder if it doesn&#39;t exist</span>
</span></span><span class=line><span class=cl>mkdir -p ~/.kube
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Merge the root-level K3s kubeconfig with your user config (if any) into a flattened kubeconfig</span>
</span></span><span class=line><span class=cl><span class=c1># This avoids future permission issues and makes the config self-contained</span>
</span></span><span class=line><span class=cl>sudo <span class=nv>KUBECONFIG</span><span class=o>=</span>~/.kube/config:/etc/rancher/k3s/k3s.yaml kubectl config view --flatten &gt; ~/.kube/merged
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Replace your current user kubeconfig with the merged version</span>
</span></span><span class=line><span class=cl>mv ~/.kube/merged ~/.kube/config
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Set secure permissions so only your user can read/write the kubeconfig</span>
</span></span><span class=line><span class=cl>chmod <span class=m>0600</span> ~/.kube/config
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Set the environment variable so kubectl knows to use your local config</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>KUBECONFIG</span><span class=o>=</span>~/.kube/config
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Switch to the K3s context (usually named &#39;default&#39; after install)</span>
</span></span><span class=line><span class=cl>kubectl config use-context default
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># (Optional) Make the original K3s config world-readable to prevent issues with other tools</span>
</span></span><span class=line><span class=cl>sudo chmod <span class=m>644</span> /etc/rancher/k3s/k3s.yaml</span></span></code></pre></div><p>After either fix, you should be able to run:</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>bash</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-4 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>sysadmin@otedge001:~$ kubectl version --client
</span></span><span class=line><span class=cl>Client Version: v1.32.3+k3s1
</span></span><span class=line><span class=cl>Kustomize Version: v5.5.0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sysadmin@otedge001:~$ kubectl get nodes
</span></span><span class=line><span class=cl>NAME        STATUS   ROLES                  AGE   VERSION
</span></span><span class=line><span class=cl>otedge001   Ready    control-plane,master   14m   v1.32.3+k3s1</span></span></code></pre></div><p>And see your K3s node(s) listed.</p><h3 class="text-xl font-bold text-primary-500 leading-tight mb-2" id=performance-tweaks><a href=#performance-tweaks class=header-mark aria-label="Header mark for 'Performance Tweaks'"></a>Performance Tweaks</h3><ol><li>Run the following command to increase theÂ user watch/instance limits.</li></ol><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>bash</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-5 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=nb>echo</span> fs.inotify.max_user_instances<span class=o>=</span><span class=m>8192</span> <span class=p>|</span> sudo tee -a /etc/sysctl.conf
</span></span><span class=line><span class=cl><span class=nb>echo</span> fs.inotify.max_user_watches<span class=o>=</span><span class=m>524288</span> <span class=p>|</span> sudo tee -a /etc/sysctl.conf
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sudo sysctl -p</span></span></code></pre></div><ol><li>For better performance, increase the file descriptor limit:</li></ol><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>bash</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-6 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=nb>echo</span> fs.file-max <span class=o>=</span> <span class=m>100000</span> <span class=p>|</span> sudo tee -a /etc/sysctl.conf
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sudo sysctl -p</span></span></code></pre></div><h2 class="relative text-3xl font-bold leading-tight text-secondary-500 mb-2 mt-12 -ml-px"><div id=arc-enable-k3s class="absolute -top-28"></div>Arc Enable K3s</h2><p>Since your server is <strong>Arc-enabled</strong> and youâ€™ve got <strong>K3s running</strong>, the next step is to get the <strong>Azure CLI (</strong><code>**az**</code><strong>)</strong> installed so you can register the Kubernetes cluster with <strong>Azure Arc</strong></p><h3 class="text-xl font-bold text-primary-500 leading-tight mb-2" id=install-az-cli><a href=#install-az-cli class=header-mark aria-label="Header mark for 'Install az CLI'"></a>Install az CLI</h3><p>Update your packages and install prerequisites</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>bash</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-7 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>sudo apt update
</span></span><span class=line><span class=cl>sudo apt install ca-certificates curl apt-transport-https lsb-release gnupg -y
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#Add the Microsoft signing key</span>
</span></span><span class=line><span class=cl>curl -sL https://packages.microsoft.com/keys/microsoft.asc <span class=p>|</span> sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/microsoft.gpg
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Add rhw Azure CLI software Repo</span>
</span></span><span class=line><span class=cl><span class=nv>AZ_REPO</span><span class=o>=</span><span class=k>$(</span>lsb_release -cs<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;deb [arch=amd64] https://packages.microsoft.com/repos/azure-cli/ </span><span class=nv>$AZ_REPO</span><span class=s2> main&#34;</span> <span class=p>|</span> sudo tee /etc/apt/sources.list.d/azure-cli.list</span></span></code></pre></div><p>Now, we just need to update the package index and then we can install Azure CLI:</p><div class="code-block highlight is-closed show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>bash</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-8 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>sudo apt update
</span></span><span class=line><span class=cl>sudo apt install azure-cli -y
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Test this all worked</span>
</span></span><span class=line><span class=cl>az version
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;azure-cli&#34;</span>: <span class=s2>&#34;2.71.0&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;azure-cli-core&#34;</span>: <span class=s2>&#34;2.71.0&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;azure-cli-telemetry&#34;</span>: <span class=s2>&#34;1.1.0&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;extensions&#34;</span>: <span class=o>{}</span>
</span></span><span class=line><span class=cl><span class=o>}</span></span></span></code></pre></div><h3 class="text-xl font-bold text-primary-500 leading-tight mb-2" id=connect-k3s-cluster-to-azure-arc><a href=#connect-k3s-cluster-to-azure-arc class=header-mark aria-label="Header mark for 'Connect K3s cluster to Azure Arc'"></a>Connect K3s cluster to Azure Arc</h3><p>Log in to Azure</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>bash</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-9 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>az login
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code DFVLJBMXT to authenticate.</span></span></code></pre></div><p>Register resource providers</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>bash</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-10 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>az provider register --namespace <span class=s1>&#39;Microsoft.Kubernetes&#39;</span>
</span></span><span class=line><span class=cl>az provider register --namespace <span class=s1>&#39;Microsoft.KubernetesConfiguration&#39;</span>
</span></span><span class=line><span class=cl>az provider register --namespace <span class=s2>&#34;Microsoft.ExtendedLocation&#34;</span>
</span></span><span class=line><span class=cl>az provider register --namespace <span class=s2>&#34;Microsoft.SecretSyncController&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Install Azure Arc CLI extension</span>
</span></span><span class=line><span class=cl>az extension add --name connectedk8s
</span></span><span class=line><span class=cl>az extension add --name k8s-extension
</span></span><span class=line><span class=cl>az extension add --name customlocation</span></span></code></pre></div><p>Connect your K3s cluster to Azure Arc, we will use the following. To prevent unplanned updates to Azure Arc and the system Arc extensions that Azure IoT Operations uses as dependencies, this command disables auto upgrade. Instead,Â <a href=https://learn.microsoft.com/en-us/azure/azure-arc/kubernetes/agent-upgrade#manually-upgrade-agents target=_blank rel="noopener noreferrer">manually upgrade agents</a>Â as needed.</p><blockquote class=blockquote style=text-align:right><p>ðŸ“¢ If your environment uses a proxy server or Azure Arc Gateway, modify theÂ az connectedk8s connectÂ command with your proxy information:</p></blockquote><ol><li>Follow the instructions in eitherÂ Connect using an outbound proxy serverorÂ Onboard Kubernetes clusters to Azure Arc with Azure Arc Gateway.</li><li>AddÂ 169.254.169.254Â to theÂ -proxy-skip-rangeÂ parameter of theÂ az connectedk8s connectÂ command.Â Azure Device RegistryÂ uses this local endpoint to get access tokens for authorization.
Azure IoT Operations doesn&rsquo;t support proxy servers that require a trusted certificate.</li></ol><div class="code-block highlight is-closed show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>bash</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-11 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=c1># Create a new resource group for each cluster</span>
</span></span><span class=line><span class=cl><span class=c1># This will be North Europe, with a resoruce group called iot-edge01</span>
</span></span><span class=line><span class=cl>az group create --location NorthEurope --resource-group iot-edge01  --subscription df56d048-2e20-4ab6-82b7-11643163aa53
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Connect K8s</span>
</span></span><span class=line><span class=cl><span class=c1># Naming the cluster as you like, example is to use the machine name</span>
</span></span><span class=line><span class=cl>az connectedk8s connect --name otedge001 --location NorthEurope --resource-group iot-edge01  --subscription df56d048-2e20-4ab6-82b7-11643163aa53 --enable-oidc-issuer --enable-workload-identity --disable-auto-upgrade
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Argument <span class=s1>&#39;--enable-oidc-issuer&#39;</span> is in preview and under development. Reference and support levels: https://aka.ms/CLI_refstatus
</span></span><span class=line><span class=cl>Argument <span class=s1>&#39;--enable-workload-identity&#39;</span> is in preview and under development. Reference and support levels: https://aka.ms/CLI_refstatus
</span></span><span class=line><span class=cl>This operation might take a <span class=k>while</span>...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Step: 2025-04-24T13-25-44Z: Validating custom access token
</span></span><span class=line><span class=cl>Step: 2025-04-24T13-25-44Z: Checking Provider Registrations
</span></span><span class=line><span class=cl>Step: 2025-04-24T13-25-44Z: Setting KubeConfig
</span></span><span class=line><span class=cl>Step: 2025-04-24T13-25-44Z: Escape Proxy Settings, <span class=k>if</span> passed in
</span></span><span class=line><span class=cl>Step: 2025-04-24T13-25-44Z: Checking Connectivity to Cluster
</span></span><span class=line><span class=cl>Step: 2025-04-24T13-25-44Z: Do node validations
</span></span><span class=line><span class=cl>Step: 2025-04-24T13-25-44Z: Install Kubectl client <span class=k>if</span> it does not exist
</span></span><span class=line><span class=cl>Downloading kubectl client <span class=k>for</span> first time. This can take few minutes...
</span></span><span class=line><span class=cl>To check existing issues, please visit: https://github.com/Azure/azure-cli/issues
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Step: 2025-04-24T13-25-57Z: Install Helm client <span class=k>if</span> it does not exist
</span></span><span class=line><span class=cl>Downloading helm client <span class=k>for</span> first time. This can take few minutes...
</span></span><span class=line><span class=cl>Step: 2025-04-24T13-25-59Z: Starting Pre-onboarding-check
</span></span><span class=line><span class=cl>Step: 2025-04-24T13-25-59Z: Creating folder <span class=k>for</span> Cluster Diagnostic Checks Logs
</span></span><span class=line><span class=cl>Step: 2025-04-24T13-25-59Z: Get namespace of release: cluster-diagnostic-checks
</span></span><span class=line><span class=cl>Step: 2025-04-24T13-26-00Z: Determine Helmchart Export Path
</span></span><span class=line><span class=cl>Step: 2025-04-24T13-26-00Z: Pulling HelmChart: mcr.microsoft.com/azurearck8s/helmchart/stable/clusterdiagnosticchecks, Version: 0.2.2
</span></span><span class=line><span class=cl>Step: 2025-04-24T13-26-00Z: Chart path <span class=k>for</span> Cluster Diagnostic Checks Job: /home/sysadmin/.azure/PreOnboardingChecksCharts/clusterdiagnosticchecks
</span></span><span class=line><span class=cl>Step: 2025-04-24T13-26-00Z: Creating Cluster Diagnostic Checks job
</span></span><span class=line><span class=cl>Step: 2025-04-24T13-26-18Z: The required pre-checks <span class=k>for</span> onboarding have succeeded.
</span></span><span class=line><span class=cl>Step: 2025-04-24T13-26-18Z: Checking <span class=k>if</span> user can create ClusterRoleBindings
</span></span><span class=line><span class=cl>Step: 2025-04-24T13-26-18Z: Determining Cluster Distribution and Infrastructure
</span></span><span class=line><span class=cl>Step: 2025-04-24T13-26-18Z: Checking Connect RP is available in the Location passed in.
</span></span><span class=line><span class=cl>Step: 2025-04-24T13-26-18Z: Check <span class=k>if</span> an earlier azure-arc release exists
</span></span><span class=line><span class=cl>Step: 2025-04-24T13-26-18Z: Get namespace of release: azure-arc
</span></span><span class=line><span class=cl>Step: 2025-04-24T13-26-18Z: Deleting Arc CRDs
</span></span><span class=line><span class=cl>Step: 2025-04-24T13-26-23Z: Check <span class=k>if</span> ResourceGroup exists.  Try to create <span class=k>if</span> it doesn<span class=err>&#39;</span>t
</span></span><span class=line><span class=cl>Step: 2025-04-24T13-26-23Z: Generating Public-Private Key pair
</span></span><span class=line><span class=cl>Step: 2025-04-24T13-26-33Z: Generating ARM Request Payload
</span></span><span class=line><span class=cl>Step: 2025-04-24T13-26-33Z: Azure resource provisioning has begun.
</span></span><span class=line><span class=cl>Step: 2025-04-24T13-28-05Z: Azure resource provisioning has finished.
</span></span><span class=line><span class=cl>Step: 2025-04-24T13-28-05Z: Checking Custom Location<span class=o>(</span>Microsoft.ExtendedLocation<span class=o>)</span> RP Registration state <span class=k>for</span> this Subscription, and attempt to get the Custom Location Object ID <span class=o>(</span>OID<span class=o>)</span>,if registered
</span></span><span class=line><span class=cl>Step: 2025-04-24T13-28-06Z: Determine Helmchart Export Path
</span></span><span class=line><span class=cl>Step: 2025-04-24T13-28-06Z: Pulling HelmChart: mcr.microsoft.com/azurearck8s/batch2/stable/v2/azure-arc-k8sagents, Version: 1.24.4
</span></span><span class=line><span class=cl>Step: 2025-04-24T13-28-07Z: Starting to install Azure arc agents on the Kubernetes cluster.
</span></span><span class=line><span class=cl>Step: 2025-04-24T13-50-47Z: Wait <span class=k>for</span> Agent State to reach terminal state, with timeout of <span class=m>15</span>
</span></span><span class=line><span class=cl>Step: 2025-04-24T13-52-59Z: Agent state has reached terminal state.
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;aadProfile&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;adminGroupObjectIDs&#34;</span>: null,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;enableAzureRbac&#34;</span>: null,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;tenantId&#34;</span>: null
</span></span><span class=line><span class=cl><span class=o>}</span>,
</span></span><span class=line><span class=cl><span class=s2>&#34;agentPublicKeyCertificate&#34;</span>: <span class=s2>&#34;MIICCgKCAgEAy+XlOGoDAMtAN/ush1ssMALY6CbdAUy5hDiJMoCXexNu8yfO0hnLIJgBhX+Z0aWyBe7Hlzpt/kT9RArpq0VQ8MYbkIUF9GlQpqaAXeV8Ffh/9pFEAUKjHJWuE6rvoWxfTXPod4iXk83qthW49Y3m42L5dW3YzzHH3FHDzlE9AWi3IvH6pakgkqIqnoKfJkPsUf0WCghqsKVPKM7nC+2vTSryzHZJOLD0/3sicncg4A6vCkFpCwyrmKZdpqAoTmej/Ghmky4ihuq5Y+JlNnK2jgZIxjs3bnS9zgQEApJpz7hkLkHyYZqkFrlKT9UD9Xg7+T5uvcWcUo66e/1XY73H/Whz8QHDTNqO8oNbTXMh5WnRTa5MrsPEAVkWFtwAX6Cvujz/uqJ3fYc4t8recC96GuvuWiwrgfUlP4UfiovFTYkqVjVYKPqO9DjUAlxoPXa5DjFPWzcbCO25o8Z61mSBNq3+Wmh1PjGatwMLiwXxUssOwN2gX3+dG3mwNXU2bPOIhYJhvWtZL7OWgwFPmuyw4BNAURuMlWAUBsp6oi7X3KBUCA/DNl1tEmOKzm7pnIWZ6pJnQ75XrH/VadU4H47USoa2MeCyOGsA+Y3Bcxpoyfcp4hMX3gXeEL+1B+X0MqzWiew8iB0ifdHy4+5jBGNl7hLDNE/zM5BzCOdlR8MmAxsCAwEAAQ==&#34;</span>,
</span></span><span class=line><span class=cl><span class=s2>&#34;agentVersion&#34;</span>: <span class=s2>&#34;1.24.4&#34;</span>,
</span></span><span class=line><span class=cl><span class=s2>&#34;arcAgentProfile&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;agentAutoUpgrade&#34;</span>: <span class=s2>&#34;Disabled&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;agentErrors&#34;</span>: <span class=o>[]</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;agentState&#34;</span>: <span class=s2>&#34;Succeeded&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;desiredAgentVersion&#34;</span>: null,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;systemComponents&#34;</span>: null
</span></span><span class=line><span class=cl><span class=o>}</span>,
</span></span><span class=line><span class=cl><span class=s2>&#34;arcAgentryConfigurations&#34;</span>: null,
</span></span><span class=line><span class=cl><span class=s2>&#34;azureHybridBenefit&#34;</span>: <span class=s2>&#34;NotApplicable&#34;</span>,
</span></span><span class=line><span class=cl><span class=s2>&#34;connectivityStatus&#34;</span>: <span class=s2>&#34;Connected&#34;</span>,
</span></span><span class=line><span class=cl><span class=s2>&#34;distribution&#34;</span>: <span class=s2>&#34;k3s&#34;</span>,
</span></span><span class=line><span class=cl><span class=s2>&#34;distributionVersion&#34;</span>: null,
</span></span><span class=line><span class=cl><span class=s2>&#34;gateway&#34;</span>: null,
</span></span><span class=line><span class=cl><span class=s2>&#34;id&#34;</span>: <span class=s2>&#34;/subscriptions/df56d048-2e20-4ab6-82b7-11643163aa53/resourceGroups/iot-edge01/providers/Microsoft.Kubernetes/connectedClusters/otedge001&#34;</span>,
</span></span><span class=line><span class=cl><span class=s2>&#34;identity&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;principalId&#34;</span>: <span class=s2>&#34;bcba8744-7ed9-4e0a-8909-c10d0db2d354&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;tenantId&#34;</span>: <span class=s2>&#34;d993d9e4-644e-4d0a-ba80-0e010d0ea023&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;type&#34;</span>: <span class=s2>&#34;SystemAssigned&#34;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>,
</span></span><span class=line><span class=cl><span class=s2>&#34;infrastructure&#34;</span>: <span class=s2>&#34;K3s&#34;</span>,
</span></span><span class=line><span class=cl><span class=s2>&#34;kind&#34;</span>: null,
</span></span><span class=line><span class=cl><span class=s2>&#34;kubernetesVersion&#34;</span>: <span class=s2>&#34;1.32.3+k3s1&#34;</span>,
</span></span><span class=line><span class=cl><span class=s2>&#34;lastConnectivityTime&#34;</span>: <span class=s2>&#34;2025-04-24T13:50:50.589000+00:00&#34;</span>,
</span></span><span class=line><span class=cl><span class=s2>&#34;location&#34;</span>: <span class=s2>&#34;NorthEurope&#34;</span>,
</span></span><span class=line><span class=cl><span class=s2>&#34;managedIdentityCertificateExpirationTime&#34;</span>: null,
</span></span><span class=line><span class=cl><span class=s2>&#34;miscellaneousProperties&#34;</span>: null,
</span></span><span class=line><span class=cl><span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;otedge001&#34;</span>,
</span></span><span class=line><span class=cl><span class=s2>&#34;offering&#34;</span>: null,
</span></span><span class=line><span class=cl><span class=s2>&#34;oidcIssuerProfile&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;enabled&#34;</span>: true,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;issuerUrl&#34;</span>: <span class=s2>&#34;https://europe.oic.prod-arc.azure.com/d993d9e4-644e-4d0a-ba80-0e010d0ea023/b1ba6b46-f5cf-49cb-b278-1af11d320898/&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;selfHostedIssuerUrl&#34;</span>: null
</span></span><span class=line><span class=cl><span class=o>}</span>,
</span></span><span class=line><span class=cl><span class=s2>&#34;privateLinkScopeResourceId&#34;</span>: null,
</span></span><span class=line><span class=cl><span class=s2>&#34;privateLinkState&#34;</span>: <span class=s2>&#34;Disabled&#34;</span>,
</span></span><span class=line><span class=cl><span class=s2>&#34;provisioningState&#34;</span>: <span class=s2>&#34;Succeeded&#34;</span>,
</span></span><span class=line><span class=cl><span class=s2>&#34;resourceGroup&#34;</span>: <span class=s2>&#34;iot-edge01&#34;</span>,
</span></span><span class=line><span class=cl><span class=s2>&#34;securityProfile&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;workloadIdentity&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;enabled&#34;</span>: <span class=nb>true</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>,
</span></span><span class=line><span class=cl><span class=s2>&#34;systemData&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;createdAt&#34;</span>: <span class=s2>&#34;2025-04-24T13:48:30.074643+00:00&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;createdBy&#34;</span>: <span class=s2>&#34;Technology@damianflynn.com&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;createdByType&#34;</span>: <span class=s2>&#34;User&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;lastModifiedAt&#34;</span>: <span class=s2>&#34;2025-04-24T13:52:57.017210+00:00&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;lastModifiedBy&#34;</span>: <span class=s2>&#34;64b12d6e-6549-484c-8cc6-6281839ba394&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;lastModifiedByType&#34;</span>: <span class=s2>&#34;Application&#34;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>,
</span></span><span class=line><span class=cl><span class=s2>&#34;tags&#34;</span>: <span class=o>{}</span>,
</span></span><span class=line><span class=cl><span class=s2>&#34;totalCoreCount&#34;</span>: 4,
</span></span><span class=line><span class=cl><span class=s2>&#34;totalNodeCount&#34;</span>: 1,
</span></span><span class=line><span class=cl><span class=s2>&#34;type&#34;</span>: <span class=s2>&#34;microsoft.kubernetes/connectedclusters&#34;</span>
</span></span><span class=line><span class=cl><span class=o>}</span></span></span></code></pre></div><p>Upon completion, you will have your Kubernetes cluster connected as a new Azure Arc-enabled Kubernetes resource inside your resource group.</p><p>Check the started POD&rsquo;s in the &ldquo;azure-arc&rdquo; namespace</p><div class="code-block highlight is-closed show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>bash</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-12 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>kubectl get pods -o wide -n azure-arc
</span></span><span class=line><span class=cl>NAME                                          READY   STATUS    RESTARTS      AGE   IP           NODE        NOMINATED NODE   READINESS GATES
</span></span><span class=line><span class=cl>cluster-metadata-operator-b76b5b684-x2gfg     2/2     Running   <span class=m>0</span>             9h    10.42.0.26   otedge001   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>clusterconnect-agent-56498f5fc9-g9tkm         3/3     Running   <span class=m>0</span>             9h    10.42.0.31   otedge001   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>clusteridentityoperator-747fc6c5c-9mjcq       2/2     Running   <span class=m>4</span> <span class=o>(</span>87s ago<span class=o>)</span>   9h    10.42.0.35   otedge001   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>config-agent-f94fbb799-jst99                  2/2     Running   <span class=m>0</span>             9h    10.42.0.29   otedge001   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>controller-manager-5cff79bbcf-2jv4t           2/2     Running   <span class=m>0</span>             9h    10.42.0.30   otedge001   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>extension-events-collector-7574559c9f-sdz55   2/2     Running   <span class=m>0</span>             9h    10.42.0.34   otedge001   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>extension-manager-c56d45d8c-ngbhf             3/3     Running   <span class=m>0</span>             9h    10.42.0.32   otedge001   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>flux-logs-agent-74f5446b47-gr2k2              1/1     Running   <span class=m>0</span>             9h    10.42.0.36   otedge001   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>kube-aad-proxy-9cd74fbb5-s5j5f                2/2     Running   <span class=m>0</span>             9h    10.42.0.37   otedge001   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>logcollector-5f6d749774-tw2j9                 1/1     Running   <span class=m>0</span>             9h    10.42.0.28   otedge001   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>metrics-agent-85f4bf4b4d-lvs75                2/2     Running   <span class=m>0</span>             9h    10.42.0.33   otedge001   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>resource-sync-agent-7689dd6fbc-qxwt8          2/2     Running   <span class=m>0</span>             9h    10.42.0.27   otedge001   &lt;none&gt;           &lt;none&gt;</span></span></code></pre></div><h3 class="text-xl font-bold text-primary-500 leading-tight mb-2" id=enable-custom-locations-on-the-cluster><a href=#enable-custom-locations-on-the-cluster class=header-mark aria-label="Header mark for 'Enable Custom Locations on the Cluster'"></a>Enable Custom Locations on the Cluster</h3><p>Get the Clusters Issuer URL, as we need to add this to the kube-apiserver</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>bash</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-13 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=c1># Grab the Issuer URL</span>
</span></span><span class=line><span class=cl>az connectedk8s show --resource-group iot-edge01 --name otedge001 --query oidcIssuerProfile.issuerUrl --output tsv
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>https://europe.oic.prod-arc.azure.com/d993d9e4-644e-4d0a-ba80-0e010d0ea023/b1ba6b46-f5cf-49cb-b278-1af11d320898/</span></span></code></pre></div><p>Add the following content to a new configuration file atÂ <code>etc/rancher/k3s/config.yaml</code>Â file, replacing theÂ <code>&lt;SERVICE_ACCOUNT_ISSUER></code>Â placeholder with your cluster&rsquo;s issuer URL, that we just retrieved using the command <code>sudo vi /etc/rancher/k3s/config.yaml</code> and add the content</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>plain</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-14 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>kube-apiserver-arg:
</span></span><span class=line><span class=cl> - service-account-issuer=&lt;SERVICE_ACCOUNT_ISSUER&gt;
</span></span><span class=line><span class=cl> - service-account-max-token-expiration=24h</span></span></code></pre></div><p>Now, prepare for enabling the Azure Arc service, custom location, on your Arc cluster by getting the custom location object ID and saving it as the environment variable, OBJECT_ID. You must be logged into Azure CLI with a Microsoft Entra user account to successfully run the command, not a service principal. Run the following commandÂ <strong>exactly as written</strong>, without changing the GUID value.</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>bash</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-15 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=nb>export</span> <span class=nv>OBJECT_ID</span><span class=o>=</span><span class=k>$(</span>az ad sp show --id bc313c14-388c-4e7d-a58e-70017303ee3b --query id -o tsv<span class=k>)</span></span></span></code></pre></div><p>Use theÂ <a href=https://learn.microsoft.com/en-us/cli/azure/connectedk8s#az-connectedk8s-enable-features target=_blank rel="noopener noreferrer"><code>az connectedk8s enable-features</code></a>Â command to enable the custom location feature on your Arc cluster. This command uses the OBJECT_ID environment variable saved from the previous step to set the value for the custom-locations-oid parameter.</p><div class="code-block highlight is-closed show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>bash</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-16 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>sysadmin@otedge001:~$ az connectedk8s enable-features --resource-group iot-edge01 --name otedge001 --custom-locations-oid <span class=nv>$OBJECT_ID</span> --features cluster-connect custom-locations
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>This <span class=nb>command</span> is in preview and under development. Reference and support levels: https://aka.ms/CLI_refstatus
</span></span><span class=line><span class=cl>This operation might take a <span class=k>while</span>...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Step: 2025-04-24T23-22-56Z: Validating custom access token
</span></span><span class=line><span class=cl>Step: 2025-04-24T23-22-56Z: Checking Custom Location<span class=o>(</span>Microsoft.ExtendedLocation<span class=o>)</span> RP Registration state <span class=k>for</span> this Subscription, and attempt to get the Custom Location Object ID <span class=o>(</span>OID<span class=o>)</span>,if registered
</span></span><span class=line><span class=cl>Step: 2025-04-24T23-22-57Z: Setting KubeConfig
</span></span><span class=line><span class=cl>Step: 2025-04-24T23-22-57Z: Checking Connectivity to Cluster
</span></span><span class=line><span class=cl>Step: 2025-04-24T23-22-57Z: Install Helm client <span class=k>if</span> it does not exist
</span></span><span class=line><span class=cl>Step: 2025-04-24T23-22-57Z: Get namespace of release: azure-arc
</span></span><span class=line><span class=cl>Step: 2025-04-24T23-22-57Z: Getting HelmPackagePath from Arc DataPlane
</span></span><span class=line><span class=cl>Step: 2025-04-24T23-22-58Z: Determine Helmchart Export Path
</span></span><span class=line><span class=cl>Step: 2025-04-24T23-22-58Z: Pulling HelmChart: mcr.microsoft.com/azurearck8s/batch2/stable/v2/azure-arc-k8sagents, Version: 1.24.4
</span></span><span class=line><span class=cl>Important! Custom Location feature enablement can<span class=s1>&#39;t be validated when using a manually provided OID. If the custom location feature is not enabled, you may encounter an error when creating the custom location.
</span></span></span><span class=line><span class=cl><span class=s1>After creating the custom location, run `az customlocation show` and check that ProvisioningState is Succeeded. If ProvisoningState is Failed, then re-try this command with a  valid custom location OID to enable the feature.
</span></span></span><span class=line><span class=cl><span class=s1>For guidance, refer to: https://aka.ms/enable-customlocation
</span></span></span><span class=line><span class=cl><span class=s1>&#34;Successsfully enabled features: [&#39;</span>cluster-connect<span class=s1>&#39;, &#39;</span>custom-locations<span class=err>&#39;</span><span class=o>]</span> <span class=k>for</span> the Connected Cluster otedge001<span class=s2>&#34;</span></span></span></code></pre></div><p>Now, we can restart the k3s Cluster</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>bash</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-17 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>systemctl restart k3s</span></span></code></pre></div><h3 class="text-xl font-bold text-primary-500 leading-tight mb-2" id=check-the-azure-ui><a href=#check-the-azure-ui class=header-mark aria-label="Header mark for 'Check the Azure UI'"></a>Check the Azure UI</h3><p>Fantastic, We now should have be base K3s environment connected to Azure, Launch the Portal, to get information on our Arc managed cluster. Here we should be presented with details related to the version and state of our instance.</p><p><img src=/posts/iot-azure-arc-connected-k3s/img-1dfeb56e-image.png alt=Image></p><h2 class="relative text-3xl font-bold leading-tight text-secondary-500 mb-2 mt-12 -ml-px"><div id=managing-the-cluster class="absolute -top-28"></div>Managing the Cluster</h2><p>To also get information about the namespaces and the running workloads in Azure and more, a bearer token is needed.</p><h3 class="text-xl font-bold text-primary-500 leading-tight mb-2" id=create-service-account-and-retrieve-token><a href=#create-service-account-and-retrieve-token class=header-mark aria-label="Header mark for 'Create Service Account and Retrieve Token'"></a>Create Service Account and Retrieve Token</h3><p>Therefore we need to create a service account token in our Kubernetes cluster and generate the token for it.</p><p>With theÂ <code>kubeconfig</code>Â file pointing to theÂ <code>apiserver</code>Â of your Kubernetes cluster, run this command to create a service account. This example creates the service account in the default namespace, but you can substitute any other namespace forÂ <code>default</code>.</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>bash</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-18 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>kubectl create serviceaccount arc-user -n default</span></span></code></pre></div><p>Create a ClusterRoleBinding toÂ <a href=https://kubernetes.io/docs/reference/access-authn-authz/rbac/#kubectl-create-rolebinding target=_blank rel="noopener noreferrer">grant this service account the appropriate permissions on the cluster</a>. If you used a different namespace in the first command, substitute it here forÂ <code>default</code>.</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>bash</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-19 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>kubectl create clusterrolebinding arc-user-binding --clusterrole cluster-admin --serviceaccount default:arc-user</span></span></code></pre></div><p>Create a service account token:</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>bash</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-20 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>kubectl apply -f - <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Secret
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: arc-user-secret
</span></span></span><span class=line><span class=cl><span class=s>  annotations:
</span></span></span><span class=line><span class=cl><span class=s>    kubernetes.io/service-account.name: arc-user
</span></span></span><span class=line><span class=cl><span class=s>type: kubernetes.io/service-account-token
</span></span></span><span class=line><span class=cl><span class=s>EOF</span></span></span></code></pre></div><p>Now, lets get the token we need to use in the Azure Portal</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>bash</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-21 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=nv>TOKEN</span><span class=o>=</span><span class=k>$(</span>kubectl get secret arc-user-secret -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{$.data.token}&#39;</span> <span class=p>|</span> base64 -d <span class=p>|</span> sed <span class=s1>&#39;s/$/\n/g&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=nv>$TOKEN</span></span></span></code></pre></div><h3 class="text-xl font-bold text-primary-500 leading-tight mb-2" id=add-token-to-the-azure-portal><a href=#add-token-to-the-azure-portal class=header-mark aria-label="Header mark for 'Add Token to the Azure Portal'"></a>Add Token to the Azure Portal</h3><p>Open the **Kubernettes Resources **pane, and navigate to the **Namespaces **area</p><p><img src=/posts/iot-azure-arc-connected-k3s/img-1dfeb56e-image.png alt=Image></p><p>Paste the token we just created, and click the button <strong>Sign In</strong>. After a moment the UX will update, and we should see all the namespaces on our new cluster</p><p><img src=/posts/iot-azure-arc-connected-k3s/img-1dfeb56e-image.png alt=Image></p><h2 class="relative text-3xl font-bold leading-tight text-secondary-500 mb-2 mt-12 -ml-px"><div id=testing-a-deployment class="absolute -top-28"></div>Testing a Deployment</h2><p>Lets activate the quickstart demo application from Azure (azure-vote) to test the deployment via Azure and to see a running workload by using the Azure UI.</p><p>Navigate to Workloads \ Add with YAML \ Deploy a quickstart applicationâ€¦ and follow the steps.</p><p><img src=/posts/iot-azure-arc-connected-k3s/img-1dfeb56e-image-10.png alt=Image></p><p>The link to the application will be posted directly after the deployment. Just wait some seconds for the service to be ready.</p><p><img src=/posts/iot-azure-arc-connected-k3s/img-1dfeb56e-image-7.png alt=Image></p><p>You can now check the running PODâ€™s in your Kubernetes environment for the azure-vote demo application.</p><ul><li>kubectl get pods -o wide -n azure-vote
<img src=/posts/iot-azure-arc-connected-k3s/img-1dfeb56e-image-9.png alt=Image></li></ul><h2 class="relative text-3xl font-bold leading-tight text-secondary-500 mb-2 mt-12 -ml-px"><div id=access-the-k3s-from-a-developer-computer-with-azure-arc class="absolute -top-28"></div>Access the k3s from a Developer Computer with Azure Arc</h2><p>Using the Azure Portal to access the Kubernetes cluster is nice but as a developer, I am used to using <code>kubectl</code> or any custom dashboards. To access the Kubernetes cluster from my Windows computer, I will use the following Azure CLI command, remember to replace <em><token></em>with the previously created token.</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>bash</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-22 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>PS C:<span class=se>\U</span>sers<span class=se>\s</span>ysadmin&gt; az connectedk8s proxy --resource-group iot-edge01 --name otedge001 --token eyJhbGciOiJSUzI1NiIsImtpZCI6IkdQa2ZwTDhmSUxGcWtsRDhndV9zOTNGRE8tNmd5R3lZVE8zVUR4ZDZSRncifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6ImFyYy11c2VyLXNlY3JldCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJhcmMtdXNlciIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjY0MDU0N2JmLTk5MGYtNGNkNi05NzdlLTkyYWEzMDcxZjkzZCIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpkZWZhdWx0OmFyYy11c2VyIn0.TxDTXr1yqTRlIbCvQjYKTHd8FvxvriPPZcKyPYq6jaTu3TzsPa_p2YRRsjmVKjxDplBJGZkhlv-ysbPN3NEqEVna-vdH3aEPQ4hvtTl_xSeIy1P_SraKghINn3imYwJ_ndDRQnyeZq6Q8bW6bufoMSxQ7ptgwabHuDSog-n9eDr2E3Zv1BBGU0A5Of_72lGxvzm2SWoNTf7Sj4XUZvk_MgVE-o99n6QxI5tNkTr6E3mw4OJqTSjhMD4Nzi5yR2JvU_OlqJvR5HgTY4y8lZfoop_hB3QKzw_hzB4xqrGJ8AptrQnXKcHoUJIPmdTtJauBztNjW0x9D9zdXIkuu4QDSQ
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Proxy is listening on port <span class=m>47011</span>
</span></span><span class=line><span class=cl>Merged <span class=s2>&#34;otedge001&#34;</span> as current context in C:<span class=se>\U</span>sers<span class=se>\s</span>ysadmin<span class=se>\.</span>kube<span class=se>\c</span>onfig
</span></span><span class=line><span class=cl>Start sending kubectl requests on <span class=s1>&#39;otedge001&#39;</span> context using kubeconfig at C:<span class=se>\U</span>sers<span class=se>\s</span>ysadmin<span class=se>\.</span>kube<span class=se>\c</span>onfig
</span></span><span class=line><span class=cl>Press Ctrl+C to close proxy.</span></span></code></pre></div><p>You can use this command on any computer as long as the Azure CLI is installed and you have authenticated to your tenant with <code>az login</code>. The command downloads the Kubernetes config file, sets the context, and creates a proxy connection through Azure Arc to the Kubernetes cluster.</p><p><img src=/posts/iot-azure-arc-connected-k3s/img-1dfeb56e-image.png alt=Image></p><p>After the connection is established, open a new terminal window and use <code>kubectl</code> as you are used to. For example on a</p><p><img src=/posts/iot-azure-arc-connected-k3s/img-1dfeb56e-image.png alt=Image></p><p>It is also possible to use any dashboard to display the resources from the Kubernetes cluster. I like to use Octant from VMWare but you can use whatever dashboard you feel comfortable.</p><h2 class="relative text-3xl font-bold leading-tight text-secondary-500 mb-2 mt-12 -ml-px"><div id=monitoring class="absolute -top-28"></div>Monitoring</h2><p>Azure Arc allows you to project your on-premises Kubernetes cluster into Azure. Doing so enables you to manage the cluster from Azure with tools such as Azure Monitor or Cloud Defender.</p><blockquote class=blockquote style=text-align:right><p>ðŸ“¢ From your management system
We will focus on install the Container Insights Extension which enables you to monitor your pods and nodes from the on-premise cluster in Azure.</p></blockquote><div class="code-block highlight is-closed show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>bash</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-23 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>az account <span class=nb>set</span> -s &lt;SUBSCRIPTION_ID&gt;
</span></span><span class=line><span class=cl><span class=c1># Add Extenions to the CLI</span>
</span></span><span class=line><span class=cl>az extension add --name k8s-extension
</span></span><span class=line><span class=cl>az extension add --name amg
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Add Providers to the Subscription</span>
</span></span><span class=line><span class=cl>az provider register --namespace Microsoft.AlertsManagement
</span></span><span class=line><span class=cl>az provider register --namespace Microsoft.Monitor
</span></span><span class=line><span class=cl>az provider register --namespace Microsoft.Dashboard
</span></span><span class=line><span class=cl>az provider register --namespace Microsoft.Insights
</span></span><span class=line><span class=cl>az provider register --namespace Microsoft.OperationalInsights
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Create an Azure Monitor workspace to enable metric collection for your Azure Arc-enabled Kubernetes cluster.</span>
</span></span><span class=line><span class=cl><span class=c1># This workspace stores Prometheus data which we will be sending from our Cluster</span>
</span></span><span class=line><span class=cl><span class=c1># Note: Save the Azure Monitor workspace ID from the output of this command. </span>
</span></span><span class=line><span class=cl>az monitor account create --name otedge001-ws --resource-group iot-edge01 --location NorthEurope --query id -o tsv
</span></span><span class=line><span class=cl>/subscriptions/df56d048-2e20-4ab6-82b7-11643163aa53/resourcegroups/iot-edge01/providers/microsoft.monitor/accounts/otedge001-ws
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Create an Azure Managed Grafana instance to visualize your Prometheus metrics.</span>
</span></span><span class=line><span class=cl><span class=c1># Note: Save the Grafana ID from the output of this command. </span>
</span></span><span class=line><span class=cl>az grafana create --name otedge001-graf --resource-group iot-edge01 --location NorthEurope --query id -o tsv
</span></span><span class=line><span class=cl>/subscriptions/df56d048-2e20-4ab6-82b7-11643163aa53/resourceGroups/iot-edge01/providers/Microsoft.Dashboard/grafana/otedge001-graf
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Create a Log Analytics workspace for Container Insights.</span>
</span></span><span class=line><span class=cl><span class=c1># Note: Save the Log Analytics workspace ID from the output of this command.</span>
</span></span><span class=line><span class=cl>az monitor log-analytics workspace create --name otedge001-la --resource-group iot-edge01 --location NorthEurope --query id -o tsv
</span></span><span class=line><span class=cl>/subscriptions/df56d048-2e20-4ab6-82b7-11643163aa53/resourceGroups/iot-edge01/providers/Microsoft.OperationalInsights/workspaces/otedge001-la</span></span></code></pre></div><h3 class="text-xl font-bold text-primary-500 leading-tight mb-2" id=enable-metrics-collection-for-the-cluster><a href=#enable-metrics-collection-for-the-cluster class=header-mark aria-label="Header mark for 'Enable metrics collection for the cluster'"></a>Enable metrics collection for the cluster</h3><p>Update the Azure Arc cluster to collect metrics and send them to the previously created Azure Monitor workspace. You also link this workspace with the Grafana instance.</p><p>This Azure CLI command creates the namespace you defined with the <code>â€“name</code> parameter but it is empty at first glance. It creates an <em>Azure Monitor Agent Deployment</em> and <em>ReplicaSet</em> in the <code>kube-system</code> namespace though. The newly created namespace contains a <em>config map</em> and some <em>secrets</em> to ensure a safe communication with Azure</p><div class="code-block highlight is-closed show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>bash</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-24 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>damian@BYO-MBP-LY62L726TL ~ % az k8s-extension create --name azuremonitor-metrics --cluster-name otedge001 --resource-group iot-edge01 --cluster-type connectedClusters --extension-type Microsoft.AzureMonitor.Containers.Metrics --configuration-settings azure-monitor-workspace-resource-id<span class=o>=</span>/subscriptions/df56d048-2e20-4ab6-82b7-11643163aa53/resourcegroups/iot-edge01/providers/microsoft.monitor/accounts/otedge001-ws grafana-resource-id<span class=o>=</span>/subscriptions/df56d048-2e20-4ab6-82b7-11643163aa53/resourceGroups/iot-edge01/providers/Microsoft.Dashboard/grafana/otedge001-graf
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Preview version of extension is disabled by default <span class=k>for</span> extension installation, enabled <span class=k>for</span> modules without stable versions. 
</span></span><span class=line><span class=cl>Please run <span class=s1>&#39;az config set extension.dynamic_install_allow_preview=true or false&#39;</span> to config it specifically. 
</span></span><span class=line><span class=cl>The <span class=nb>command</span> requires the extension k8s-extension. Do you want to install it now? The <span class=nb>command</span> will <span class=k>continue</span> to run after the extension is installed. <span class=o>(</span>Y/n<span class=o>)</span>: y
</span></span><span class=line><span class=cl>Run <span class=s1>&#39;az config set extension.use_dynamic_install=yes_without_prompt&#39;</span> to allow installing extensions without prompt.
</span></span><span class=line><span class=cl>Using Azure Monitor Workspace <span class=o>(</span>stores prometheus metrics<span class=o>)</span> : /subscriptions/df56d048-2e20-4ab6-82b7-11643163aa53/resourcegroups/iot-edge01/providers/microsoft.monitor/accounts/otedge001-ws
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aksAssignedIdentity&#34;</span>: null,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;autoUpgradeMinorVersion&#34;</span>: true,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;configurationProtectedSettings&#34;</span>: <span class=o>{}</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;configurationSettings&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;azure-monitor-workspace-resource-id&#34;</span>: <span class=s2>&#34;/subscriptions/df56d048-2e20-4ab6-82b7-11643163aa53/resourcegroups/iot-edge01/providers/microsoft.monitor/accounts/otedge001-ws&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;grafana-resource-id&#34;</span>: <span class=s2>&#34;/subscriptions/df56d048-2e20-4ab6-82b7-11643163aa53/resourceGroups/iot-edge01/providers/Microsoft.Dashboard/grafana/otedge001-graf&#34;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;currentVersion&#34;</span>: <span class=s2>&#34;6.14.0-main-01-16-2025-8d52acfe&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;customLocationSettings&#34;</span>: null,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;errorInfo&#34;</span>: null,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;extensionType&#34;</span>: <span class=s2>&#34;microsoft.azuremonitor.containers.metrics&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;id&#34;</span>: <span class=s2>&#34;/subscriptions/df56d048-2e20-4ab6-82b7-11643163aa53/resourceGroups/iot-edge01/providers/Microsoft.Kubernetes/connectedClusters/otedge001/providers/Microsoft.KubernetesConfiguration/extensions/azuremonitor-metrics&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;identity&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;principalId&#34;</span>: <span class=s2>&#34;4bb5dfc8-114d-41dc-b082-89932db188ec&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;tenantId&#34;</span>: null,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;type&#34;</span>: <span class=s2>&#34;SystemAssigned&#34;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;isSystemExtension&#34;</span>: false,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;azuremonitor-metrics&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;packageUri&#34;</span>: null,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;plan&#34;</span>: null,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;provisioningState&#34;</span>: <span class=s2>&#34;Succeeded&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;releaseTrain&#34;</span>: <span class=s2>&#34;stable&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;resourceGroup&#34;</span>: <span class=s2>&#34;iot-edge01&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;scope&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;cluster&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;releaseNamespace&#34;</span>: <span class=s2>&#34;kube-system&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;namespace&#34;</span>: null
</span></span><span class=line><span class=cl>  <span class=o>}</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;statuses&#34;</span>: <span class=o>[]</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;systemData&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;createdAt&#34;</span>: <span class=s2>&#34;2025-04-25T21:36:49.667510+00:00&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;createdBy&#34;</span>: null,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;createdByType&#34;</span>: null,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;lastModifiedAt&#34;</span>: <span class=s2>&#34;2025-04-25T21:36:49.667510+00:00&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;lastModifiedBy&#34;</span>: null,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;lastModifiedByType&#34;</span>: null
</span></span><span class=line><span class=cl>  <span class=o>}</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;type&#34;</span>: <span class=s2>&#34;Microsoft.KubernetesConfiguration/extensions&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;version&#34;</span>: null
</span></span><span class=line><span class=cl><span class=o>}</span></span></span></code></pre></div><p>We should be able to see the new pods which were deployed with the following command</p><div class="code-block highlight is-closed show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>bash</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-25 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>sysadmin@otedge001:~$ kubectl get pods -n kube-system --sort-by<span class=o>=</span>.metadata.creationTimestamp <span class=p>|</span> tail -n +2 <span class=p>|</span> tac
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ama-metrics-855cdd5bdd-c44wx                          2/2     Running     <span class=m>1</span> <span class=o>(</span>12m ago<span class=o>)</span>   16m
</span></span><span class=line><span class=cl>azuremonitor-metrics-prometheus-node-exporter-c8xck   1/1     Running     <span class=m>0</span>             16m
</span></span><span class=line><span class=cl>ama-metrics-operator-targets-665546b7bf-xjs6n         2/2     Running     <span class=m>1</span> <span class=o>(</span>15m ago<span class=o>)</span>   16m
</span></span><span class=line><span class=cl>ama-metrics-node-b2l9z                                2/2     Running     <span class=m>1</span> <span class=o>(</span>12m ago<span class=o>)</span>   16m
</span></span><span class=line><span class=cl>ama-metrics-ksm-7fd5f48667-z8t5h                      1/1     Running     <span class=m>0</span>             16m
</span></span><span class=line><span class=cl>ama-metrics-855cdd5bdd-f6jz4                          2/2     Running     <span class=m>1</span> <span class=o>(</span>12m ago<span class=o>)</span>   16m
</span></span><span class=line><span class=cl>traefik-67bfb46dcb-zwpnf                              1/1     Running     <span class=m>0</span>             33h
</span></span><span class=line><span class=cl>svclb-traefik-3c89490b-l7wvr                          2/2     Running     <span class=m>0</span>             33h
</span></span><span class=line><span class=cl>metrics-server-6f4c6675d5-7rv4s                       1/1     Running     <span class=m>0</span>             33h
</span></span><span class=line><span class=cl>helm-install-traefik-fns8n                            0/1     Completed   <span class=m>1</span>             33h
</span></span><span class=line><span class=cl>helm-install-traefik-crd-fqnkw                        0/1     Completed   <span class=m>0</span>             33h
</span></span><span class=line><span class=cl>coredns-ff8999cc5-hlscp                               1/1     Running     <span class=m>0</span>             33h
</span></span><span class=line><span class=cl>local-path-provisioner-774c6665dc-mslh9               1/1     Running     <span class=m>0</span>             33h</span></span></code></pre></div><h3 class="text-xl font-bold text-primary-500 leading-tight mb-2" id=enable-container-insights-logs-for-logs-collection><a href=#enable-container-insights-logs-for-logs-collection class=header-mark aria-label="Header mark for 'Enable Container Insights logs for logs collection.'"></a>Enable Container Insights logs for logs collection.</h3><p>The Azure CLI command automatically connets the Log Analytics Workspace for the metrics and logs of the extensions.</p><div class="code-block highlight is-closed show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>bash</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-26 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>damian@BYO-MBP-LY62L726TL ~ % az k8s-extension create --name azuremonitor-containers --cluster-name otedge001 --resource-group iot-edge01 --cluster-type connectedClusters --extension-type Microsoft.AzureMonitor.Containers --configuration-settings <span class=nv>logAnalyticsWorkspaceResourceID</span><span class=o>=</span>/subscriptions/df56d048-2e20-4ab6-82b7-11643163aa53/resourceGroups/iot-edge01/providers/Microsoft.OperationalInsights/workspaces/otedge001-la
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Ignoring name, release-namespace and scope parameters since microsoft.azuremonitor.containers only supports cluster scope and single instance of this extension.
</span></span><span class=line><span class=cl>Defaulting to extension name <span class=s1>&#39;azuremonitor-containers&#39;</span> and release-namespace <span class=s1>&#39;azuremonitor-containers&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aksAssignedIdentity&#34;</span>: null,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;autoUpgradeMinorVersion&#34;</span>: true,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;configurationProtectedSettings&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;amalogs.secret.key&#34;</span>: <span class=s2>&#34;&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;amalogs.secret.wsid&#34;</span>: <span class=s2>&#34;&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;omsagent.secret.key&#34;</span>: <span class=s2>&#34;&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;omsagent.secret.wsid&#34;</span>: <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;configurationSettings&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;amalogs.useAADAuth&#34;</span>: <span class=s2>&#34;true&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;logAnalyticsWorkspaceResourceID&#34;</span>: <span class=s2>&#34;/subscriptions/df56d048-2e20-4ab6-82b7-11643163aa53/resourceGroups/iot-edge01/providers/Microsoft.OperationalInsights/workspaces/otedge001-la&#34;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;currentVersion&#34;</span>: <span class=s2>&#34;3.1.26&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;customLocationSettings&#34;</span>: null,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;errorInfo&#34;</span>: null,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;extensionType&#34;</span>: <span class=s2>&#34;microsoft.azuremonitor.containers&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;id&#34;</span>: <span class=s2>&#34;/subscriptions/df56d048-2e20-4ab6-82b7-11643163aa53/resourceGroups/iot-edge01/providers/Microsoft.Kubernetes/connectedClusters/otedge001/providers/Microsoft.KubernetesConfiguration/extensions/azuremonitor-containers&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;identity&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;principalId&#34;</span>: <span class=s2>&#34;7e574455-82a5-476d-99de-21fb32c73701&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;tenantId&#34;</span>: null,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;type&#34;</span>: <span class=s2>&#34;SystemAssigned&#34;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;isSystemExtension&#34;</span>: false,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;azuremonitor-containers&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;packageUri&#34;</span>: null,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;plan&#34;</span>: null,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;provisioningState&#34;</span>: <span class=s2>&#34;Succeeded&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;releaseTrain&#34;</span>: <span class=s2>&#34;Stable&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;resourceGroup&#34;</span>: <span class=s2>&#34;iot-edge01&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;scope&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;cluster&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;releaseNamespace&#34;</span>: <span class=s2>&#34;azuremonitor-containers&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;namespace&#34;</span>: null
</span></span><span class=line><span class=cl>  <span class=o>}</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;statuses&#34;</span>: <span class=o>[]</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;systemData&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;createdAt&#34;</span>: <span class=s2>&#34;2025-04-25T21:57:19.178480+00:00&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;createdBy&#34;</span>: null,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;createdByType&#34;</span>: null,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;lastModifiedAt&#34;</span>: <span class=s2>&#34;2025-04-25T21:57:19.178480+00:00&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;lastModifiedBy&#34;</span>: null,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;lastModifiedByType&#34;</span>: null
</span></span><span class=line><span class=cl>  <span class=o>}</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;type&#34;</span>: <span class=s2>&#34;Microsoft.KubernetesConfiguration/extensions&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;version&#34;</span>: null
</span></span><span class=line><span class=cl><span class=o>}</span></span></span></code></pre></div><p>Once these steps are completed, you have both Azure Monitor and Grafana set up and linked to your cluster for observability and metric collection.</p><p>More importantly, after you have installed the extension, it collects metric information and sends them to Azure.</p><p>We can see these new extensions in the portal by navigating <strong>Settings</strong>, and then **Extensions **</p><p><img src=/posts/iot-azure-arc-connected-k3s/img-1dfeb56e-image.png alt=Image></p><p>Or, we can use the AZ Cli to see these extensions.</p><div class="code-block highlight is-closed show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>bash</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-27 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=c1># Get a list of extensions that have been installed</span>
</span></span><span class=line><span class=cl>damian@BYO-MBP-LY62L726TL ~ % az k8s-extension show --name azuremonitor-containers --cluster-name otedge001 --resource-group iot-edge01 --cluster-type connectedClusters
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aksAssignedIdentity&#34;</span>: null,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;autoUpgradeMinorVersion&#34;</span>: true,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;configurationProtectedSettings&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;amalogs.secret.key&#34;</span>: <span class=s2>&#34;&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;amalogs.secret.wsid&#34;</span>: <span class=s2>&#34;&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;omsagent.secret.key&#34;</span>: <span class=s2>&#34;&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;omsagent.secret.wsid&#34;</span>: <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;configurationSettings&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;amalogs.useAADAuth&#34;</span>: <span class=s2>&#34;true&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;logAnalyticsWorkspaceResourceID&#34;</span>: <span class=s2>&#34;/subscriptions/df56d048-2e20-4ab6-82b7-11643163aa53/resourceGroups/iot-edge01/providers/Microsoft.OperationalInsights/workspaces/otedge001-la&#34;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;currentVersion&#34;</span>: <span class=s2>&#34;3.1.26&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;customLocationSettings&#34;</span>: null,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;errorInfo&#34;</span>: null,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;extensionType&#34;</span>: <span class=s2>&#34;microsoft.azuremonitor.containers&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;id&#34;</span>: <span class=s2>&#34;/subscriptions/df56d048-2e20-4ab6-82b7-11643163aa53/resourceGroups/iot-edge01/providers/Microsoft.Kubernetes/connectedClusters/otedge001/providers/Microsoft.KubernetesConfiguration/extensions/azuremonitor-containers&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;identity&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;principalId&#34;</span>: <span class=s2>&#34;7e574455-82a5-476d-99de-21fb32c73701&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;tenantId&#34;</span>: null,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;type&#34;</span>: <span class=s2>&#34;SystemAssigned&#34;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;isSystemExtension&#34;</span>: false,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;azuremonitor-containers&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;packageUri&#34;</span>: null,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;plan&#34;</span>: null,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;provisioningState&#34;</span>: <span class=s2>&#34;Succeeded&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;releaseTrain&#34;</span>: <span class=s2>&#34;Stable&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;resourceGroup&#34;</span>: <span class=s2>&#34;iot-edge01&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;scope&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;cluster&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;releaseNamespace&#34;</span>: <span class=s2>&#34;azuremonitor-containers&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;namespace&#34;</span>: null
</span></span><span class=line><span class=cl>  <span class=o>}</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;statuses&#34;</span>: <span class=o>[]</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;systemData&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;createdAt&#34;</span>: <span class=s2>&#34;2025-04-25T21:57:19.178480+00:00&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;createdBy&#34;</span>: null,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;createdByType&#34;</span>: null,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;lastModifiedAt&#34;</span>: <span class=s2>&#34;2025-04-25T21:57:19.178480+00:00&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;lastModifiedBy&#34;</span>: null,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;lastModifiedByType&#34;</span>: null
</span></span><span class=line><span class=cl>  <span class=o>}</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;type&#34;</span>: <span class=s2>&#34;Microsoft.KubernetesConfiguration/extensions&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;version&#34;</span>: null
</span></span><span class=line><span class=cl><span class=o>}</span></span></span></code></pre></div><h3 class="text-xl font-bold text-primary-500 leading-tight mb-2" id=create-dashboards-in-the-azure-portal><a href=#create-dashboards-in-the-azure-portal class=header-mark aria-label="Header mark for 'Create Dashboards in the Azure Portal'"></a>Create Dashboards in the Azure Portal</h3><p>Open the Azure Arc Kubernetes Cluster in the Azure Portal and navigate to the <strong>Monitoring</strong> â€”> <strong>Insights</strong> pane. There you can see various dashboards already presenting realtime data. You can change what you want to display and also switch the scope, for example, from the Cluster scope to the Container scope. Additionally, you can set various filters such as a time range.</p><p><img src=/posts/iot-azure-arc-connected-k3s/img-1dfeb56e-image.png alt=Image></p><p>For even more insight into your cluster or pods, open the Metrics pane in Azure Arc. There you can create charts and display useful information. The following screenshot shows a chart that displays the pod count and the used CPU percentage of all nodes.</p><p><img src=/posts/iot-azure-arc-connected-k3s/img-1dfeb56e-image.png alt=Image></p><p>Another neat feature of Azure Monitor is Alerting. Go to the Alerting pane and there you can create alerts based on custom rules. For example, you could send an email to an administrator if the CPU usage of the cluster is greater than 80% over 5 minutes.</p><blockquote class=blockquote style=text-align:right><p>ðŸ“¢ This post is part ofÂ â€œAzure Arc Series - Manage an on-premises Kubernetes Cluster with Azure Arcâ€.</p></blockquote><h3 class="text-xl font-bold text-primary-500 leading-tight mb-2" id=grafana-dashboard><a href=#grafana-dashboard class=header-mark aria-label="Header mark for 'Grafana Dashboard'"></a>Grafana Dashboard</h3><p>After enabling Azure Monitor metrics and logs collection, the next step is to view your Kubernetes monitoring dashboards through <strong>Azure Managed Grafana</strong>.</p><ol><li>In the Azure Portal, navigate to Resource Groups and open your resource group (e.g., iot-edge01).</li><li>Find and select your Grafana instance (e.g., otedge001-graf).</li><li>On the Grafana resource page, under the Overview section, look for the Public Endpoint URL.</li><li>Click on the link to open your Azure Managed Grafana dashboard in a new browser tab.</li></ol><h3 class="text-xl font-bold text-primary-500 leading-tight mb-2" id=browse-available-dashboards><a href=#browse-available-dashboards class=header-mark aria-label="Header mark for 'Browse Available Dashboards'"></a>Browse Available Dashboards</h3><p>Once inside Grafana, use the left-hand menu and click <strong>Dashboards âž” Browse</strong>.</p><p>You should see a wide range of <strong>Microsoft-managed</strong> dashboards available out of the box, including the ones in the screen shot</p><p><img src=/posts/iot-azure-arc-connected-k3s/img-1dfeb56e-image.png alt=Image></p><p>Now, we can view these dashboards and observe out cluster in realtime, for example this is a view of the dashboard called <strong>Kubernetes / Compute Resources / Cluster</strong></p><p><img src=/posts/iot-azure-arc-connected-k3s/img-1dfeb56e-image.png alt=Image></p><blockquote class=blockquote style=text-align:right></blockquote><h3 class="text-xl font-bold text-primary-500 leading-tight mb-2" id=no-data-displayed><a href=#no-data-displayed class=header-mark aria-label="Header mark for 'No Data Displayed?'"></a>No Data Displayed?</h3><p>If you open the <strong>Overview</strong> or any of the Kubernetes-related dashboards and <strong>no data appears</strong> â€” or you see <strong>errors</strong> â€” it typically means one of the following:</p><ul><li>Metrics from your K3s cluster have not started flowing into Azure Monitor yet (initial ingestion delay).</li><li>There might be missing permissions for the Grafana instance to read Azure Monitor workspace data.</li><li>The Prometheus scraping configuration or Azure Monitor Metrics extension isn&rsquo;t fully active yet.</li></ul><blockquote class=blockquote style=text-align:right><p>ðŸ“¢ Note: It can take 5â€“15 minutes after setting up metrics collection before data becomes visible inside Grafana dashboards. If the issue persists, troubleshooting steps may be required.</p></blockquote><h3 class="text-xl font-bold text-primary-500 leading-tight mb-2" id=verify-metrics-are-being-scraped><a href=#verify-metrics-are-being-scraped class=header-mark aria-label="Header mark for 'Verify Metrics Are Being Scraped'"></a>Verify Metrics Are Being Scraped</h3><p>Ensure the Azure Monitor Metrics pods are running correctly in the <code>kube-system</code> namespace.</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>bash</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-28 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>kubectl get pods -n kube-system <span class=p>|</span> grep ama-metrics
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ama-metrics-855cdd5bdd-c44wx                          2/2     Running     <span class=m>1</span> <span class=o>(</span>69m ago<span class=o>)</span>   72m
</span></span><span class=line><span class=cl>ama-metrics-855cdd5bdd-f6jz4                          2/2     Running     <span class=m>1</span> <span class=o>(</span>69m ago<span class=o>)</span>   72m
</span></span><span class=line><span class=cl>ama-metrics-ksm-7fd5f48667-z8t5h                      1/1     Running     <span class=m>0</span>             72m
</span></span><span class=line><span class=cl>ama-metrics-node-b2l9z                                2/2     Running     <span class=m>1</span> <span class=o>(</span>69m ago<span class=o>)</span>   72m
</span></span><span class=line><span class=cl>ama-metrics-operator-targets-665546b7bf-xjs6n         2/2     Running     <span class=m>1</span> <span class=o>(</span>72m ago<span class=o>)</span>   72m</span></span></code></pre></div><p>If pods are crashing (<code>CrashLoopBackOff</code>), check their logs</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>bash</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-29 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>kubectl logs &lt;pod-name&gt; -n kube-system</span></span></code></pre></div><h1 class="relative text-5xl font-semibold leading-tense text-secondary-500 mb-4 -ml-px"><a href=# class=header-mark aria-label="Header mark for ''"></a><div class="absolute -top-28"></div></h1><h2 class="relative text-3xl font-bold leading-snug text-secondary-500 mb-2 mt-12 -ml-px"><div id=all-links class=onpage-anchor></div>All links in a practical list</h2><div class="w-full my-6"><a href=https://get.k3s.io/%22 class="break-all flex font-bold hover:text-black underline items-center leading-snug text-primary-500" target=_blank><div class="flex-shrink-0 h-5 w-5 mr-2"><svg class="w-full h-full" viewBox="0 0 20 20" fill="currentcolor"><path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828.0 1 1 0 00-1.414 1.414 4 4 0 005.656.0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828.0 1 1 0 101.414-1.414 4 4 0 00-5.656.0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd"/></svg></div>https://get.k3s.io/"</a></div><div class="w-full my-6"><a href=https://get.k3s.io%3c/a%3e. class="break-all flex font-bold hover:text-black underline items-center leading-snug text-primary-500" target=_blank><div class="flex-shrink-0 h-5 w-5 mr-2"><svg class="w-full h-full" viewBox="0 0 20 20" fill="currentcolor"><path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828.0 1 1 0 00-1.414 1.414 4 4 0 005.656.0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828.0 1 1 0 101.414-1.414 4 4 0 00-5.656.0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd"/></svg></div>https://get.k3s.io</a>.</a></div><div class="w-full my-6"><a href=https://get.k3s.io class="break-all flex font-bold hover:text-black underline items-center leading-snug text-primary-500" target=_blank><div class="flex-shrink-0 h-5 w-5 mr-2"><svg class="w-full h-full" viewBox="0 0 20 20" fill="currentcolor"><path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828.0 1 1 0 00-1.414 1.414 4 4 0 005.656.0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828.0 1 1 0 101.414-1.414 4 4 0 00-5.656.0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd"/></svg></div>https://get.k3s.io</a></div><div class="w-full my-6"><a href=https://github.com/k3s-io/k3s/releases/download/v1.32.3+k3s1/sha256sum-amd64.txt class="break-all flex font-bold hover:text-black underline items-center leading-snug text-primary-500" target=_blank><div class="flex-shrink-0 h-5 w-5 mr-2"><svg class="w-full h-full" viewBox="0 0 20 20" fill="currentcolor"><path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828.0 1 1 0 00-1.414 1.414 4 4 0 005.656.0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828.0 1 1 0 101.414-1.414 4 4 0 00-5.656.0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd"/></svg></div>https://github.com/k3s-io/k3s/releases/download/v1.32.3+k3s1/sha256sum-amd64.txt</a></div><div class="w-full my-6"><a href=https://github.com/k3s-io/k3s/releases/download/v1.32.3+k3s1/k3s class="break-all flex font-bold hover:text-black underline items-center leading-snug text-primary-500" target=_blank><div class="flex-shrink-0 h-5 w-5 mr-2"><svg class="w-full h-full" viewBox="0 0 20 20" fill="currentcolor"><path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828.0 1 1 0 00-1.414 1.414 4 4 0 005.656.0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828.0 1 1 0 101.414-1.414 4 4 0 00-5.656.0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd"/></svg></div>https://github.com/k3s-io/k3s/releases/download/v1.32.3+k3s1/k3s</a></div><div class="w-full my-6"><a href=https://get.k3s.io class="break-all flex font-bold hover:text-black underline items-center leading-snug text-primary-500" target=_blank><div class="flex-shrink-0 h-5 w-5 mr-2"><svg class="w-full h-full" viewBox="0 0 20 20" fill="currentcolor"><path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828.0 1 1 0 00-1.414 1.414 4 4 0 005.656.0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828.0 1 1 0 101.414-1.414 4 4 0 00-5.656.0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd"/></svg></div>https://get.k3s.io</a></div><div class="w-full my-6"><a href=https://myserver:6443 class="break-all flex font-bold hover:text-black underline items-center leading-snug text-primary-500" target=_blank><div class="flex-shrink-0 h-5 w-5 mr-2"><svg class="w-full h-full" viewBox="0 0 20 20" fill="currentcolor"><path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828.0 1 1 0 00-1.414 1.414 4 4 0 005.656.0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828.0 1 1 0 101.414-1.414 4 4 0 00-5.656.0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd"/></svg></div>https://myserver:6443</a></div><div class="w-full my-6"><a href=https://packages.microsoft.com/keys/microsoft.asc class="break-all flex font-bold hover:text-black underline items-center leading-snug text-primary-500" target=_blank><div class="flex-shrink-0 h-5 w-5 mr-2"><svg class="w-full h-full" viewBox="0 0 20 20" fill="currentcolor"><path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828.0 1 1 0 00-1.414 1.414 4 4 0 005.656.0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828.0 1 1 0 101.414-1.414 4 4 0 00-5.656.0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd"/></svg></div>https://packages.microsoft.com/keys/microsoft.asc</a></div><div class="w-full my-6"><a href=https://packages.microsoft.com/repos/azure-cli/ class="break-all flex font-bold hover:text-black underline items-center leading-snug text-primary-500" target=_blank><div class="flex-shrink-0 h-5 w-5 mr-2"><svg class="w-full h-full" viewBox="0 0 20 20" fill="currentcolor"><path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828.0 1 1 0 00-1.414 1.414 4 4 0 005.656.0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828.0 1 1 0 101.414-1.414 4 4 0 00-5.656.0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd"/></svg></div>https://packages.microsoft.com/repos/azure-cli/</a></div><div class="w-full my-6"><a href=https://microsoft.com/devicelogin class="break-all flex font-bold hover:text-black underline items-center leading-snug text-primary-500" target=_blank><div class="flex-shrink-0 h-5 w-5 mr-2"><svg class="w-full h-full" viewBox="0 0 20 20" fill="currentcolor"><path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828.0 1 1 0 00-1.414 1.414 4 4 0 005.656.0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828.0 1 1 0 101.414-1.414 4 4 0 00-5.656.0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd"/></svg></div>https://microsoft.com/devicelogin</a></div><div class="w-full my-6"><a href=https://learn.microsoft.com/en-us/azure/azure-arc/kubernetes/agent-upgrade#manually-upgrade-agents%22 class="break-all flex font-bold hover:text-black underline items-center leading-snug text-primary-500" target=_blank><div class="flex-shrink-0 h-5 w-5 mr-2"><svg class="w-full h-full" viewBox="0 0 20 20" fill="currentcolor"><path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828.0 1 1 0 00-1.414 1.414 4 4 0 005.656.0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828.0 1 1 0 101.414-1.414 4 4 0 00-5.656.0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd"/></svg></div>https://learn.microsoft.com/en-us/azure/azure-arc/kubernetes/agent-upgrade#manually-upgrade-agents"</a></div><div class="w-full my-6"><a href=https://aka.ms/CLI_refstatus class="break-all flex font-bold hover:text-black underline items-center leading-snug text-primary-500" target=_blank><div class="flex-shrink-0 h-5 w-5 mr-2"><svg class="w-full h-full" viewBox="0 0 20 20" fill="currentcolor"><path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828.0 1 1 0 00-1.414 1.414 4 4 0 005.656.0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828.0 1 1 0 101.414-1.414 4 4 0 00-5.656.0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd"/></svg></div>https://aka.ms/CLI_refstatus</a></div><div class="w-full my-6"><a href=https://aka.ms/CLI_refstatus class="break-all flex font-bold hover:text-black underline items-center leading-snug text-primary-500" target=_blank><div class="flex-shrink-0 h-5 w-5 mr-2"><svg class="w-full h-full" viewBox="0 0 20 20" fill="currentcolor"><path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828.0 1 1 0 00-1.414 1.414 4 4 0 005.656.0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828.0 1 1 0 101.414-1.414 4 4 0 00-5.656.0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd"/></svg></div>https://aka.ms/CLI_refstatus</a></div><div class="w-full my-6"><a href=https://github.com/Azure/azure-cli/issues class="break-all flex font-bold hover:text-black underline items-center leading-snug text-primary-500" target=_blank><div class="flex-shrink-0 h-5 w-5 mr-2"><svg class="w-full h-full" viewBox="0 0 20 20" fill="currentcolor"><path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828.0 1 1 0 00-1.414 1.414 4 4 0 005.656.0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828.0 1 1 0 101.414-1.414 4 4 0 00-5.656.0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd"/></svg></div>https://github.com/Azure/azure-cli/issues</a></div><div class="w-full my-6"><a href=https://europe.oic.prod-arc.azure.com/d993d9e4-644e-4d0a-ba80-0e010d0ea023/b1ba6b46-f5cf-49cb-b278-1af11d320898/&amp;#34;%3c/span%3e, class="break-all flex font-bold hover:text-black underline items-center leading-snug text-primary-500" target=_blank><div class="flex-shrink-0 h-5 w-5 mr-2"><svg class="w-full h-full" viewBox="0 0 20 20" fill="currentcolor"><path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828.0 1 1 0 00-1.414 1.414 4 4 0 005.656.0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828.0 1 1 0 101.414-1.414 4 4 0 00-5.656.0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd"/></svg></div>https://europe.oic.prod-arc.azure.com/d993d9e4-644e-4d0a-ba80-0e010d0ea023/b1ba6b46-f5cf-49cb-b278-1af11d320898/"</span>,</a></div><div class="w-full my-6"><a href=https://europe.oic.prod-arc.azure.com/d993d9e4-644e-4d0a-ba80-0e010d0ea023/b1ba6b46-f5cf-49cb-b278-1af11d320898/%3c/span%3e%3c/span%3e%3c/code%3e%3c/pre%3e class="break-all flex font-bold hover:text-black underline items-center leading-snug text-primary-500" target=_blank><div class="flex-shrink-0 h-5 w-5 mr-2"><svg class="w-full h-full" viewBox="0 0 20 20" fill="currentcolor"><path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828.0 1 1 0 00-1.414 1.414 4 4 0 005.656.0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828.0 1 1 0 101.414-1.414 4 4 0 00-5.656.0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd"/></svg></div>https://europe.oic.prod-arc.azure.com/d993d9e4-644e-4d0a-ba80-0e010d0ea023/b1ba6b46-f5cf-49cb-b278-1af11d320898/</span></span></code></pre></a></div><div class="w-full my-6"><a href=https://learn.microsoft.com/en-us/cli/azure/connectedk8s#az-connectedk8s-enable-features%22 class="break-all flex font-bold hover:text-black underline items-center leading-snug text-primary-500" target=_blank><div class="flex-shrink-0 h-5 w-5 mr-2"><svg class="w-full h-full" viewBox="0 0 20 20" fill="currentcolor"><path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828.0 1 1 0 00-1.414 1.414 4 4 0 005.656.0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828.0 1 1 0 101.414-1.414 4 4 0 00-5.656.0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd"/></svg></div>https://learn.microsoft.com/en-us/cli/azure/connectedk8s#az-connectedk8s-enable-features"</a></div><div class="w-full my-6"><a href=https://aka.ms/CLI_refstatus class="break-all flex font-bold hover:text-black underline items-center leading-snug text-primary-500" target=_blank><div class="flex-shrink-0 h-5 w-5 mr-2"><svg class="w-full h-full" viewBox="0 0 20 20" fill="currentcolor"><path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828.0 1 1 0 00-1.414 1.414 4 4 0 005.656.0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828.0 1 1 0 101.414-1.414 4 4 0 00-5.656.0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd"/></svg></div>https://aka.ms/CLI_refstatus</a></div><div class="w-full my-6"><a href=https://aka.ms/enable-customlocation class="break-all flex font-bold hover:text-black underline items-center leading-snug text-primary-500" target=_blank><div class="flex-shrink-0 h-5 w-5 mr-2"><svg class="w-full h-full" viewBox="0 0 20 20" fill="currentcolor"><path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828.0 1 1 0 00-1.414 1.414 4 4 0 005.656.0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828.0 1 1 0 101.414-1.414 4 4 0 00-5.656.0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd"/></svg></div>https://aka.ms/enable-customlocation</a></div><div class="w-full my-6"><a href=https://kubernetes.io/docs/reference/access-authn-authz/rbac/#kubectl-create-rolebinding%22 class="break-all flex font-bold hover:text-black underline items-center leading-snug text-primary-500" target=_blank><div class="flex-shrink-0 h-5 w-5 mr-2"><svg class="w-full h-full" viewBox="0 0 20 20" fill="currentcolor"><path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828.0 1 1 0 00-1.414 1.414 4 4 0 005.656.0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828.0 1 1 0 101.414-1.414 4 4 0 00-5.656.0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd"/></svg></div>https://kubernetes.io/docs/reference/access-authn-authz/rbac/#kubectl-create-rolebinding"</a></div></div><aside class="order-first lg:order-last lg:pt-12"><div class="lg:sticky lg:top-24 overflow-y-auto" x-data=taToc data-length=197 data-threshold=400 data-elements=6 data-title-show data-title-hide><h2 class="relative text-3xl lg:text-xl font-bold leading-tight text-secondary-500">Table of contents</h2><div class="tableofcontents pt-4 px-1"><nav id=TableOfContents><ul><li><a href=#installing-k3s>Installing K3s</a><ul><li><a href=#k3s-configuration>K3s Configuration</a></li><li><a href=#performance-tweaks>Performance Tweaks</a></li></ul></li><li><a href=#arc-enable-k3s>Arc Enable K3s</a><ul><li><a href=#install-az-cli>Install az CLI</a></li><li><a href=#connect-k3s-cluster-to-azure-arc>Connect K3s cluster to Azure Arc</a></li><li><a href=#enable-custom-locations-on-the-cluster>Enable Custom Locations on the Cluster</a></li><li><a href=#check-the-azure-ui>Check the Azure UI</a></li></ul></li><li><a href=#managing-the-cluster>Managing the Cluster</a><ul><li><a href=#create-service-account-and-retrieve-token>Create Service Account and Retrieve Token</a></li><li><a href=#add-token-to-the-azure-portal>Add Token to the Azure Portal</a></li></ul></li><li><a href=#testing-a-deployment>Testing a Deployment</a></li><li><a href=#access-the-k3s-from-a-developer-computer-with-azure-arc>Access the k3s from a Developer Computer with Azure Arc</a></li><li><a href=#monitoring>Monitoring</a><ul><li><a href=#enable-metrics-collection-for-the-cluster>Enable metrics collection for the cluster</a></li><li><a href=#enable-container-insights-logs-for-logs-collection>Enable Container Insights logs for logs collection.</a></li><li><a href=#create-dashboards-in-the-azure-portal>Create Dashboards in the Azure Portal</a></li><li><a href=#grafana-dashboard>Grafana Dashboard</a></li><li><a href=#browse-available-dashboards>Browse Available Dashboards</a></li><li><a href=#no-data-displayed>No Data Displayed?</a></li><li><a href=#verify-metrics-are-being-scraped>Verify Metrics Are Being Scraped</a></li></ul></li></ul></nav></div><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC","true")</script></div></aside></div><div class="relative -mx-8 lg:-mx-40 xl:-mx-40 2xl:-mx-40 h-16 mb-32"><div class="overflow-hidden absolute-center -z-1"><div class="w-full h-full flex-center"><img src=/images/img-separate-gradient.svg loading=eager alt class="hidden sm:block w-full min-w-[768px]">
<img src=/images/img-separate.svg loading=eager alt class="block sm:hidden w-full min-w-[768px]"></div></div></div><div class="w-full sm:w-2/3 text-center text-secondary-500 mx-auto mb-8"><h2 class="relative text-5xl font-bold leading-tense overflow-hidden mb-4"><div id=strongmorestrong-articles class="absolute -top-28"></div><strong>More</strong> articles</h2><div class="text-lg leading-normal">Thoughts, topics or just solutions I would like to make available to you,
colleagues and fellow enthusiasts.</div></div><div class="grid grid-cols-1 sm:grid-cols-3 gap-y-12 sm:gap-12 my-12"><a href=/posts/iot-nodered-on-arc-enabled-edge/><div class="flex-center shadow-glow bg-gradient-radius to-blue-100 border border-blue-100 rounded-xl p-4 h-40 mb-2"><img class="h-full object-contain" src=/images/series/azure-iot-featured.png></div><div class="text-md text-gray-600 leading-relaxed p-2"><h3 class="text-xl font-bold text-primary-500 leading-tight mb-2">IoT - NodeRED on Arc-Enabled Edge</h3>Learn how to deploy a fully integrated Node-RED environment inside a K3s Kubernetes cluster on an Azure Arc-connected edge device. This guide walks you through namespace setup, persistent storage, service exposure, and secure access over SSH tunnels. Simulate MQTT and Modbus devices, visualize flows, and forward real-time telemetry to Azure MQ and OPC UAâ€”all without opening firewall ports. Ideal for industrial IoT scenarios needing secure hybrid connectivity and local processing.</div></a><a href=/posts/azure-arc-enabling-an-ubuntu-server/><div class="text-md text-gray-600 leading-relaxed p-2"><h3 class="text-xl font-bold text-primary-500 leading-tight mb-2">Azure Arc enabling an Ubuntu Server</h3>Discover how to transform a basic Ubuntu server into a fully Azure Arc-enabled edge device. This step-by-step guide walks you through onboarding a Linux server into Azure Arc, installing the hybrid agent, establishing secure remote access over web sockets, and enabling centralized management through the Azure Portal. Whether for IoT, hybrid cloud, or secure remote administration, this post equips you with the tools to bridge your edge environments seamlessly with Azure.</div></a><a href=/posts/bicep-tags-as-parameters/><div class="flex-center shadow-glow bg-gradient-radius to-blue-100 border border-blue-100 rounded-xl p-4 h-40 mb-2"><img class="h-full object-contain" src=./cover-b97ceb91.jpg></div><div class="text-md text-gray-600 leading-relaxed p-2"><h3 class="text-xl font-bold text-primary-500 leading-tight mb-2">Bicep - Tags as Parameters</h3><p><strong>Deploying infrastructure ARM Templates to Azure, but using Tags and their respective value as the parameter configuration settings</strong></p><p>In a post earlier, we look at using arm to lookup the value of tags&rsquo; at both the Subscription and Resource Level.</p><p>With Bicep this is much easier to understand. This is the same lab configuration as in the original post, but this time to code should be a lot more readable.</p></div></a></div></main></div></main><footer role=footer><div class="relative w-full bg-gray-100 bg-gradient-to-b from-gray-200 to-white pt-20"><div class="absolute inset-x-0 top-0 w-full h-40 text-white"><svg class="w-full" viewbox="0 0 1680 91" fill="currentcolor" preserveaspectratio="none"><path d="M1680 0H0L.324249e-4 61.9736C60.8062 60.5012 108.186 53.8676 158.825 46.7777 211.452 39.4093 267.601 31.548 346 28.4749c62.978-2.4687 133.888 5.1285 211.598 13.4542C669.71 53.9406 795.977 67.4685 933 54.4749c232-22 509 7.4989 747 35.9962V0z"/></svg></div><div class="flex justify-between w-full max-w-screen-2xl mx-auto px-8 lg:px-40 pb-16 pt-8"><div class="flex-shrink-0 w-2/12 sm:w-1/12"><img src=/images/img-logo-damian-flynn-blue.svg alt class=w-full></div><div class="flex-grow flex flex-wrap justify-between text-secondary-500 ml-8 pt-4"><div class="w-full sm:w-5/12 pb-8 sm:pb-2"><p class="text-base font-bold mb-2">Let me introduce myself</p><p class="text-sm text-gray-500 font-regular">I am a Microsoft Microsoft MVP with over 20 years of experience in making technology simpler through Infrastructure as Code (IaC) and cloud operations. Iâ€™m passionate about transforming complex Azure environments into intuitive systems, starting with a minimal viable product that delivers real value. My goal is to enhance user experience while empowering teams to grow and succeed in the cloud landscape.</p></div><div class="flex-shrink-0 w-4/12 sm:w-2/12 pb-2"><p class="text-base font-bold mb-2">Links</p><p class="text-sm leading-tight font-bold"><a href=/about class="inline-block text-primary-500 font-semibold hover:text-black hover:underline mb-1 mr-2">About</a>
<a href=/posts class="inline-block text-primary-500 font-semibold hover:text-black hover:underline mb-1 mr-2">Articles</a>
<a href=/contact.html class="inline-block text-primary-500 font-semibold hover:text-black hover:underline mb-1 mr-2">Contact</a>
<a href=/work.html class="inline-block text-primary-500 font-semibold hover:text-black hover:underline mb-1 mr-2">Work</a>
<a href=/disclaimer class="inline-block text-primary-500 font-semibold hover:text-black hover:underline mb-1 mr-2">Imprint</a>
<a href=/privacy class="inline-block text-primary-500 font-semibold hover:text-black hover:underline mb-1 mr-2">Privacy</a></p></div><div class="flex-shrink-0 w-6/12 sm:w-4/12 pb-2"><p class="text-base font-bold mb-2">Various topics</p><p class="text-sm leading-tight font-bold"><a href=/series/azure-iot-operations class="block text-primary-500 font-semibold hover:text-black hover:underline mb-1">Azure IoT Operations</a>
<a href=/series/building-azure-with-code class="block text-primary-500 font-semibold hover:text-black hover:underline mb-1">Building Azure with Code</a>
<a href=/series/ignite-2019 class="block text-primary-500 font-semibold hover:text-black hover:underline mb-1">Ignite 2019</a></p></div></div></div><div class="absolute inset-x-0 -bottom-2 text-secondary-500"><svg class="w-full h-12" fill="currentcolor" viewbox="0 0 1680 52" preserveaspectratio="none"><path d="m419 21.2305c-194 0-295-15.23306-418.99999624-12.2305l4298e-8 43L1680 51.9981V41.2042c-80-11.9737-348-48.3153-542-39.97374S613 21.2305 419 21.2305z"/></svg></div></div><div class="relative bg-secondary-500 text-xs font-semibold text-center text-secondary-50"><div class="w-full max-w-screen-2xl mx-auto px-8 lg:px-40 pb-6 pt-2"><p><svg class="icon" viewBox="0 0 512 512"><path d="M256 8C119.033 8 8 119.033 8 256s111.033 248 248 248 248-111.033 248-248S392.967 8 256 8zm0 448c-110.532.0-2e2-89.451-2e2-2e2.0-110.531 89.451-2e2 2e2-2e2 110.532.0 2e2 89.451 2e2 2e2.0 110.532-89.451 2e2-2e2 2e2zm107.351-101.064c-9.614 9.712-45.53 41.396-104.065 41.396-82.43.0-140.484-61.425-140.484-141.567.0-79.152 60.275-139.401 139.762-139.401 55.531.0 88.738 26.62 97.593 34.779a11.965 11.965.0 011.936 15.322l-18.155 28.113c-3.841 5.95-11.966 7.282-17.499 2.921-8.595-6.776-31.814-22.538-61.708-22.538-48.303.0-77.916 35.33-77.916 80.082.0 41.589 26.888 83.692 78.277 83.692 32.657.0 56.843-19.039 65.726-27.225 5.27-4.857 13.596-4.039 17.82 1.738l19.865 27.17a11.947 11.947.0 01-1.152 15.518z"/></svg>2011 - 2026<a href=/ target=_blank rel="noopener noreferrer"> </a>&nbsp;|&nbsp;<a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></p><div class="flex items-center justify-center my-2"><a href=https://www.youtube.com/channel/UCC-9OqE4nfLxDf-TonKqIRw/ class="font-extrabold text-white mx-2" title="Opens in new Window">Youtube </a><a href=https://github.com/damianflynn class="font-extrabold text-white mx-2" target=_blank title="Opens in new Window">GitHub </a><a href=https://www.x.com/damian_flynn class="font-extrabold text-white mx-2" target=_blank title="Opens in new Window">X </a><a href=https://www.linkedin.com/in/damianflynn class="font-extrabold text-white mx-2" target=_blank title="Opens in new Window">Linkedin</a></div><p></p></div></div></footer><script src=/js/js-scripts.js></script><script type=speculationrules>
        {
          "prerender": [
            {
              "where": { "href_matches": "/*" },
              "eagerness": "moderate"
            }
          ]
        }
    </script><script>console.log(`Page Title: IoT - Azure Arc Connected K3s 
Page URL: https://damianflynn.github.io/posts/iot-azure-arc-connected-k3s/
Page Type: posts`)</script></body></html>