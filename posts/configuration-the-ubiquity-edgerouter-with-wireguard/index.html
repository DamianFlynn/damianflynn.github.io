<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,height=device-height,initial-scale=1,minimum-scale=1"><meta name=robots content="noodp"><title>Configuration the Ubiquity EdgeRouter with WireGuard - Incredible Technology, Incredibly Simple</title><meta name=Description content><meta property="og:url" content="https://damianflynn.github.io/posts/configuration-the-ubiquity-edgerouter-with-wireguard/"><meta property="og:site_name" content="Incredible Technology, Incredibly Simple"><meta property="og:title" content="Configuration the Ubiquity EdgeRouter with WireGuard"><meta property="og:description" content="Virtual Private Networks are unmissable; however with many states now banning and actively blocking these tunnels the search for an alternative approach is appropriate, if we are to protect our identity and intellectual property.
One technology which claims to have fantastic throughput when compared to the stable IPSEC solutions, and based on benchmarks I have calculated leaves OpenVPN protocols in the dust, Wireguard positions itself as an in-kernel VPN solution which is very easy to implement and highly secure."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-10-05T00:00:00+00:00"><meta property="article:modified_time" content="2024-07-19T15:23:00+00:00"><meta property="article:tag" content="VPN"><meta property="og:image" content="https://damianflynn.github.io/posts/configuration-the-ubiquity-edgerouter-with-wireguard/cover-799b3640.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://damianflynn.github.io/posts/configuration-the-ubiquity-edgerouter-with-wireguard/cover-799b3640.jpg"><meta name=twitter:title content="Configuration the Ubiquity EdgeRouter with WireGuard"><meta name=twitter:description content="Virtual Private Networks are unmissable; however with many states now banning and actively blocking these tunnels the search for an alternative approach is appropriate, if we are to protect our identity and intellectual property.
One technology which claims to have fantastic throughput when compared to the stable IPSEC solutions, and based on benchmarks I have calculated leaves OpenVPN protocols in the dust, Wireguard positions itself as an in-kernel VPN solution which is very easy to implement and highly secure."><meta name=twitter:site content="@damian_flynn"><meta name=application-name content="TechSimplified"><meta name=apple-mobile-web-app-title content="TechSimplified"><meta name=theme-color content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><meta name=twitter:creator content="@damian_flynn"><link rel="shortcut icon" type=image/x-icon href=/favicons/img-favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicons/img-favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicons/img-favicon-16x16.png><link rel=icon type=image/png sizes=192x192 href=/favicons/img-android-chrome-192x192.png><link rel=icon type=image/png sizes=512x512 href=/favicons/img-android-chrome-512x512.png><link rel=apple-touch-icon sizes=180x180 href=/favicons/img-apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=https://damianflynn.github.io/posts/configuration-the-ubiquity-edgerouter-with-wireguard/><link rel=prev href=https://damianflynn.github.io/posts/configuring-the-web-application-firewall-with-powershell./><link rel=next href=https://damianflynn.github.io/posts/cbus-mqtt-bridge-on-raspberry-pi/><link rel=stylesheet href=/css/css-styles.min.css><link rel=stylesheet href=/css/n8n-chat.min.css><script type=module>
	import { createChat } from 'https://cdn.jsdelivr.net/npm/@n8n/chat/dist/chat.bundle.es.js';

	createChat({
		webhookUrl: 'https://n8n.deercrest.info/webhook/b76d02c0-b406-4d21-b6bf-8ad2c623def3/chat',
    initialMessages: [
      'Hi there! ðŸ‘‹',
      'My name is Nathan. How can I assist you today?'
    ],
    i18n: {
      en: {
        title: 'Search ðŸ”Ž & Chat! ðŸ‘‹',
        subtitle: "Start a chat. We're here to help you 24/7.",
        footer: '',
        getStarted: 'New Conversation',
        inputPlaceholder: 'Type your question..',
      },
    },
    showWelcomeScreen: false,
	  defaultLanguage: 'en'
	});
</script><script src=/js/alpinejs.js defer></script><style>[x-cloak]{display:none!important}</style><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Configuration the Ubiquity EdgeRouter with WireGuard","inLanguage":"en-us","mainEntityOfPage":{"@type":"WebPage","@id":"https://damianflynn.github.io/posts/configuration-the-ubiquity-edgerouter-with-wireguard/"},"image":["https://damianflynn.github.io/cover-799b3640.jpg"],"genre":"posts","keywords":["VPN"],"wordcount":4880,"url":"https://damianflynn.github.io/posts/configuration-the-ubiquity-edgerouter-with-wireguard/","datePublished":"2019-10-05T00:00:00+00:00","dateModified":"2024-07-19T15:23:00+00:00","publisher":{"@type":"Organization","name":"xxxx","logo":{"@type":"ImageObject","url":"https://damianflynn.github.io/images/avatar.webp","width":400,"height":400}},"author":{"@type":"Person","name":"Author","url":"/"},"description":""}</script></head><body data-instant-intensity=viewport class="bg-white font-sans tracking-wide text-base text-gray-700 print:text-black font-medium break-words hyphens antialiased flex flex-col min-h-screen ta-page-scrolling"><div role=navigation class="absolute inset-x-0 top-0 z-10 w-full text-center h-16 sm:h-20 lg:h-24 xl:h-28" x-data=taNavigation><a href=/ class="absolute left-0 top-0 h-full flex-center w-16 sm:w-20 lg:w-24 xl:w-28 p-3 sm:p-4 lg:p-5 xl:p-6 bg-secondary-500"><span class=sr-only>To the home page</span>
<img src=/images/img-logo-damian-flynn-white.svg alt="Logo Damian Flynn" class=w-full></a><div class="absolute lg:hidden right-0 top-0 text-white w-16 h-16 sm:w-20 sm:h-20 p-3 sm:p-4"><svg class="w-full h-full" viewbox="0 0 20 20" fill="currentcolor"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4A1 1 0 013 5zm0 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/></svg></div><div class="hidden lg:flex items-center justify-between w-full h-full max-w-screen-2xl mx-auto px-40"><div class="flex h-full text-base font-semibold uppercase"><div class="relative flex-center text-primary-500 px-4"><a class=menu-item href=/>Home</a></div><div class="relative flex-center text-primary-500 px-4"><a class=menu-item href=/posts/>Articles</a></div><div class="relative flex-center text-primary-500 px-4"><a class=menu-item href=/series/>Topics</a></div><div class="relative flex-center text-primary-500 px-4"><a class=menu-item href=/about/>About</a></div></div><div class="flex items-center -mr-2 xl:-mr-4"><a href=https://www.youtube.com/channel/UCC-9OqE4nfLxDf-TonKqIRw/ class="block text-primary-500 h-6 w-6 mx-2 xl:mx-4 drop-shadow-sharp" target=_blank title="Opens in new Window"><span class=sr-only>Youtube </span><svg class="w-full h-full" fill="currentcolor" viewbox="0 0 576 512"><path d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78.0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"/></svg>
</a><a href=https://github.com/damianflynn class="block text-primary-500 h-6 w-6 mx-2 xl:mx-4 drop-shadow-sharp" target=_blank title="Opens in new Window"><span class=sr-only>GitHub </span><svg class="w-full h-full" fill="currentcolor" viewbox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8.0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8.0-21.5 4.9-32.3 14.6-51.8 45.3.0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8.0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9.0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2.0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8.0-73.5 38.7-73.5 82.6.0 87.8 80.4 101.3 150.4 101.3h48.2c70.3.0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8.0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
</a><a href=https://www.x.com/damian_flynn class="block text-primary-500 h-6 w-6 mx-2 xl:mx-4 drop-shadow-sharp" target=_blank title="Opens in new Window"><span class=sr-only>X </span><svg class="w-full h-full" fill="currentcolor" viewbox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645.0 138.72-105.583 298.558-298.558 298.558-59.452.0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055.0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421.0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391.0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04.0-57.828 46.782-104.934 104.934-104.934 30.213.0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
</a><a href=https://www.linkedin.com/in/damianflynn class="block text-primary-500 h-6 w-6 mx-2 xl:mx-4 drop-shadow-sharp" target=_blank title="Opens in new Window"><span class=sr-only>Linkedin</span>
<svg class="w-full h-full" fill="currentcolor" viewbox="0 0 448 512"><path d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg></a></div></div><div class="fixed lg:hidden inset-0 backdrop-filter backdrop-blur-sm bg-gray-900 bg-opacity-75 z-50" x-show=modal x-transition.opacity.duration.500ms></div><div class="ta-navigation-modal fixed lg:hidden inset-y-0 right-0 w-10/12 sm:w-2/3 bg-white pt-32 z-50" x-ref=modal><div class="absolute top-0 right-0 text-primary-500 w-16 h-16 p-2"><svg class="w-full h-full" viewbox="0 0 20 20" fill="currentcolor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414.0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg></div><div class="flex flex-col justify-between text-left text-3xl h-full ml-12"><div class="flex flex-col"><div class="font-semibold text-primary-500 p-2 sm:my-2"><a href=/>Home</a></div><div class="font-semibold text-primary-500 p-2 sm:my-2"><a href=/posts/>Articles</a></div><div class="font-semibold text-primary-500 p-2 sm:my-2"><a href=/series/>Topics</a></div><div class="font-semibold text-primary-500 p-2 sm:my-2"><a href=/about/>About</a></div></div><div class="flex flex-wrap mb-12"><a href=https://www.youtube.com/channel/UCC-9OqE4nfLxDf-TonKqIRw/ class="block text-primary-500 h-8 w-8 mx-4 sm:mx-6" target=_blank title="Opens in new Window"><span class=sr-only>Youtube </span><svg class="w-full h-full" fill="currentcolor" viewbox="0 0 576 512"><path d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78.0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"/></svg>
</a><a href=https://github.com/damianflynn class="block text-primary-500 h-8 w-8 mx-4 sm:mx-6" target=_blank title="Opens in new Window"><span class=sr-only>GitHub </span><svg class="w-full h-full" fill="currentcolor" viewbox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8.0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8.0-21.5 4.9-32.3 14.6-51.8 45.3.0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8.0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9.0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2.0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8.0-73.5 38.7-73.5 82.6.0 87.8 80.4 101.3 150.4 101.3h48.2c70.3.0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8.0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
</a><a href=https://www.x.com/damian_flynn class="block text-primary-500 h-8 w-8 mx-4 sm:mx-6" target=_blank title="Opens in new Window"><span class=sr-only>X </span><svg class="w-full h-full" fill="currentcolor" viewbox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645.0 138.72-105.583 298.558-298.558 298.558-59.452.0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055.0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421.0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391.0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04.0-57.828 46.782-104.934 104.934-104.934 30.213.0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
</a><a href=https://www.linkedin.com/in/damianflynn class="block text-primary-500 h-8 w-8 mx-4 sm:mx-6" target=_blank title="Opens in new Window"><span class=sr-only>Linkedin</span>
<svg class="w-full h-full" fill="currentcolor" viewbox="0 0 448 512"><path d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg></a></div></div></div><div class="ta-navigation-scroll top-0 inset-x-0 z-40" x-ref=scroll><div class="flex justify-between items-center lg:hidden"><a href=/index.html class="flex-center w-16 sm:w-20 p-3 sm:p-4 h-16 sm:h-20 bg-secondary-500"><span class=sr-only>To the home page</span>
<img src=/images/img-logo-damian-flynn-white.svg alt="Logo Damian Flynn" class=w-full></a><div class="flex-shrink-0 text-primary-500 w-16 h-16 p-3"><svg class="w-full h-full" viewbox="0 0 20 20" fill="currentcolor"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4A1 1 0 013 5zm0 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/></svg></div></div><div class="relative hidden lg:flex justify-between items-center h-20"><a href=/index.html class="absolute top-0 left-0 flex-center w-20 h-20 p-4 bg-secondary-500"><span class=sr-only>To the home page</span>
<img src=/images/img-logo-damian-flynn-white.svg alt="Logo Damian Flynn" class=w-full></a><div class="flex items-center justify-between max-w-screen-2xl w-full h-full mx-auto px-40"><div class="flex h-full text-base font-semibold uppercase -ml-4"><div class="relative flex-center font-semibold text-primary-500 p-2 sm:my-2"><a class=menu-item href=/>Home</a></div><div class="relative flex-center font-semibold text-primary-500 p-2 sm:my-2"><a class=menu-item href=/posts/>Articles</a></div><div class="relative flex-center font-semibold text-primary-500 p-2 sm:my-2"><a class=menu-item href=/series/>Topics</a></div><div class="relative flex-center font-semibold text-primary-500 p-2 sm:my-2"><a class=menu-item href=/about/>About</a></div></div><div class="flex items-center -mr-2 xl:-mr-4"><a href=https://www.youtube.com/channel/UCC-9OqE4nfLxDf-TonKqIRw/ class="block text-primary-500 h-6 w-6 mx-2 xl:mx-4" target=_blank title="Opens in new Window"><span class=sr-only>Youtube </span><svg class="w-full h-full" fill="currentcolor" viewbox="0 0 576 512"><path d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78.0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"/></svg>
</a><a href=https://github.com/damianflynn class="block text-primary-500 h-6 w-6 mx-2 xl:mx-4" target=_blank title="Opens in new Window"><span class=sr-only>GitHub </span><svg class="w-full h-full" fill="currentcolor" viewbox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8.0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8.0-21.5 4.9-32.3 14.6-51.8 45.3.0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8.0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9.0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2.0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8.0-73.5 38.7-73.5 82.6.0 87.8 80.4 101.3 150.4 101.3h48.2c70.3.0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8.0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
</a><a href=https://www.x.com/damian_flynn class="block text-primary-500 h-6 w-6 mx-2 xl:mx-4" target=_blank title="Opens in new Window"><span class=sr-only>X </span><svg class="w-full h-full" fill="currentcolor" viewbox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645.0 138.72-105.583 298.558-298.558 298.558-59.452.0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055.0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421.0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391.0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04.0-57.828 46.782-104.934 104.934-104.934 30.213.0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
</a><a href=https://www.linkedin.com/in/damianflynn class="block text-primary-500 h-6 w-6 mx-2 xl:mx-4" target=_blank title="Opens in new Window"><span class=sr-only>Linkedin</span>
<svg class="w-full h-full" fill="currentcolor" viewbox="0 0 448 512"><path d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg></a></div></div></div><div class="absolute inset-0 bg-white bg-opacity-90 shadow-lg backdrop-filter backdrop-blur-xs -z-1"></div></div></div><main role=main class="flex-grow-1 full"><div class="relative bg-gradient-article pt-16 sm:pt-20 lg:pt-24 xl:pt-28 isolate"><div class="absolute inset-x-0 -bottom-72 h-96"><div class="w-full h-full flex-center overflow-hidden"><img src=/images/img-exclude-white.svg alt class="w-full h-full min-w-[768px]"></div></div><div class="flex flex-col-reverse lg:flex-row justify-between w-full max-w-screen-2xl mx-auto text-secondary-500 px-12 lg:pl-40 xl:pr-0 pt-12 xl:pt-16 pb-16 isolate"><div class="max-w-2xl lg:mr-12 break-hyphen"><nav aria-label=breadcrumb><ol class="flex flex-wrap items-center text-sm leading-none font-bold mb-4 sm:mb-2"><li class=pr-1><a href=/index.html class="flex items-center text-primary-500 py-1"><div class="h-5 w-5"><svg class="w-full h-full" fill="currentcolor" viewbox="0 0 576 512"><path d="M280.37 148.26 96 300.11V464a16 16 0 0016 16l112.06-.29a16 16 0 0015.92-16V368a16 16 0 0116-16h64a16 16 0 0116 16v95.64a16 16 0 0016 16.05L464 480a16 16 0 0016-16V3e2L295.67 148.26a12.19 12.19.0 00-15.3.0zM571.6 251.47 488 182.56V44.05a12 12 0 00-12-12h-56a12 12 0 00-12 12v72.61L318.47 43a48 48 0 00-61 0L4.34 251.47a12 12 0 00-1.6 16.9l25.5 31A12 12 0 0045.15 301l235.22-193.74a12.19 12.19.0 0115.3.0L530.9 301a12 12 0 0016.9-1.6l25.5-31a12 12 0 00-1.7-16.93z"/></svg></div><span class=ml-2>Home</span></a></li><li class="flex items-center"><div class="h-4 w-4"><svg class="w-full h-full" fill="currentcolor" viewbox="0 0 512 512" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="m15 0h525.355a15 15 0 0115 15v38.555a15 15 0 01-15 15H15a15 15 0 01-15-15V15A15 15 0 0115 0z" transform="matrix(-.5 .8660254 -.8660254 -.5 424.048 32.277)"/></svg></div><a href=/posts class="flex items-center text-primary-500 px-1 py-1">Articles</a></li><li class="flex items-center text-secondary-500"><div class="h-4 w-4"><svg class="w-full h-full" fill="currentcolor" viewbox="0 0 512 512" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="m15 0h525.355a15 15 0 0115 15v38.555a15 15 0 01-15 15H15a15 15 0 01-15-15V15A15 15 0 0115 0z" transform="matrix(-.5 .8660254 -.8660254 -.5 424.048 32.277)"/></svg></div><span class="px-1 py-1">Configuration the Ubiquity EdgeRouter with WireGuard</span></li></ol></nav><div class="text-6xl leading-none font-bold mb-2">Configuration the Ubiquity EdgeRouter with WireGuard</div><div class="text-2xl leading-snug mb-4"><p>Virtual Private Networks are unmissable; however with many states now banning and actively blocking these tunnels the search for an alternative approach is appropriate, if we are to protect our identity and intellectual property.</p><p>One technology which claims to have fantastic throughput when compared to the stable IPSEC solutions, and based on benchmarks I have calculated leaves OpenVPN protocols in the dust, Wireguard positions itself as an in-kernel VPN solution which is very easy to implement and highly secure.</p></div><div class="flex flex-wrap items-center -ml-2 mb-8"><a href=/tags/vpn/ class="flex items-center text-xs uppercase text-primary-500 font-bold m-2"><span class="h-5 w-5 mr-1"><svg class="w-full h-full" fill="none" viewbox="0 0 24 24" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512.0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828.0l-7-7A1.994 1.994.0 013 12V7a4 4 0 014-4z"/></svg> </span>VPN</a></div><div class="flex items-center"><div class="w-16 h-16 overflow-hidden rounded-full shadow-lg"><svg class="icon" viewBox="0 0 496 512"><path d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm0 96c48.6.0 88 39.4 88 88s-39.4 88-88 88-88-39.4-88-88 39.4-88 88-88zm0 344c-58.7.0-111.3-26.6-146.5-68.2 18.8-35.4 55.6-59.8 98.5-59.8 2.4.0 4.8.4 7.1 1.1 13 4.2 26.6 6.9 40.9 6.9s28-2.7 40.9-6.9c2.3-.7 4.7-1.1 7.1-1.1 42.9.0 79.7 24.4 98.5 59.8C359.3 421.4 306.7 448 248 448z"/></svg>Author</div><div class=ml-4><div class="text-secondary-500 text-lg font-bold">Author: <a href=/ title=Author rel=author class=author>Author</a></div><div class="text-gray-500 text-md font-semibold">Published: <time datetime="5 Oct, 2019">5 Oct, 2019</time></div><div class="text-gray-500 text-md font-semibold">Updated: <time datetime="19 Jul, 2024">19 Jul, 2024</time></div></div></div></div><div class="relative flex-shrink-0 flex-grow max-w-lg min-w-80 pb-8 lg:pb-0 -mt-12 lg:mt-0 transform md:transform-none scale-110 -z-1"><img class="w-full lg:absolute-center drop-shadow-glow" src=./cover-799b3640.jpg></div></div></div><div id=main class="w-full max-w-screen-2xl mx-auto px-8 lg:px-40 my-24 isolate"><main><div class="grid grid-cols-1 lg:grid-cols-3 gap-x-12 xl:gap-x-24"><div class="lg:col-span-2 copy text-base leading-loose"><p>Virtual Private Networks are unmissable; however with many states now banning and actively blocking these tunnels the search for an alternative approach is appropriate, if we are to protect our identity and intellectual property.</p><p>One technology which claims to have fantastic throughput when compared to the stable IPSEC solutions, and based on benchmarks I have calculated leaves OpenVPN protocols in the dust, Wireguard positions itself as an in-kernel VPN solution which is very easy to implement and highly secure.</p><p>This post will attempt to address the first challenge of implementing the technology, and later we can run our own benchmarks to see how in reality performance measures up.</p><h1 class="relative text-5xl font-semibold leading-tense text-secondary-500 mb-4 -ml-px" id=network-overview><a href=#network-overview class=header-mark aria-label="Header mark for 'Network Overview'"></a><div id=network-overview class="absolute -top-28"></div>Network Overview</h1><p>The Environment I will implement will contain two endpoints, both of which are directly connected to the public internet.</p><p>The following table, defines the configuration points of the environment</p><h1 class="relative text-5xl font-semibold leading-tense text-secondary-500 mb-4 -ml-px" id=node-installation><a href=#node-installation class=header-mark aria-label="Header mark for 'Node Installation'"></a><div id=node-installation class="absolute -top-28"></div>Node Installation</h1><h2 class="relative text-3xl font-bold leading-tight text-secondary-500 mb-2 mt-12 -ml-px"><div id=ubuntu-1604 class="absolute -top-28"></div>Ubuntu 16.04</h2><h3 class="text-xl font-bold text-primary-500 leading-tight mb-2" id=azure><a href=#azure class=header-mark aria-label="Header mark for 'Azure'"></a>Azure</h3><div class="code-block highlight is-closed show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>shell</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-1 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=nb>export</span> <span class=nv>azResourceGroup</span><span class=o>=</span><span class=s2>&#34;USEast_VPNGateway&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>azLocation</span><span class=o>=</span><span class=s2>&#34;eastus&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># VNET supports 32 subnets from 192.168.192.0 - 192.168.199.255</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>azVnetName</span><span class=o>=</span><span class=s2>&#34;USEast_Networks&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>azVnetPrefix</span><span class=o>=</span><span class=s2>&#34;192.168.192.0/21&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Allocating the first /24 subnet for the VPNGateway</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>azGWSubnetName</span><span class=o>=</span><span class=s2>&#34;USEast_VPNGateway&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>azGWSubnetPrefix</span><span class=o>=</span><span class=s2>&#34;192.168.192.0/24&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Define the Gateways WAN Interface</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>azGWWanNicName</span><span class=o>=</span><span class=s2>&#34;USEast_VPNGateway_WAN&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>azGWWanNicPrivateIp</span><span class=o>=</span><span class=s2>&#34;192.168.192.4&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>azGWWanNicPublicIpName</span><span class=o>=</span><span class=s2>&#34;USEast_VPNGateway_WAN_PublicIP&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>azGWWanNicPublicIpDNS</span><span class=o>=</span><span class=s2>&#34;useast-gw&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Define the Gateway VM</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>azGWVmName</span><span class=o>=</span><span class=s2>&#34;Gateway-USEast&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>azGWVmSize</span><span class=o>=</span><span class=s2>&#34;Standard_A1_v2&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>azGWVmUsername</span><span class=o>=</span><span class=s2>&#34;damian&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Create a resource group.</span>
</span></span><span class=line><span class=cl>az group create <span class=se>\
</span></span></span><span class=line><span class=cl>   --name <span class=nv>$azResourceGroup</span> <span class=se>\
</span></span></span><span class=line><span class=cl>   --location <span class=nv>$azLocation</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Create a virtual network with one subnet</span>
</span></span><span class=line><span class=cl>az network vnet create <span class=se>\
</span></span></span><span class=line><span class=cl>   --name <span class=nv>$azVnetName</span> <span class=se>\
</span></span></span><span class=line><span class=cl>   --resource-group <span class=nv>$azResourceGroup</span> <span class=se>\
</span></span></span><span class=line><span class=cl>   --location <span class=nv>$azLocation</span> <span class=se>\
</span></span></span><span class=line><span class=cl>   --address-prefix <span class=nv>$azVnetPrefix</span> <span class=se>\
</span></span></span><span class=line><span class=cl>   --subnet-name <span class=nv>$azGWSubnetName</span> <span class=se>\
</span></span></span><span class=line><span class=cl>   --subnet-prefix <span class=nv>$azGWSubnetPrefix</span>
</span></span><span class=line><span class=cl>   
</span></span><span class=line><span class=cl><span class=c1># Create a public IP address resource</span>
</span></span><span class=line><span class=cl><span class=c1># Append the --allocation-method Static option for the allocation to be static</span>
</span></span><span class=line><span class=cl><span class=c1># The DnsName must be unique within the</span>
</span></span><span class=line><span class=cl>az network public-ip create <span class=se>\
</span></span></span><span class=line><span class=cl>   --name <span class=nv>$azGWWanNicPublicIpName</span> <span class=se>\
</span></span></span><span class=line><span class=cl>   --resource-group <span class=nv>$azResourceGroup</span> <span class=se>\
</span></span></span><span class=line><span class=cl>   --location <span class=nv>$azLocation</span> <span class=se>\
</span></span></span><span class=line><span class=cl>   --dns-name <span class=nv>$azGWWanNicPublicIpDNS</span> <span class=se>\
</span></span></span><span class=line><span class=cl>   --allocation-method Static
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Create a network interface connected to the VNet </span>
</span></span><span class=line><span class=cl><span class=c1># with a static private IP address and associate the </span>
</span></span><span class=line><span class=cl><span class=c1># public IP address# resource to the NIC.</span>
</span></span><span class=line><span class=cl>az network nic create <span class=se>\
</span></span></span><span class=line><span class=cl>   --name <span class=nv>$azGWWanNicName</span> <span class=se>\
</span></span></span><span class=line><span class=cl>   --resource-group <span class=nv>$azResourceGroup</span> <span class=se>\
</span></span></span><span class=line><span class=cl>   --location <span class=nv>$azLocation</span> <span class=se>\
</span></span></span><span class=line><span class=cl>   --subnet <span class=nv>$azGWSubnetName</span> <span class=se>\
</span></span></span><span class=line><span class=cl>   --vnet-name <span class=nv>$azVnetName</span> <span class=se>\
</span></span></span><span class=line><span class=cl>   --private-ip-address <span class=nv>$azGWWanNicPrivateIp</span> <span class=se>\
</span></span></span><span class=line><span class=cl>   --public-ip-address <span class=nv>$azGWWanNicPublicIpName</span>
</span></span><span class=line><span class=cl>   
</span></span><span class=line><span class=cl><span class=c1># Create a new VM with the NIC</span>
</span></span><span class=line><span class=cl>az vm create <span class=se>\
</span></span></span><span class=line><span class=cl>   --name <span class=nv>$azGWVmName</span> <span class=se>\
</span></span></span><span class=line><span class=cl>   --resource-group <span class=nv>$azResourceGroup</span> <span class=se>\
</span></span></span><span class=line><span class=cl>   --location <span class=nv>$azLocation</span> <span class=se>\
</span></span></span><span class=line><span class=cl>   --image UbuntuLTS <span class=se>\
</span></span></span><span class=line><span class=cl>   --size <span class=nv>$azGWVmSize</span> <span class=se>\
</span></span></span><span class=line><span class=cl>   --nics <span class=nv>$azGWWanNicName</span> <span class=se>\
</span></span></span><span class=line><span class=cl>   --authentication-type password <span class=se>\
</span></span></span><span class=line><span class=cl>   --admin-username <span class=nv>$azGWVmUsername</span></span></span></code></pre></div><h1 class="relative text-5xl font-semibold leading-tense text-secondary-500 mb-4 -ml-px" id=wireguard-installation><a href=#wireguard-installation class=header-mark aria-label="Header mark for 'WireGuard Installation'"></a><div id=wireguard-installation class="absolute -top-28"></div>WireGuard Installation</h1><h2 class="relative text-3xl font-bold leading-tight text-secondary-500 mb-2 mt-12 -ml-px"><div id=ubuntu-1604-1 class="absolute -top-28"></div>Ubuntu 16.04</h2><p>Installing is quick and simple, we just need to register the repository, add its content to our catalog index, and install the two packages we require. The following script acomplishs this for us</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>shell</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-2 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>apt-get update
</span></span><span class=line><span class=cl>apt-get upgrade
</span></span><span class=line><span class=cl>add-apt-repository ppa:wireguard/wireguard
</span></span><span class=line><span class=cl>apt-get update
</span></span><span class=line><span class=cl>apt-get install wireguard-dkms wireguard-tools</span></span></code></pre></div><h2 class="relative text-3xl font-bold leading-tight text-secondary-500 mb-2 mt-12 -ml-px"><div id=edgerouter class="absolute -top-28"></div>EdgeRouter</h2><p>Download the corresponding package from <code>https://github.com/Lochnair/vyatta-wireguard/releases</code>.
You will need to select the version based on your hardware</p><p>You can choose to upload to the routing, or ssh login routing, sudo su to root , the implementation of similar orders</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>shell</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-3 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>curl https://github.com/Lochnair/vyatta-wireguard/releases/download/0.0.20170612-2/wireguard-octeon-0.0.20170612-2.deb -o wireguard-octeon-0.0.20170612-2.deb</span></span></code></pre></div><p>After the download is complete, you can install the package with the following command</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>shell</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-4 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>sudo dpkg -i ./wireguard-ralink-<span class=si>${</span><span class=nv>RELEASE</span><span class=si>}</span>.deb</span></span></code></pre></div><h1 class="relative text-5xl font-semibold leading-tense text-secondary-500 mb-4 -ml-px" id=configuration><a href=#configuration class=header-mark aria-label="Header mark for 'Configuration'"></a><div id=configuration class="absolute -top-28"></div>Configuration</h1><h2 class="relative text-3xl font-bold leading-tight text-secondary-500 mb-2 mt-12 -ml-px"><div id=virtual-interfaces class="absolute -top-28"></div>Virtual Interfaces</h2><p>Creating the Virtual Interface which will be the endpoint for out Point to Point tunnel is not complex. Convention with Wireguard is to name the interface starting with <code>wg0</code>.</p><h3 class="text-xl font-bold text-primary-500 leading-tight mb-2" id=ubuntu-1604-2><a href=#ubuntu-1604-2 class=header-mark aria-label="Header mark for 'Ubuntu 16.04'"></a>Ubuntu 16.04</h3><p>In the Linux shell, we can add the new interface by leveraging the <code>ip</code> tools</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>shell</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-5 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>ip link add dev wg0 <span class=nb>type</span> wireguard
</span></span><span class=line><span class=cl>ip address add dev wg0 192.168.2.1/24</span></span></code></pre></div><h3 class="text-xl font-bold text-primary-500 leading-tight mb-2" id=edgerouter-1><a href=#edgerouter-1 class=header-mark aria-label="Header mark for 'EdgeRouter'"></a>EdgeRouter</h3><p>In configuration mode, we can leverage the <code>set interfaces</code> command to establish the interface</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>shell</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-6 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>configureset interfaces wireguard wg0 address 192.168.2.2/24</span></span></code></pre></div><h2 class="relative text-3xl font-bold leading-tight text-secondary-500 mb-2 mt-12 -ml-px"><div id=security-keys class="absolute -top-28"></div>Security Keys</h2><p>WireGuard is a asymmetric cryptography key-based VPN solution. We therefore need to generate a key pair for each node . We do this by creating a private key and then deriving a public key from it. Wireguardâ€™s own userspace tool <code>wg</code> assists with this task.</p><p>Lets create the key pair for the first node, which we will refer to as the <em>server</em>â€¦</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>shell</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-7 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>wg genkey &gt; server_private.key
</span></span><span class=line><span class=cl>wg pubkey &gt; server_public.key &lt; server_private.key</span></span></code></pre></div><p>And, the second pair we need for the second node, which we can refer to as the <em>router</em>â€¦</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>shell</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-8 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>wg genkey &gt; router_private.key
</span></span><span class=line><span class=cl>wg pubkey &gt; router_public.key &lt; router_private.key</span></span></code></pre></div><blockquote class=blockquote style=text-align:right><p>Important: For security we should be storing the key pair only on the same system on which it is used. If you created both key pairs on the same node, then ensure that you transfer the private key securely to the other node and remove it from original node.</p></blockquote><p>This should leave us with two files for the <em>server</em> and another two files for the <em>router</em>. Make sure you donâ€™t confuse these two pairâ€™s! The tunnel wonâ€™t work if the private and public keys of the endpoints are not correctly distributed!</p><p>For illustrative purposes, this is what the content of each of the Key files looks like</p><h2 class="relative text-3xl font-bold leading-tight text-secondary-500 mb-2 mt-12 -ml-px"><div id=server-configuration class="absolute -top-28"></div>Server Configuration</h2><h3 class="text-xl font-bold text-primary-500 leading-tight mb-2" id=ubuntu-1604-3><a href=#ubuntu-1604-3 class=header-mark aria-label="Header mark for 'Ubuntu 16.04'"></a>Ubuntu 16.04</h3><p>Create a configuration file named <code>wireguard.conf</code> and store it for example in <code>\etc\wireguard\</code></p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>plain</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-9 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>[Interface]
</span></span><span class=line><span class=cl>ListenPort = 51820
</span></span><span class=line><span class=cl>PrivateKey = &#34;insert `server_private.key` content goes here&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[Peer]
</span></span><span class=line><span class=cl>Endpoint = ip:port of endpoint (88.81.97.90:51820)
</span></span><span class=line><span class=cl>PublicKey = &#34;insert `router_public.key` content goes here&#34;
</span></span><span class=line><span class=cl>AllowedIPs = 0.0.0.0/0</span></span></code></pre></div><p>Once defined, we can link the configuration to Wireguard, and then turn up the Virtual Interface</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>shell</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-10 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>wg setconf wg0 /etc/wireguard/wireguard.conf
</span></span><span class=line><span class=cl>ip link <span class=nb>set</span> up dev wg0</span></span></code></pre></div><h3 class="text-xl font-bold text-primary-500 leading-tight mb-2" id=auto-load-on-server-restart><a href=#auto-load-on-server-restart class=header-mark aria-label="Header mark for 'Auto Load on Server Restart'"></a>Auto Load on Server Restart</h3><p>Using the <code>rc.local</code> file, we can have the tunnel endpoint automatically created at system boot</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>shell</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-11 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=c1># /etc/rc.local</span>
</span></span><span class=line><span class=cl><span class=c1># Add, Configure and establish the Wireguard Tunnel</span>
</span></span><span class=line><span class=cl>ip link add dev wg0 <span class=nb>type</span> wireguard
</span></span><span class=line><span class=cl>ip address add dev wg0 192.168.2.1/24
</span></span><span class=line><span class=cl>wg setconf wg0 /etc/wireguard/wireguard.conf
</span></span><span class=line><span class=cl>ip link <span class=nb>set</span> up dev wg0
</span></span><span class=line><span class=cl><span class=c1># Lets Configure the Firewall next...</span></span></span></code></pre></div><h3 class="text-xl font-bold text-primary-500 leading-tight mb-2" id=edgerouter-2><a href=#edgerouter-2 class=header-mark aria-label="Header mark for 'EdgeRouter'"></a>EdgeRouter</h3><p>On the edge router, we can complete the configuration as follows</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>shell</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-12 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=nb>set</span> interfaces wireguard wg0 listen-port <span class=m>51820</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> interfaces wireguard wg0 route-allowed-ips <span class=nb>false</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> interfaces wireguard wg0 private-key /config/auth/router_private.key
</span></span><span class=line><span class=cl><span class=nb>set</span> interfaces wireguard wg0 peer <span class=s2>&#34;insert `server_public.key` content goes here&#34;</span> description <span class=s2>&#34;insert &#39;Nickname&#39;&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> interfaces wireguard wg0 peer <span class=s2>&#34;insert `server_public.key` content goes here&#34;</span> allowed-ips 0.0.0.0/0
</span></span><span class=line><span class=cl><span class=nb>set</span> interfaces wireguard wg0 peer <span class=s2>&#34;insert `server_public.key` content goes here&#34;</span> endpoint ip:port of endpoint <span class=o>(</span>40.71.229.107:51820<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> interfaces wireguard wg0 peer <span class=s2>&#34;insert `server_public.key` content goes here&#34;</span> persistent-keepalive <span class=m>25</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>commit
</span></span><span class=line><span class=cl>save</span></span></code></pre></div><h2 class="relative text-3xl font-bold leading-tight text-secondary-500 mb-2 mt-12 -ml-px"><div id=validation class="absolute -top-28"></div>Validation</h2><h3 class="text-xl font-bold text-primary-500 leading-tight mb-2" id=server><a href=#server class=header-mark aria-label="Header mark for 'Server'"></a>Server</h3><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>shell</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-13 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>sudo wg
</span></span><span class=line><span class=cl>interface: wg0
</span></span><span class=line><span class=cl>  public key: <span class=nv>3cv0P5Q8o9rR4nyq3mx8iTid2CMjab4nrqbo5lgm4lc</span><span class=o>=</span>
</span></span><span class=line><span class=cl>  private key: <span class=o>(</span>hidden<span class=o>)</span>  listening port: <span class=m>51820</span>
</span></span><span class=line><span class=cl>peer: NkVVh4yt+ZO9FVgMtImHesXoWba1Wzrb5HXrvMg+rjY<span class=o>=</span>
</span></span><span class=line><span class=cl>  endpoint: 88.81.97.90:51820
</span></span><span class=line><span class=cl>  allowed ips: 0.0.0.0/0
</span></span><span class=line><span class=cl>  latest handshake: <span class=m>36</span> seconds ago
</span></span><span class=line><span class=cl>  transfer: <span class=m>572</span> B received, <span class=m>156</span> B sent</span></span></code></pre></div><h3 class="text-xl font-bold text-primary-500 leading-tight mb-2" id=router><a href=#router class=header-mark aria-label="Header mark for 'Router'"></a>Router</h3><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>shell</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-14 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>sudo wg
</span></span><span class=line><span class=cl>interface: wg0
</span></span><span class=line><span class=cl>  public key: NkVVh4yt+ZO9FVgMtImHesXoWba1Wzrb5HXrvMg+rjY<span class=o>=</span>
</span></span><span class=line><span class=cl>  private key: <span class=o>(</span>hidden<span class=o>)</span>  listening port: <span class=m>51820</span>
</span></span><span class=line><span class=cl>peer: <span class=nv>3cv0P5Q8o9rR4nyq3mx8iTid2CMjab4nrqbo5lgm4lc</span><span class=o>=</span>
</span></span><span class=line><span class=cl>  endpoint: 40.71.229.107:51820
</span></span><span class=line><span class=cl>  allowed ips: 0.0.0.0/0
</span></span><span class=line><span class=cl>  latest handshake: <span class=m>5</span> seconds ago
</span></span><span class=line><span class=cl>  transfer: <span class=m>92</span> B received, <span class=m>452</span> B sent</span></span></code></pre></div><h2 class="relative text-3xl font-bold leading-tight text-secondary-500 mb-2 mt-12 -ml-px"><div id=perfomance-testing class="absolute -top-28"></div>Perfomance Testing</h2><p>My router is connected to a 30Mb/30Mb service hosted by Westnet, and my average speedtest.net results at the time of running this next test was as follows</p><h3 class="text-xl font-bold text-primary-500 leading-tight mb-2" id=server-1><a href=#server-1 class=header-mark aria-label="Header mark for 'Server'"></a>Server</h3><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>shell</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-15 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>$ sudo apt install iperf3
</span></span><span class=line><span class=cl>$ iperf3 -s
</span></span><span class=line><span class=cl>-----------------------------------------------------------Server listening on <span class=m>5201</span>
</span></span><span class=line><span class=cl>-----------------------------------------------------------</span></span></code></pre></div><h3 class="text-xl font-bold text-primary-500 leading-tight mb-2" id=router-1><a href=#router-1 class=header-mark aria-label="Header mark for 'Router'"></a>Router</h3><p>The iPref3 application is pre-installed with the EdgeRouter so we just need to run the tool, which should automatically connect with the server we have listening</p><div class="code-block highlight is-closed show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>shell</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-16 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>$ iperf3 -c 192.168.2.1
</span></span><span class=line><span class=cl>Connecting to host 192.168.2.1, port <span class=m>5201</span>
</span></span><span class=line><span class=cl><span class=o>[</span>  4<span class=o>]</span> <span class=nb>local</span> 192.168.2.2 port <span class=m>53159</span> connected to 192.168.2.1 port <span class=m>5201</span>
</span></span><span class=line><span class=cl><span class=o>[</span> ID<span class=o>]</span> Interval           Transfer     Bandwidth       Retr<span class=o>[</span>  4<span class=o>]</span>   0.00-1.09   sec   <span class=m>768</span> KBytes  5.75 Mbits/sec    <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>[</span>  4<span class=o>]</span>   1.09-2.10   sec  1.12 MBytes  9.43 Mbits/sec    <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>[</span>  4<span class=o>]</span>   2.10-3.10   sec  1.75 MBytes  14.7 Mbits/sec    <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>[</span>  4<span class=o>]</span>   3.10-4.10   sec  2.88 MBytes  24.1 Mbits/sec    <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>[</span>  4<span class=o>]</span>   4.10-5.09   sec  4.38 MBytes  36.7 Mbits/sec    <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>[</span>  4<span class=o>]</span>   5.09-6.10   sec  3.38 MBytes  28.3 Mbits/sec  <span class=m>171</span>
</span></span><span class=line><span class=cl><span class=o>[</span>  4<span class=o>]</span>   6.10-7.09   sec  2.50 MBytes  21.0 Mbits/sec    <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>[</span>  4<span class=o>]</span>   7.09-8.09   sec  2.88 MBytes  24.1 Mbits/sec    <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>[</span>  4<span class=o>]</span>   8.09-9.10   sec  3.00 MBytes  25.1 Mbits/sec    <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>[</span>  4<span class=o>]</span>   9.10-10.09  sec  3.00 MBytes  25.2 Mbits/sec    <span class=m>0</span>
</span></span><span class=line><span class=cl>- - - - - - - - - - - - - - - - - - - - - - - - -<span class=o>[</span> ID<span class=o>]</span> Interval           Transfer     Bandwidth       Retr<span class=o>[</span>  4<span class=o>]</span>   0.00-10.09  sec  25.6 MBytes  21.3 Mbits/sec  <span class=m>171</span>         sender
</span></span><span class=line><span class=cl><span class=o>[</span>  4<span class=o>]</span>   0.00-10.09  sec  24.4 MBytes  20.3 Mbits/sec              receiver
</span></span><span class=line><span class=cl>iperf Done.</span></span></code></pre></div><p>The report should also be presented in the console of the server, similar to the following</p><div class="code-block highlight is-closed show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>shell</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-17 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>Accepted connection from 192.168.2.2, port <span class=m>53158</span>
</span></span><span class=line><span class=cl><span class=o>[</span>  5<span class=o>]</span> <span class=nb>local</span> 192.168.2.1 port <span class=m>5201</span> connected to 192.168.2.2 port <span class=m>53159</span>
</span></span><span class=line><span class=cl><span class=o>[</span> ID<span class=o>]</span> Interval           Transfer     Bandwidth<span class=o>[</span>  5<span class=o>]</span>   0.00-1.00   sec   <span class=m>457</span> KBytes  3.74 Mbits/sec
</span></span><span class=line><span class=cl><span class=o>[</span>  5<span class=o>]</span>   1.00-2.00   sec   <span class=m>919</span> KBytes  7.53 Mbits/sec
</span></span><span class=line><span class=cl><span class=o>[</span>  5<span class=o>]</span>   2.00-3.00   sec  1.59 MBytes  13.3 Mbits/sec
</span></span><span class=line><span class=cl><span class=o>[</span>  5<span class=o>]</span>   3.00-4.00   sec  2.46 MBytes  20.6 Mbits/sec
</span></span><span class=line><span class=cl><span class=o>[</span>  5<span class=o>]</span>   4.00-5.00   sec  3.78 MBytes  31.7 Mbits/sec
</span></span><span class=line><span class=cl><span class=o>[</span>  5<span class=o>]</span>   5.00-6.00   sec  3.19 MBytes  26.7 Mbits/sec
</span></span><span class=line><span class=cl><span class=o>[</span>  5<span class=o>]</span>   6.00-7.00   sec  2.61 MBytes  21.9 Mbits/sec
</span></span><span class=line><span class=cl><span class=o>[</span>  5<span class=o>]</span>   7.00-8.00   sec  2.87 MBytes  24.1 Mbits/sec
</span></span><span class=line><span class=cl><span class=o>[</span>  5<span class=o>]</span>   8.00-9.00   sec  3.00 MBytes  25.1 Mbits/sec
</span></span><span class=line><span class=cl><span class=o>[</span>  5<span class=o>]</span>   9.00-10.00  sec  3.01 MBytes  25.3 Mbits/sec
</span></span><span class=line><span class=cl><span class=o>[</span>  5<span class=o>]</span>  10.00-10.19  sec   <span class=m>598</span> KBytes  25.2 Mbits/sec
</span></span><span class=line><span class=cl>- - - - - - - - - - - - - - - - - - - - - - - - -<span class=o>[</span> ID<span class=o>]</span> Interval           Transfer     Bandwidth       Retr<span class=o>[</span>  5<span class=o>]</span>   0.00-10.19  sec  25.6 MBytes  21.1 Mbits/sec  <span class=m>171</span>             sender
</span></span><span class=line><span class=cl><span class=o>[</span>  5<span class=o>]</span>   0.00-10.19  sec  24.4 MBytes  20.1 Mbits/sec                  receiver</span></span></code></pre></div><h3 class="text-xl font-bold text-primary-500 leading-tight mb-2" id=results><a href=#results class=header-mark aria-label="Header mark for 'Results'"></a>Results</h3><p>The results of the test over the tunnel, when compared to my available bandwidth turns out.</p><p>Very Impressive!</p><h3 class="text-xl font-bold text-primary-500 leading-tight mb-2" id=enable-ipv4-routing><a href=#enable-ipv4-routing class=header-mark aria-label="Header mark for 'Enable IPv4 routing'"></a>Enable IPv4 routing</h3><p>First make sure IP forwarding is enabled by adding the following to <code>/etc/sysctl.conf</code></p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>plain</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-18 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>net.ipv4.ip_forward=1</span></span></code></pre></div><p>Run the following command to apply the above setting:</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>shell</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-19 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>sudo sysctl -p</span></span></code></pre></div><h1 class="relative text-5xl font-semibold leading-tense text-secondary-500 mb-4 -ml-px" id=router-policy-based-routing><a href=#router-policy-based-routing class=header-mark aria-label="Header mark for 'Router Policy Based Routing'"></a><div id=router-policy-based-routing class="absolute -top-28"></div>Router Policy Based Routing</h1><h2 class="relative text-3xl font-bold leading-tight text-secondary-500 mb-2 mt-12 -ml-px"><div id=group-of-devices-to-route class="absolute -top-28"></div>Group of devices to route</h2><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>shell</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-20 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>configureset firewall group address-group VPN_USEast address 172.16.1.197
</span></span><span class=line><span class=cl><span class=nb>set</span> firewall group address-group VPN_USEast address 172.16.1.198
</span></span><span class=line><span class=cl>commitexit</span></span></code></pre></div><h3 class="text-xl font-bold text-primary-500 leading-tight mb-2" id=table-for-route><a href=#table-for-route class=header-mark aria-label="Header mark for 'Table for route'"></a>Table for route</h3><p>Next, the configuration is the route table.
192.168.2.1 is wg0 network remote gateway address, wg0 local ip is 192.168.2.2, so do not need additional configuration 192.168.2.0/24 device routing.</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>shell</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-21 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>configureset protocols static table <span class=m>5</span> route 0.0.0.0/0 next-hop 192.168.2.1
</span></span><span class=line><span class=cl><span class=c1>#set protocols static table 1 interface-route 0.0.0.0/0 next-hop-interface wg0commitexit</span></span></span></code></pre></div><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>shell</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-22 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>show ip route table <span class=m>5</span></span></span></code></pre></div><h3 class="text-xl font-bold text-primary-500 leading-tight mb-2" id=define-a-modify-policy><a href=#define-a-modify-policy class=header-mark aria-label="Header mark for 'Define a Modify Policy'"></a>Define a Modify Policy</h3><p>The firewall configuration is as follows</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>shell</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-23 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>configure
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>set</span> firewall modify VPN_USEast_ROUTE rule <span class=m>10</span> description <span class=s1>&#39;Traffic from VPN_USEast to wg0&#39;</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> firewall modify VPN_USEast_ROUTE rule <span class=m>10</span> <span class=nb>source</span> group address-group VPN_USEast
</span></span><span class=line><span class=cl><span class=nb>set</span> firewall modify VPN_USEast_ROUTE rule <span class=m>10</span> modify table <span class=m>5</span></span></span></code></pre></div><h3 class="text-xl font-bold text-primary-500 leading-tight mb-2" id=apply-the-policy-to-the-switch-interface><a href=#apply-the-policy-to-the-switch-interface class=header-mark aria-label="Header mark for 'Apply the Policy to the Switch interface'"></a>Apply the Policy to the Switch interface</h3><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>shell</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-24 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=nb>set</span> interfaces switch switch0 firewall in modify VPN_USEast_ROUTE</span></span></code></pre></div><h3 class="text-xl font-bold text-primary-500 leading-tight mb-2" id=apply-the-policy><a href=#apply-the-policy class=header-mark aria-label="Header mark for 'Apply the Policy'"></a>Apply the Policy</h3><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>shell</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-25 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=nb>set</span> service nat rule <span class=m>5003</span> description VPN_USEast_MASQ
</span></span><span class=line><span class=cl><span class=nb>set</span> service nat rule <span class=m>5003</span> log disable
</span></span><span class=line><span class=cl><span class=nb>set</span> service nat rule <span class=m>5003</span> outbound-interface wg0
</span></span><span class=line><span class=cl><span class=nb>set</span> service nat rule <span class=m>5003</span> <span class=nb>source</span> group address-group VPN_USEast
</span></span><span class=line><span class=cl><span class=nb>set</span> service nat rule <span class=m>5003</span> <span class=nb>type</span> masquerade</span></span></code></pre></div><h3 class="text-xl font-bold text-primary-500 leading-tight mb-2" id=linux><a href=#linux class=header-mark aria-label="Header mark for 'Linux'"></a>Linux</h3><blockquote class=blockquote style=text-align:right><p>This is to be removed</p></blockquote><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>shell</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-26 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
</span></span><span class=line><span class=cl>sudo iptables -A FORWARD -i eth0 -o wg0 -m state --state RELATED,ESTABLISHED -j ACCEPT
</span></span><span class=line><span class=cl>sudo iptables -A FORWARD -i wg0 -o eth0 -j ACCEPT</span></span></code></pre></div><h1 class="relative text-5xl font-semibold leading-tense text-secondary-500 mb-4 -ml-px" id=installation><a href=#installation class=header-mark aria-label="Header mark for 'Installation'"></a><div id=installation class="absolute -top-28"></div>Installation</h1><h1 class="relative text-5xl font-semibold leading-tense text-secondary-500 mb-4 -ml-px" id=configuration-1><a href=#configuration-1 class=header-mark aria-label="Header mark for 'Configuration'"></a><div id=configuration-1 class="absolute -top-28"></div>Configuration</h1><p>Copy the output of the last command down to the server</p><p>After configuring the device, configure the nat service</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>shell</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-27 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>configure
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>set</span> service nat rule <span class=m>5032</span> outbound-interface wg0
</span></span><span class=line><span class=cl><span class=nb>set</span> service nat rule <span class=m>5032</span> <span class=nb>type</span> masquerade
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>commit
</span></span><span class=line><span class=cl>save</span></span></code></pre></div><p>The rest is to configure the routing rules, and can refer to my</p><h1 class="relative text-5xl font-semibold leading-tense text-secondary-500 mb-4 -ml-px" id=configuration-reference><a href=#configuration-reference class=header-mark aria-label="Header mark for 'Configuration Reference'"></a><div id=configuration-reference class="absolute -top-28"></div>Configuration Reference</h1><p>A firewall is just a set of rules that get run over every packet that comes or goes through the device itâ€™s running on. The rules look at things like which interface the packet is coming or going from, what ports itâ€™s using, what protocols itâ€™s using, the IPs involved, etc.. It uses the packetâ€™s properties to determine some sort of action like dropping the packet, rewriting it, or accepting it. When all the conditions of a rule match a packet, the action is applied to that packet. In Linux, the de facto firewall program is called iptables. Itâ€™s been around for decades and is incredibly powerful. On the other hand itâ€™s often criticized for being complex and unforgiving. Alternatives like the â€œuncomplicated firewallâ€ (ufw) have sprung up to try and make firewall configuration easier, but under the hood all they are doing is writing iptables rules. I donâ€™t think the basics of iptables are that complicated though if you just give it a chance. So let me explain how it works at a high level and Iâ€™ll demonstrate some basic rules that can lock down your router as well, if not better, than a commercial router.</p><h2 class="relative text-3xl font-bold leading-tight text-secondary-500 mb-2 mt-12 -ml-px"><div id=tables-and-chains class="absolute -top-28"></div>Tables and Chains</h2><p>Iptables works on these things called tables (obviously). There are 5 different tables it uses: raw, mangle, nat, filter, and security. Each of these tables are applied at a different stage of packet processing and so they can be used to achieve different things. This is just the basics though, so all weâ€™re going to focus on are the nat and filter tables.</p><p>Each of these tables contain chains, which are just a list of rules. There are 5 default chains called, <em>PREROUTING</em>, <em>INPUT</em>, <em>FORWARD</em>, <em>OUTPUT</em>, and <em>POSTROUTING</em>. Not every chain is applicable in every table though. For example the nat table only uses <em>PREROUTING</em> and <em>POSTROUTING</em> chains and the filter table only uses <em>INPUT</em>, <em>FORWARD</em>, and <em>OUTPUT</em> chains. For now lets focus on <em>INPUT</em>, <em>FORWARD</em>, and <em>OUTPUT</em>.</p><p>When a packet goes though the Linux network stack the chain of rules that get applied depends on where the packet is coming from and where it is going. If the packet is destined for the machine the firewall is running on, it would get run through the <em>INPUT</em> chain (the packet is an input to this system). If it is destined for some other machine then it gets run through the <em>FORWARD</em> table (the packet is being forwarded to another system). If the packet originated from the machine the firewall is running on it gets run through the <em>OUTPUT</em> table (the packet is an output of this system).</p><p>Like I said before, each of these chains is just a list of rules. Once the appropriate chain is picked based on the packetâ€™s source and destination the rules are run in order from the start of the list until a rule is matched. Each rule has a policy associated with it that says what to do with the packet if that rule is matched. The most common policies are <em>ACCEPT</em> and <em>DROP</em> which allow the packet through the firewall or deny it respectively. There are a lot more policies that let you gracefully reject packets, jump around to other rule chains, and more, but again, this is just the basics.</p><p>So what happens if no rules are matched? In fact this is whatâ€™s happening on your router right now. Since you havenâ€™t added any rules there are no rules to match. Each chain has a default policy which says what to do if no rules are matched. By default the policy is <em>ACCEPT</em>. See:</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>shell</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-28 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>$&gt; sudo iptables -LChain INPUT <span class=o>(</span>policy ACCEPT<span class=o>)</span>target     prot opt <span class=nb>source</span>               destination
</span></span><span class=line><span class=cl>Chain FORWARD <span class=o>(</span>policy ACCEPT<span class=o>)</span>target     prot opt <span class=nb>source</span>               destination
</span></span><span class=line><span class=cl>Chain OUTPUT <span class=o>(</span>policy ACCEPT<span class=o>)</span>target     prot opt <span class=nb>source</span>               destination</span></span></code></pre></div><p>This command lists <em>(-L)</em> the chains, rules, and default policies of an iptables table. By default it lists the filter table. To list a different table like nat you could add <code>-t nat</code> to the command. You can see for that each of the chains <em>INPUT</em>, <em>FORWARD</em>, and <em>OUTPUT</em> the policy if no rules are matched is <em>ACCEPT</em>. This is what I mean by your router is not secure right now. It will literally accept anything, from anywhere, going to anywhere. If you donâ€™t understand why this is bad for something connected to the public internet then you probably arenâ€™t the type of person that should be building their own router.</p><p>A default <em>ACCEPT</em> policy is <em>OK</em> for the <em>OUTPUT</em> table. Weâ€™ll assume that the router hasnâ€™t been hacked and any traffic it wants to send out to the world is acceptable. For the <em>INPUT</em> and <em>FORWARD</em> tables, which process packets from the outside world, you definitely want to change the default policy to <em>DROP</em>.</p><blockquote class=blockquote style=text-align:right><p>WARNING: DO NOT DO THIS OVER SSH. IT WILL DROP YOUR SSH CONNECTION:</p></blockquote><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>shell</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-29 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>$&gt; sudo iptables -P INPUT DROP
</span></span><span class=line><span class=cl>$&gt; sudo iptables -P FORWARD DROP</span></span></code></pre></div><p>And see the change:</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>shell</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-30 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>$&gt; sudo iptables -LChain INPUT <span class=o>(</span>policy DROP<span class=o>)</span>target     prot opt <span class=nb>source</span>               destination
</span></span><span class=line><span class=cl>Chain FORWARD <span class=o>(</span>policy DROP<span class=o>)</span>target     prot opt <span class=nb>source</span>               destination
</span></span><span class=line><span class=cl>Chain OUTPUT <span class=o>(</span>policy ACCEPT<span class=o>)</span>target     prot opt <span class=nb>source</span>               destination</span></span></code></pre></div><p>OK now youâ€™re safe from haxors. Youâ€™re router is dropping all your LAN traffic too though so youâ€™re also kind of fucked. Weâ€™ll need to add some more rules to allow the traffic we actually want.</p><h2 class="relative text-3xl font-bold leading-tight text-secondary-500 mb-2 mt-12 -ml-px"><div id=adding-rules class="absolute -top-28"></div>Adding Rules</h2><p>By default iptables rules are not persistent. This is good because if you fuck something up you can just reboot the machine and everything will be fine. Once youâ€™ve got a working set of rules though youâ€™ll want them to be applied automatically at boot. There are some packages like <code>iptables-persistent</code> and other bullshit like that to do it for you, but for simple folk thereâ€™s <code>/etc/rc.local</code>. Just put your commands in there and theyâ€™ll get run on every boot.</p><p>OK, now for some rules. I highly recommend running these on the command line and testing everything works before putting them into <code>/etc/rc.local</code> if youâ€™re doing this over SSH.</p><h3 class="text-xl font-bold text-primary-500 leading-tight mb-2" id=input-chain-rules><a href=#input-chain-rules class=header-mark aria-label="Header mark for 'Input Chain Rules'"></a>Input Chain Rules</h3><p>First of all, letâ€™s accept anything from the loopback interface:</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>shell</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-31 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>$&gt; sudo iptables -A INPUT -i lo -j ACCEPT</span></span></code></pre></div><p>And lets also allow anything on the LAN to send traffic to the router itself:</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>shell</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-32 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>$&gt; sudo iptables -A INPUT -i wg0 -j ACCEPT</span></span></code></pre></div><p>You should now be able to see these rules in the INPUT chain <em>(</em><code>*-v*</code>* just enables verbose output to show the interface names the rule applies to)*:</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>shell</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-33 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>$&gt; sudo iptables -L -vChain INPUT <span class=o>(</span>policy DROP <span class=m>50250</span> packets, 10M bytes<span class=o>)</span> pkts bytes target  prot opt in               out  <span class=nb>source</span>    destination
</span></span><span class=line><span class=cl>1140K  199M ACCEPT  all  --  lo               any  anywhere  anywhere
</span></span><span class=line><span class=cl>  14M 3023M ACCEPT  all  --  wg0  any  anywhere  anywhere
</span></span><span class=line><span class=cl>...</span></span></code></pre></div><p>These rules go in the <em>INPUT</em> chain because we want them to apply to traffic destined to the router itself.</p><ul><li>The <code>-A</code> just means append to the end of the current list of rules.</li></ul><blockquote class=blockquote style=text-align:right><p>Remember the rules are evaluated in order until a rule is matched so the order these things are inserted into the chain matters.</p></blockquote><ul><li>The <code>-i</code> option says to match this rule the packet must be coming from the <strong>wg0 interface</strong> <em>(which is my LAN interface)</em>.</li><li>Finally the <code>-j ACCEPT</code> says the policy to apply is to accept the packet.
Putting that all together we get â€œa packet from the LAN interface destined to the router should be acceptedâ€.</li></ul><p>Next, letâ€™s allow traffic from the WAN to the router. We donâ€™t just want the router to accept any packets from the WAN though. It should only accept packets that are part of a connection the router itself initiated. This prevents any random person on the internet from sending traffic to the router, but still ensures the router can still receive responses from the internet when it wants to. Since iptables does connection tracking its simple to make a rule like this with just a few more options:</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>shell</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-34 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>$&gt; sudo iptables -A INPUT -i eth0 -m conntrack <span class=se>\ </span>       --ctstate ESTABLISHED,RELATED -j ACCEPT</span></span></code></pre></div><p>Most of those options should make sense already, but let me explain the new ones: <code>-m</code> and <code>--ctstate</code>.</p><ul><li>m option specifies a â€œmatchâ€ to use. This is just some extra condition the packet must match for the rule to be applied. In this case we want to match on connection state so the conntrack matching extension is used.</li><li>ctstate option says which types of connections should be matched. To allow traffic from connections initiated by the router the rule needs to match ESTABLISHED and RELATED packets. This means a packet will be accepted if it is part of an already established TCP connection, or if it is related to a TCP connection in the process of being set up (router sends SYN, the SYN/ACK the server responds with is a â€œrelatedâ€ packet).</li></ul><h3 class="text-xl font-bold text-primary-500 leading-tight mb-2" id=forward-chain-rules><a href=#forward-chain-rules class=header-mark aria-label="Header mark for 'Forward Chain Rules'"></a>Forward Chain Rules</h3><p>So now we can send traffic from the LAN to the router, from the router to the LAN, and from the router to the WAN. But what about from the LAN to the WAN? For that we will need forwarding rules. Recall rules in the FORWARD table apply to packets from somewhere other than the router going to somewhere other than the router (neither source or destination IP is the routerâ€™s). The packets are just being forwarded through. The rules are very similar to the ones from before.</p><p>To accept traffic being forwarded from the LAN to the WAN:</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>shell</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-35 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>$&gt; sudo iptables -A FORWARD -i wg0 -o eth0 -j ACCEPT</span></span></code></pre></div><p>In other words â€œaccept packets coming in the LAN interface and going out the WAN interfaceâ€. Just like the router, we should accept traffic from the WAN going to the LAN if, and only if, the LAN initiated the connection:</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>shell</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-36 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>$&gt; sudo iptables -A FORWARD -i eth0 -o wg0 -m conntrack <span class=se>\ </span>       --ctstate ESTABLISHED,RELATED -j ACCEPT</span></span></code></pre></div><p>Alrighty, that should do it for filter table rules. Thereâ€™s still ony problem though. If a LAN device sends a packet to the WAN the source IP address will be a LAN address (something in the 192.168.0.0/24 space). These IPs are unrouteable on the public internet and will be dropped the second the packet leaves your house. Instead the router should change the source IP address on outgoing packets to its WAN IP. Then when a reply is received it should change the destination IP back to the LAN IP address and forward it along. This procedure is called Network Address Translation, aka NAT, and this is where the nat table comes into play.</p><h3 class="text-xl font-bold text-primary-500 leading-tight mb-2" id=nat><a href=#nat class=header-mark aria-label="Header mark for 'NAT'"></a>NAT</h3><p>To translate IP addresses between local addresses and publicly routable addresses, weâ€™ll need to add some rules to the PREROUTING and POSTROUTING chains of the nat table. These chains allow you to modify packets when theyâ€™re received and as they are being transmitted respectively. So to translate LAN IP addresses to the routerâ€™s WAN IP address we will have to add a POSTROUTING rule that rewrites the address just before the packet is sent out. Fortunately, iptables has built in things to make this easy. There is a policy called MASQUERADE that will do all the translation for us. All we need to do is add a rule and iptables will take care of all the NAT rewriting on outgoing and incoming packets that match the rule.</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>shell</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-37 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>$&gt; sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</span></span></code></pre></div><p>To see that it worked you can add <code>-t nat</code> to the <code>iptables -L</code> command to see the nat table rules:</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>shell</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-1 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>$&gt; sudo iptables -t nat -L -vChain PREROUTING <span class=o>(</span>policy ACCEPT <span class=m>2130</span> packets, 684K bytes<span class=o>)</span>pkts bytes target prot opt in out <span class=nb>source</span> destination
</span></span><span class=line><span class=cl>Chain INPUT <span class=o>(</span>policy ACCEPT <span class=m>1640</span> packets, 661K bytes<span class=o>)</span>pkts bytes target prot opt in out <span class=nb>source</span> destination
</span></span><span class=line><span class=cl>Chain OUTPUT <span class=o>(</span>policy ACCEPT <span class=m>15342</span> packets, 1363K bytes<span class=o>)</span>pkts bytes target prot opt in out <span class=nb>source</span> destination
</span></span><span class=line><span class=cl>Chain POSTROUTING <span class=o>(</span>policy ACCEPT <span class=m>15337</span> packets, 1362K bytes<span class=o>)</span>pkts bytes target     prot opt in  out   <span class=nb>source</span>   destination
</span></span><span class=line><span class=cl><span class=m>1200</span> <span class=m>83980</span> MASQUERADE all  --  any eth0  anywhere anywhere</span></span></code></pre></div><p>Boom, thatâ€™s it, you should have a working router. Test things out and make sure everything is working properly. If so then make sure to add all the iptables rules to your <code>/etc/rc.local</code> so they will be added after every boot. The completed thing should look something like this:</p><div class="code-block highlight is-closed show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>shell</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-2 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=c1># /etc/rc.local# Default policy to drop all incoming packets</span>
</span></span><span class=line><span class=cl>iptables -P INPUT DROP
</span></span><span class=line><span class=cl>iptables -P FORWARD DROP
</span></span><span class=line><span class=cl><span class=c1># Accept incoming packets from localhost and the LAN interface</span>
</span></span><span class=line><span class=cl>iptables -A INPUT -i lo -j ACCEPT
</span></span><span class=line><span class=cl>iptables -A INPUT -i wg0 -j ACCEPT
</span></span><span class=line><span class=cl><span class=c1># Accept incoming packets from the WAN if the router initiated# the connection</span>
</span></span><span class=line><span class=cl>iptables -A INPUT -i eth0 -m conntrack <span class=se>\
</span></span></span><span class=line><span class=cl>    --ctstate ESTABLISHED,RELATED -j ACCEPT
</span></span><span class=line><span class=cl><span class=c1># We also need to accept SSH to this interface</span>
</span></span><span class=line><span class=cl>iptables -A INPUT -p tcp --dport <span class=m>22</span> -j ACCEPT
</span></span><span class=line><span class=cl><span class=c1># Forward LAN packets to the WAN</span>
</span></span><span class=line><span class=cl>iptables -A FORWARD -i wg0 -o eth0 -j ACCEPT
</span></span><span class=line><span class=cl><span class=c1># Forward WAN packets to the LAN if the LAN initiated the# connection</span>
</span></span><span class=line><span class=cl>iptables -A FORWARD -i eth0 -o wg0 -m conntrack <span class=se>\
</span></span></span><span class=line><span class=cl>    --ctstate ESTABLISHED,RELATED -j ACCEPT
</span></span><span class=line><span class=cl><span class=c1># NAT traffic going out the WAN interface</span>
</span></span><span class=line><span class=cl>iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
</span></span><span class=line><span class=cl><span class=c1># rc.local needs to exit with 0</span>
</span></span><span class=line><span class=cl><span class=nb>exit</span> <span class=m>0</span></span></span></code></pre></div><p>Now stop, and back things up. Unless you want to do all that configuration over if something goes awry itâ€™s a good idea to copy all the configuration files somewhere safe.</p><h2 class="relative text-3xl font-bold leading-tight text-secondary-500 mb-2 mt-12 -ml-px"><div id=azure-hosting class="absolute -top-28"></div>Azure Hosting</h2><p>If you choose to host your Ubuntu Wireguard gateway in Azure, then the Azure virtual network will require the route tables to be modified to route the packets from the virtual network interface of the Ubuntu server correctly.</p><p>Recall that in our environment, we established a Wireguard tunnel between our Ubuntu server and Edgerouter, which is running as <em>192.168.2.0/24</em>, with the remote network behind the Edgerouter been defined as <em>172.16.1.0/24</em>.</p><h3 class="text-xl font-bold text-primary-500 leading-tight mb-2" id=create-the-udr-for-the-back-end-subnet><a href=#create-the-udr-for-the-back-end-subnet class=header-mark aria-label="Header mark for 'Create the UDR for the back-end subnet'"></a>Create the UDR for the back-end subnet</h3><p>To create the route table and route needed for the back-end subnet Run the following command</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>shell</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-3 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=nb>export</span> <span class=nv>azVnetUDR</span><span class=o>=</span><span class=s2>&#34;USEast_UDR&#34;</span>
</span></span><span class=line><span class=cl>az network route-table create --name <span class=nv>$azVnetUDR</span> <span class=se>\
</span></span></span><span class=line><span class=cl>   --resource-group <span class=nv>$azResourceGroup</span> <span class=se>\
</span></span></span><span class=line><span class=cl>   --location <span class=nv>$azLocation</span></span></span></code></pre></div><p>Run the following command to create a route in the route table to send all traffic destined to the Edgerouter subnet (172.16.1.0/24) to the Gateway VM (192.168.192.4):</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>shell</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-4 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=nb>export</span> <span class=nv>azVnetUDRRoutes</span><span class=o>=</span><span class=s2>&#34;USEast-Gateway-Routes&#34;</span>
</span></span><span class=line><span class=cl>az network route-table route create --name <span class=nv>$azVnetUDRRoutes</span> <span class=se>\
</span></span></span><span class=line><span class=cl>   --resource-group <span class=nv>$azResourceGroup</span> <span class=se>\
</span></span></span><span class=line><span class=cl>   --route-table-name <span class=nv>$azVnetUDR</span> <span class=se>\
</span></span></span><span class=line><span class=cl>   --address-prefix 192.168.192.0/24 <span class=se>\
</span></span></span><span class=line><span class=cl>   --next-hop-type VirtualAppliance <span class=se>\
</span></span></span><span class=line><span class=cl>   --next-hop-ip-address 192.168.192.4</span></span></code></pre></div><p>Run the following logging command to create a route in the route table to send all traffic destined to the Edgerouter subnet (192.168.2.0/24) to the Gateway VM (192.168.192.4):</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>shell</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-5 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=nb>export</span> <span class=nv>azVnetUDRRoutes</span><span class=o>=</span><span class=s2>&#34;USEast-Gateway-NAT-Routes&#34;</span>
</span></span><span class=line><span class=cl>az network route-table route create --name <span class=nv>$azVnetUDRRoutes</span> <span class=se>\
</span></span></span><span class=line><span class=cl>   --resource-group <span class=nv>$azResourceGroup</span> <span class=se>\
</span></span></span><span class=line><span class=cl>   --route-table-name <span class=nv>$azVnetUDR</span> <span class=se>\
</span></span></span><span class=line><span class=cl>   --address-prefix 192.168.2.0/24 <span class=se>\
</span></span></span><span class=line><span class=cl>   --next-hop-type VirtualAppliance <span class=se>\
</span></span></span><span class=line><span class=cl>   --next-hop-ip-address 192.168.192.4</span></span></code></pre></div><p>Run the following command to associate the route table with the Gateways subnet (called <em>default</em>):</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>shell</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-6 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>az network vnet subnet update --name <span class=nv>$azGWSubnetName</span> <span class=se>\
</span></span></span><span class=line><span class=cl>   --resource-group <span class=nv>$azResourceGroup</span> <span class=se>\
</span></span></span><span class=line><span class=cl>   --route-table <span class=nv>$azVnetUDR</span> <span class=se>\
</span></span></span><span class=line><span class=cl>   --vnet-name <span class=nv>$azVnetName</span></span></span></code></pre></div><h3 class="text-xl font-bold text-primary-500 leading-tight mb-2" id=enable-ip-forwarding-on-fw1><a href=#enable-ip-forwarding-on-fw1 class=header-mark aria-label="Header mark for 'Enable IP forwarding on FW1'"></a>Enable IP forwarding on FW1</h3><p>To enable IP forwarding in the NIC used by Gateway, complete the following steps:</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>shell</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-7 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>az network nic update <span class=se>\
</span></span></span><span class=line><span class=cl>   --resource-group Wireguard_USEast <span class=se>\
</span></span></span><span class=line><span class=cl>   --name wireguard-useast835 <span class=se>\
</span></span></span><span class=line><span class=cl>   --ip-forwarding true</span></span></code></pre></div><h2 class="relative text-3xl font-bold leading-tight text-secondary-500 mb-2 mt-12 -ml-px"><div id=router-2 class="absolute -top-28"></div>Router</h2><div class="code-block highlight is-closed show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>json</p></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-8 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=err>firewall</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=err>all-ping</span> <span class=err>enable</span>
</span></span><span class=line><span class=cl>  <span class=err>broadcast-ping</span> <span class=err>disable</span>
</span></span><span class=line><span class=cl>  <span class=err>group</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>     <span class=err>network-group</span> <span class=err>PRIVATE_NETS</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>       <span class=err>network</span> <span class=err>192.168.0.0/16</span>
</span></span><span class=line><span class=cl>       <span class=err>network</span> <span class=err>172.16.0.0/12</span>
</span></span><span class=line><span class=cl>       <span class=err>network</span> <span class=err>10.0.0.0/8</span>
</span></span><span class=line><span class=cl>     <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=err>}</span>
</span></span><span class=line><span class=cl>   <span class=err>ipv</span><span class=mi>6</span><span class=err>-receive-redirects</span> <span class=err>disable</span>
</span></span><span class=line><span class=cl>   <span class=err>ipv</span><span class=mi>6</span><span class=err>-src-route</span> <span class=err>disable</span>
</span></span><span class=line><span class=cl>   <span class=err>ip-src-route</span> <span class=err>disable</span>
</span></span><span class=line><span class=cl>   <span class=err>log-martians</span> <span class=err>disable</span>
</span></span><span class=line><span class=cl>   <span class=err>modify</span> <span class=err>balance</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=err>rule</span> <span class=err>10</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>       <span class=err>action</span> <span class=err>modify</span>
</span></span><span class=line><span class=cl>       <span class=err>description</span> <span class=nt>&#34;do NOT load balance lan to lan&#34;</span>
</span></span><span class=line><span class=cl>       <span class=err>destination</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=err>group</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>           <span class=err>network-group</span> <span class=err>PRIVATE_NETS</span>
</span></span><span class=line><span class=cl>         <span class=p>}</span>
</span></span><span class=line><span class=cl>       <span class=p>}</span>
</span></span><span class=line><span class=cl>       <span class=err>modify</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=err>table</span> <span class=err>main</span>
</span></span><span class=line><span class=cl>       <span class=p>}</span>
</span></span><span class=line><span class=cl>     <span class=err>}</span>
</span></span><span class=line><span class=cl>     
</span></span><span class=line><span class=cl>     <span class=err>rule</span> <span class=mi>20</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=err>action</span> <span class=err>modify</span>
</span></span><span class=line><span class=cl>       <span class=err>description</span> <span class=nt>&#34;do NOT load balance destination public address&#34;</span>
</span></span><span class=line><span class=cl>       <span class=err>destination</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=err>group</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>           <span class=err>address-group</span> <span class=err>ADDRv4_eth0</span>
</span></span><span class=line><span class=cl>         <span class=p>}</span>
</span></span><span class=line><span class=cl>       <span class=p>}</span>
</span></span><span class=line><span class=cl>       <span class=err>modify</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=err>table</span> <span class=err>main</span>
</span></span><span class=line><span class=cl>       <span class=p>}</span>
</span></span><span class=line><span class=cl>     <span class=err>}</span>
</span></span><span class=line><span class=cl>     
</span></span><span class=line><span class=cl>     <span class=err>rule</span> <span class=mi>30</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=err>action</span> <span class=err>modify</span>
</span></span><span class=line><span class=cl>       <span class=err>description</span> <span class=nt>&#34;do NOT load balance destination public address&#34;</span>
</span></span><span class=line><span class=cl>       <span class=err>destination</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=err>group</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>           <span class=err>address-group</span> <span class=err>ADDRv4_eth1</span>
</span></span><span class=line><span class=cl>         <span class=p>}</span>
</span></span><span class=line><span class=cl>       <span class=p>}</span>
</span></span><span class=line><span class=cl>       <span class=err>modify</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=err>table</span> <span class=err>main</span>
</span></span><span class=line><span class=cl>       <span class=p>}</span>
</span></span><span class=line><span class=cl>     <span class=err>}</span>
</span></span><span class=line><span class=cl>     
</span></span><span class=line><span class=cl>     <span class=err>rule</span> <span class=mi>70</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=err>action</span> <span class=err>modify</span>
</span></span><span class=line><span class=cl>       <span class=err>modify</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>         <span class=err>lb-group</span> <span class=err>G</span>
</span></span><span class=line><span class=cl>       <span class=p>}</span>
</span></span><span class=line><span class=cl>     <span class=err>}</span>
</span></span><span class=line><span class=cl>   <span class=err>}</span>
</span></span><span class=line><span class=cl>   <span class=err>name</span> <span class=err>WAN_IN</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=err>default-action</span> <span class=err>drop</span>
</span></span><span class=line><span class=cl>     <span class=err>description</span> <span class=nt>&#34;WAN to internal&#34;</span>
</span></span><span class=line><span class=cl>     <span class=err>rule</span> <span class=mi>10</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=err>action</span> <span class=err>accept</span>
</span></span><span class=line><span class=cl>       <span class=err>description</span> <span class=nt>&#34;Allow established/related&#34;</span>
</span></span><span class=line><span class=cl>       <span class=err>state</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=err>established</span> <span class=err>enable</span>
</span></span><span class=line><span class=cl>         <span class=err>related</span> <span class=err>enable</span>
</span></span><span class=line><span class=cl>       <span class=p>}</span>
</span></span><span class=line><span class=cl>     <span class=p>}</span>
</span></span><span class=line><span class=cl>     <span class=err>rule</span> <span class=mi>20</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=err>action</span> <span class=err>drop</span>
</span></span><span class=line><span class=cl>       <span class=err>description</span> <span class=nt>&#34;Drop invalid state&#34;</span>
</span></span><span class=line><span class=cl>       <span class=err>state</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=err>invalid</span> <span class=err>enable</span>
</span></span><span class=line><span class=cl>       <span class=p>}</span>
</span></span><span class=line><span class=cl>     <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=err>name</span> <span class=err>WAN_LOCAL</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=err>default-action</span> <span class=err>drop</span>
</span></span><span class=line><span class=cl>     <span class=err>description</span> <span class=nt>&#34;WAN to router&#34;</span>
</span></span><span class=line><span class=cl>     
</span></span><span class=line><span class=cl>     <span class=err>rule</span> <span class=mi>10</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=err>action</span> <span class=err>accept</span>
</span></span><span class=line><span class=cl>       <span class=err>description</span> <span class=nt>&#34;Allow established/related&#34;</span>
</span></span><span class=line><span class=cl>       <span class=err>state</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=err>established</span> <span class=err>enable</span>
</span></span><span class=line><span class=cl>         <span class=err>related</span> <span class=err>enable</span>
</span></span><span class=line><span class=cl>       <span class=p>}</span>
</span></span><span class=line><span class=cl>     <span class=p>}</span>
</span></span><span class=line><span class=cl>     <span class=err>rule</span> <span class=mi>20</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=err>action</span> <span class=err>drop</span>
</span></span><span class=line><span class=cl>       <span class=err>description</span> <span class=nt>&#34;Drop invalid state&#34;</span>
</span></span><span class=line><span class=cl>       <span class=err>state</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=err>invalid</span> <span class=err>enable</span>
</span></span><span class=line><span class=cl>       <span class=p>}</span>
</span></span><span class=line><span class=cl>     <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=err>receive-redirects</span> <span class=err>disable</span>
</span></span><span class=line><span class=cl>   <span class=err>send-redirects</span> <span class=err>enable</span>
</span></span><span class=line><span class=cl>   <span class=err>source-validation</span> <span class=err>disable</span>
</span></span><span class=line><span class=cl>   <span class=err>syn-cookies</span> <span class=err>enable</span>
</span></span><span class=line><span class=cl><span class=err>}</span>
</span></span><span class=line><span class=cl><span class=err>interfaces</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=err>ethernet</span> <span class=err>eth0</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>     <span class=err>address</span> <span class=err>88.81.97.90/29</span>
</span></span><span class=line><span class=cl>     <span class=err>address</span> <span class=err>88.81.97.91/29</span>
</span></span><span class=line><span class=cl>     <span class=err>address</span> <span class=err>88.81.97.92/29</span>
</span></span><span class=line><span class=cl>     <span class=err>address</span> <span class=err>88.81.97.93/29</span>
</span></span><span class=line><span class=cl>     <span class=err>address</span> <span class=err>88.81.97.94/29</span>
</span></span><span class=line><span class=cl>     <span class=err>description</span> <span class=err>WAN</span>
</span></span><span class=line><span class=cl>     <span class=err>duplex</span> <span class=err>auto</span>
</span></span><span class=line><span class=cl>     <span class=err>firewall</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>       <span class=err>in</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>         <span class=err>name</span> <span class=err>WAN_IN</span>
</span></span><span class=line><span class=cl>       <span class=p>}</span>
</span></span><span class=line><span class=cl>       <span class=err>local</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=err>name</span> <span class=err>WAN_LOCAL</span>
</span></span><span class=line><span class=cl>       <span class=p>}</span>
</span></span><span class=line><span class=cl>     <span class=err>}</span>
</span></span><span class=line><span class=cl>     <span class=err>speed</span> <span class=err>auto</span>
</span></span><span class=line><span class=cl>   <span class=err>}</span>
</span></span><span class=line><span class=cl>   <span class=err>ethernet</span> <span class=err>eth</span><span class=mi>1</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=err>address</span> <span class=err>dhcp</span>
</span></span><span class=line><span class=cl>     <span class=err>description</span> <span class=nt>&#34;WAN 2&#34;</span>
</span></span><span class=line><span class=cl>     <span class=err>duplex</span> <span class=err>auto</span>
</span></span><span class=line><span class=cl>     <span class=err>firewall</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=err>in</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>         <span class=err>name</span> <span class=err>WAN_IN</span>
</span></span><span class=line><span class=cl>       <span class=p>}</span>
</span></span><span class=line><span class=cl>       <span class=err>local</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=err>name</span> <span class=err>WAN_LOCAL</span>
</span></span><span class=line><span class=cl>       <span class=p>}</span>
</span></span><span class=line><span class=cl>     <span class=p>}</span>
</span></span><span class=line><span class=cl>     <span class=err>speed</span> <span class=err>auto</span>
</span></span><span class=line><span class=cl>   <span class=err>}</span>
</span></span><span class=line><span class=cl>   <span class=err>ethernet</span> <span class=err>eth</span><span class=mi>2</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=err>duplex</span> <span class=err>auto</span>
</span></span><span class=line><span class=cl>     <span class=err>speed</span> <span class=err>auto</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=err>ethernet</span> <span class=err>eth</span><span class=mi>3</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=err>duplex</span> <span class=err>auto</span>
</span></span><span class=line><span class=cl>     <span class=err>speed</span> <span class=err>auto</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=err>ethernet</span> <span class=err>eth</span><span class=mi>4</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=err>duplex</span> <span class=err>auto</span>
</span></span><span class=line><span class=cl>     <span class=err>speed</span> <span class=err>auto</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=err>loopback</span> <span class=err>lo</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=err>switch</span> <span class=err>switch</span><span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=err>address</span> <span class=err>172.16.1.1/24</span>
</span></span><span class=line><span class=cl>     <span class=err>description</span> <span class=err>Local</span>
</span></span><span class=line><span class=cl>     <span class=err>firewall</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>       <span class=err>in</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>       <span class=p>}</span>
</span></span><span class=line><span class=cl>     <span class=err>}</span>
</span></span><span class=line><span class=cl>     <span class=err>mtu</span> <span class=mi>1500</span>
</span></span><span class=line><span class=cl>     <span class=err>switch-port</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=err>interface</span> <span class=err>eth2</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>       <span class=p>}</span>
</span></span><span class=line><span class=cl>       <span class=err>interface</span> <span class=err>eth</span><span class=mi>3</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=p>}</span>
</span></span><span class=line><span class=cl>       <span class=err>interface</span> <span class=err>eth</span><span class=mi>4</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=p>}</span>
</span></span><span class=line><span class=cl>       <span class=err>vlan-aware</span> <span class=err>disable</span>
</span></span><span class=line><span class=cl>     <span class=err>}</span>
</span></span><span class=line><span class=cl>   <span class=err>}</span>
</span></span><span class=line><span class=cl>   <span class=err>wireguard</span> <span class=err>wg</span><span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=err>address</span> <span class=err>192.168.2.2/24</span>
</span></span><span class=line><span class=cl>     <span class=err>listen-port</span> <span class=err>51820</span>
</span></span><span class=line><span class=cl>     <span class=err>peer</span> <span class=err>3cv0P5Q8o9rR4nyq3mx8iTid2CMjab4nrqbo5lgm4lc=</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>       <span class=err>allowed-ips</span> <span class=err>0.0.0.0/0</span>
</span></span><span class=line><span class=cl>       <span class=err>description</span> <span class=nt>&#34;Azure USEast&#34;</span>
</span></span><span class=line><span class=cl>       <span class=err>endpoint</span> <span class=mf>40.71</span><span class=err>.</span><span class=mf>229.107</span><span class=p>:</span><span class=mi>51820</span>
</span></span><span class=line><span class=cl>     <span class=p>}</span>
</span></span><span class=line><span class=cl>     <span class=err>private-key</span> <span class=err>/config/auth/wg.private</span>
</span></span><span class=line><span class=cl>     <span class=err>route-allowed-ips</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>   <span class=err>}</span>
</span></span><span class=line><span class=cl><span class=err>}</span>
</span></span><span class=line><span class=cl><span class=err>load-balance</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=err>group</span> <span class=err>G</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>     <span class=err>interface</span> <span class=err>eth0</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>     <span class=p>}</span>
</span></span><span class=line><span class=cl>     <span class=err>interface</span> <span class=err>eth</span><span class=mi>1</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=err>failover-only</span>
</span></span><span class=line><span class=cl>     <span class=p>}</span>
</span></span><span class=line><span class=cl>     <span class=err>lb-local</span> <span class=err>enable</span>
</span></span><span class=line><span class=cl>     <span class=err>lb-local-metric-change</span> <span class=err>disable</span>
</span></span><span class=line><span class=cl>   <span class=err>}</span>
</span></span><span class=line><span class=cl><span class=err>}</span>
</span></span><span class=line><span class=cl><span class=err>protocols</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=err>static</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>     <span class=err>route</span> <span class=err>0.0.0.0/0</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>       <span class=err>next-hop</span> <span class=err>88.81.97.89</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>       <span class=p>}</span>
</span></span><span class=line><span class=cl>     <span class=err>}</span>
</span></span><span class=line><span class=cl>   <span class=err>}</span>
</span></span><span class=line><span class=cl><span class=err>}</span>
</span></span><span class=line><span class=cl><span class=err>service</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=err>dns</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>     <span class=err>forwarding</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>       <span class=err>cache-size</span> <span class=err>150</span>
</span></span><span class=line><span class=cl>       <span class=err>listen-on</span> <span class=err>switch0</span>
</span></span><span class=line><span class=cl>     <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=err>}</span>
</span></span><span class=line><span class=cl>   <span class=err>gui</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=err>http-port</span> <span class=err>80</span>
</span></span><span class=line><span class=cl>     <span class=err>https-port</span> <span class=err>443</span>
</span></span><span class=line><span class=cl>     <span class=err>older-ciphers</span> <span class=err>enable</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=err>nat</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=err>rule</span> <span class=err>5000</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>       <span class=err>description</span> <span class=nt>&#34;masquerade for WAN&#34;</span>
</span></span><span class=line><span class=cl>       <span class=err>outbound-interface</span> <span class=err>eth</span><span class=mi>0</span>
</span></span><span class=line><span class=cl>       <span class=err>type</span> <span class=err>masquerade</span>
</span></span><span class=line><span class=cl>     <span class=p>}</span>
</span></span><span class=line><span class=cl>     <span class=err>rule</span> <span class=mi>5002</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=err>description</span> <span class=nt>&#34;masquerade for WAN 2&#34;</span>
</span></span><span class=line><span class=cl>       <span class=err>outbound-interface</span> <span class=err>eth</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>       <span class=err>type</span> <span class=err>masquerade</span>
</span></span><span class=line><span class=cl>     <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=err>}</span>
</span></span><span class=line><span class=cl>   <span class=err>ssh</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=err>port</span> <span class=err>22</span>
</span></span><span class=line><span class=cl>     <span class=err>protocol-version</span> <span class=err>v2</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=err>unms</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=err>disable</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=err>}</span>
</span></span><span class=line><span class=cl><span class=err>system</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=err>conntrack</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>     <span class=err>expect-table-size</span> <span class=err>4096</span>
</span></span><span class=line><span class=cl>     <span class=err>hash-size</span> <span class=err>4096</span>
</span></span><span class=line><span class=cl>     <span class=err>table-size</span> <span class=err>32768</span>
</span></span><span class=line><span class=cl>     <span class=err>tcp</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>       <span class=err>half-open-connections</span> <span class=err>512</span>
</span></span><span class=line><span class=cl>       <span class=err>loose</span> <span class=err>enable</span>
</span></span><span class=line><span class=cl>       <span class=err>max-retrans</span> <span class=err>3</span>
</span></span><span class=line><span class=cl>     <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=err>}</span>
</span></span><span class=line><span class=cl>   <span class=err>host-name</span> <span class=err>ubnt</span>
</span></span><span class=line><span class=cl>   <span class=err>login</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=err>user</span> <span class=err>ubnt</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>       <span class=err>authentication</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>         <span class=err>encrypted-password</span> <span class=err>$...</span>
</span></span><span class=line><span class=cl>       <span class=p>}</span>
</span></span><span class=line><span class=cl>       <span class=err>level</span> <span class=err>admin</span>
</span></span><span class=line><span class=cl>     <span class=err>}</span>
</span></span><span class=line><span class=cl>   <span class=err>}</span>
</span></span><span class=line><span class=cl>   <span class=err>name-server</span> <span class=mf>8.8</span><span class=err>.</span><span class=mf>8.8</span>
</span></span><span class=line><span class=cl>   <span class=err>name-server</span> <span class=mf>8.8</span><span class=err>.</span><span class=mf>4.4</span>
</span></span><span class=line><span class=cl>   <span class=err>ntp</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=err>server</span> <span class=err>0.ubnt.pool.ntp.org</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>     <span class=p>}</span>
</span></span><span class=line><span class=cl>     <span class=err>server</span> <span class=mi>1</span><span class=err>.ubnt.pool.ntp.org</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=p>}</span>
</span></span><span class=line><span class=cl>     <span class=err>server</span> <span class=mi>2</span><span class=err>.ubnt.pool.ntp.org</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=p>}</span>
</span></span><span class=line><span class=cl>     <span class=err>server</span> <span class=mi>3</span><span class=err>.ubnt.pool.ntp.org</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=err>}</span>
</span></span><span class=line><span class=cl>   <span class=err>syslog</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=err>global</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>       <span class=err>facility</span> <span class=err>all</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>         <span class=err>level</span> <span class=err>notice</span>
</span></span><span class=line><span class=cl>       <span class=p>}</span>
</span></span><span class=line><span class=cl>       <span class=err>facility</span> <span class=err>protocols</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=err>level</span> <span class=err>debug</span>
</span></span><span class=line><span class=cl>       <span class=p>}</span>
</span></span><span class=line><span class=cl>     <span class=err>}</span>
</span></span><span class=line><span class=cl>   <span class=err>}</span>
</span></span><span class=line><span class=cl>   <span class=err>time-zone</span> <span class=err>UTC</span>
</span></span><span class=line><span class=cl>   <span class=err>traffic-analysis</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=err>dpi</span> <span class=err>enable</span>
</span></span><span class=line><span class=cl>     <span class=err>export</span> <span class=err>enable</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=err>}</span>
</span></span><span class=line><span class=cl><span class=err>/*</span> <span class=err>Warning:</span> <span class=err>Do</span> <span class=err>not</span> <span class=err>remove</span> <span class=err>the</span> <span class=err>following</span> <span class=err>line.</span> <span class=err>*/</span>
</span></span><span class=line><span class=cl><span class=err>/*</span> <span class=err>===</span> <span class=err>vyatta-config-version:</span> <span class=s2>&#34;config-management@1:conntrack@1:cron@1:dhcp-relay@1:dhcp-server@4:firewall@5:ipsec@5:nat@3:qos@1:quagga@2:system@4:ubnt-pptp@1:ubnt-unms@1:ubnt-util@1:vrrp@1:webgui@1:webproxy@1:zone-policy@1&#34;</span> <span class=err>===</span> <span class=err>*/</span>
</span></span><span class=line><span class=cl><span class=err>/*</span> <span class=err>Release</span> <span class=err>version:</span> <span class=err>v</span><span class=mf>1.9</span><span class=err>.</span><span class=mi>7</span><span class=err>+hotfix.</span><span class=mf>2.5010181</span><span class=err>.</span><span class=mf>170818.0412</span> <span class=err>*/</span></span></span></code></pre></div><h2 class="relative text-3xl font-bold leading-snug text-secondary-500 mb-2 mt-12 -ml-px"><div id=all-links class=onpage-anchor></div>All links in a practical list</h2><div class="w-full my-6"><a href=https://github.com/Lochnair/vyatta-wireguard/releases%3c/code%3e. class="break-all flex font-bold hover:text-black underline items-center leading-snug text-primary-500" target=_blank><div class="flex-shrink-0 h-5 w-5 mr-2"><svg class="w-full h-full" viewBox="0 0 20 20" fill="currentcolor"><path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828.0 1 1 0 00-1.414 1.414 4 4 0 005.656.0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828.0 1 1 0 101.414-1.414 4 4 0 00-5.656.0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd"/></svg></div>https://github.com/Lochnair/vyatta-wireguard/releases</code>.</a></div><div class="w-full my-6"><a href=https://github.com/Lochnair/vyatta-wireguard/releases/download/0.0.20170612-2/wireguard-octeon-0.0.20170612-2.deb class="break-all flex font-bold hover:text-black underline items-center leading-snug text-primary-500" target=_blank><div class="flex-shrink-0 h-5 w-5 mr-2"><svg class="w-full h-full" viewBox="0 0 20 20" fill="currentcolor"><path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828.0 1 1 0 00-1.414 1.414 4 4 0 005.656.0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828.0 1 1 0 101.414-1.414 4 4 0 00-5.656.0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd"/></svg></div>https://github.com/Lochnair/vyatta-wireguard/releases/download/0.0.20170612-2/wireguard-octeon-0.0.20170612-2.deb</a></div></div><aside class="order-first lg:order-last lg:pt-12"><div class="lg:sticky lg:top-24 overflow-y-auto" x-data=taToc data-length=197 data-threshold=400 data-elements=6 data-title-show data-title-hide><h2 class="relative text-3xl lg:text-xl font-bold leading-tight text-secondary-500">Table of contents</h2><div class="tableofcontents pt-4 px-1"><nav id=TableOfContents><ul><li><a href=#ubuntu-1604>Ubuntu 16.04</a><ul><li><a href=#azure>Azure</a></li></ul></li></ul><ul><li><a href=#ubuntu-1604-1>Ubuntu 16.04</a></li><li><a href=#edgerouter>EdgeRouter</a></li></ul><ul><li><a href=#virtual-interfaces>Virtual Interfaces</a><ul><li><a href=#ubuntu-1604-2>Ubuntu 16.04</a></li><li><a href=#edgerouter-1>EdgeRouter</a></li></ul></li><li><a href=#security-keys>Security Keys</a></li><li><a href=#server-configuration>Server Configuration</a><ul><li><a href=#ubuntu-1604-3>Ubuntu 16.04</a></li><li><a href=#auto-load-on-server-restart>Auto Load on Server Restart</a></li><li><a href=#edgerouter-2>EdgeRouter</a></li></ul></li><li><a href=#validation>Validation</a><ul><li><a href=#server>Server</a></li><li><a href=#router>Router</a></li></ul></li><li><a href=#perfomance-testing>Perfomance Testing</a><ul><li><a href=#server-1>Server</a></li><li><a href=#router-1>Router</a></li><li><a href=#results>Results</a></li><li><a href=#enable-ipv4-routing>Enable IPv4 routing</a></li></ul></li></ul><ul><li><a href=#group-of-devices-to-route>Group of devices to route</a><ul><li><a href=#table-for-route>Table for route</a></li><li><a href=#define-a-modify-policy>Define a Modify Policy</a></li><li><a href=#apply-the-policy-to-the-switch-interface>Apply the Policy to the Switch interface</a></li><li><a href=#apply-the-policy>Apply the Policy</a></li><li><a href=#linux>Linux</a></li></ul></li></ul><ul><li><a href=#tables-and-chains>Tables and Chains</a></li><li><a href=#adding-rules>Adding Rules</a><ul><li><a href=#input-chain-rules>Input Chain Rules</a></li><li><a href=#forward-chain-rules>Forward Chain Rules</a></li><li><a href=#nat>NAT</a></li></ul></li><li><a href=#azure-hosting>Azure Hosting</a><ul><li><a href=#create-the-udr-for-the-back-end-subnet>Create the UDR for the back-end subnet</a></li><li><a href=#enable-ip-forwarding-on-fw1>Enable IP forwarding on FW1</a></li></ul></li><li><a href=#router-2>Router</a></li></ul></nav></div><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC","true")</script></div></aside></div><div class="relative -mx-8 lg:-mx-40 xl:-mx-40 2xl:-mx-40 h-16 mb-32"><div class="overflow-hidden absolute-center -z-1"><div class="w-full h-full flex-center"><img src=/images/img-separate-gradient.svg loading=eager alt class="hidden sm:block w-full min-w-[768px]">
<img src=/images/img-separate.svg loading=eager alt class="block sm:hidden w-full min-w-[768px]"></div></div></div><div class="w-full sm:w-2/3 text-center text-secondary-500 mx-auto mb-8"><h2 class="relative text-5xl font-bold leading-tense overflow-hidden mb-4"><div id=strongmorestrong-articles class="absolute -top-28"></div><strong>More</strong> articles</h2><div class="text-lg leading-normal">Thoughts, topics or just solutions I would like to make available to you,
colleagues and fellow enthusiasts.</div></div><div class="grid grid-cols-1 sm:grid-cols-3 gap-y-12 sm:gap-12 my-12"><a href=/posts/configure-wireguard-on-unifi-usg/><div class="flex-center shadow-glow bg-gradient-radius to-blue-100 border border-blue-100 rounded-xl p-4 h-40 mb-2"><img class="h-full object-contain" src=./cover-a4bb7193.jpg></div><div class="text-md text-gray-600 leading-relaxed p-2"><h3 class="text-xl font-bold text-primary-500 leading-tight mb-2">Configure Wireguard on UniFi USG</h3><p><strong>Install the Wireguard Package</strong></p><p>SSH directly to your USG, and run the following commands:</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1"><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>shell</p></div></a></div></main></div></main><footer role=footer><div class="relative w-full bg-gray-100 bg-gradient-to-b from-gray-200 to-white pt-20"><div class="absolute inset-x-0 top-0 w-full h-40 text-white"><svg class="w-full" viewbox="0 0 1680 91" fill="currentcolor" preserveaspectratio="none"><path d="M1680 0H0L.324249e-4 61.9736C60.8062 60.5012 108.186 53.8676 158.825 46.7777 211.452 39.4093 267.601 31.548 346 28.4749c62.978-2.4687 133.888 5.1285 211.598 13.4542C669.71 53.9406 795.977 67.4685 933 54.4749c232-22 509 7.4989 747 35.9962V0z"/></svg></div><div class="flex justify-between w-full max-w-screen-2xl mx-auto px-8 lg:px-40 pb-16 pt-8"><div class="flex-shrink-0 w-2/12 sm:w-1/12"><img src=/images/img-logo-damian-flynn-blue.svg alt class=w-full></div><div class="flex-grow flex flex-wrap justify-between text-secondary-500 ml-8 pt-4"><div class="w-full sm:w-5/12 pb-8 sm:pb-2"><p class="text-base font-bold mb-2">Let me introduce myself</p><p class="text-sm text-gray-500 font-regular">I am a Microsoft Microsoft MVP with over 20 years of experience in making technology simpler through Infrastructure as Code (IaC) and cloud operations. Iâ€™m passionate about transforming complex Azure environments into intuitive systems, starting with a minimal viable product that delivers real value. My goal is to enhance user experience while empowering teams to grow and succeed in the cloud landscape.</p></div><div class="flex-shrink-0 w-4/12 sm:w-2/12 pb-2"><p class="text-base font-bold mb-2">Links</p><p class="text-sm leading-tight font-bold"><a href=/about class="inline-block text-primary-500 font-semibold hover:text-black hover:underline mb-1 mr-2">About</a>
<a href=/posts class="inline-block text-primary-500 font-semibold hover:text-black hover:underline mb-1 mr-2">Articles</a>
<a href=/contact.html class="inline-block text-primary-500 font-semibold hover:text-black hover:underline mb-1 mr-2">Contact</a>
<a href=/work.html class="inline-block text-primary-500 font-semibold hover:text-black hover:underline mb-1 mr-2">Work</a>
<a href=/disclaimer class="inline-block text-primary-500 font-semibold hover:text-black hover:underline mb-1 mr-2">Imprint</a>
<a href=/privacy class="inline-block text-primary-500 font-semibold hover:text-black hover:underline mb-1 mr-2">Privacy</a></p></div><div class="flex-shrink-0 w-6/12 sm:w-4/12 pb-2"><p class="text-base font-bold mb-2">Various topics</p><p class="text-sm leading-tight font-bold"><a href=/series/azure-iot-operations class="block text-primary-500 font-semibold hover:text-black hover:underline mb-1">Azure IoT Operations</a>
<a href=/series/building-azure-with-code class="block text-primary-500 font-semibold hover:text-black hover:underline mb-1">Building Azure with Code</a>
<a href=/series/ignite-2019 class="block text-primary-500 font-semibold hover:text-black hover:underline mb-1">Ignite 2019</a></p></div></div></div><div class="absolute inset-x-0 -bottom-2 text-secondary-500"><svg class="w-full h-12" fill="currentcolor" viewbox="0 0 1680 52" preserveaspectratio="none"><path d="m419 21.2305c-194 0-295-15.23306-418.99999624-12.2305l4298e-8 43L1680 51.9981V41.2042c-80-11.9737-348-48.3153-542-39.97374S613 21.2305 419 21.2305z"/></svg></div></div><div class="relative bg-secondary-500 text-xs font-semibold text-center text-secondary-50"><div class="w-full max-w-screen-2xl mx-auto px-8 lg:px-40 pb-6 pt-2"><p><svg class="icon" viewBox="0 0 512 512"><path d="M256 8C119.033 8 8 119.033 8 256s111.033 248 248 248 248-111.033 248-248S392.967 8 256 8zm0 448c-110.532.0-2e2-89.451-2e2-2e2.0-110.531 89.451-2e2 2e2-2e2 110.532.0 2e2 89.451 2e2 2e2.0 110.532-89.451 2e2-2e2 2e2zm107.351-101.064c-9.614 9.712-45.53 41.396-104.065 41.396-82.43.0-140.484-61.425-140.484-141.567.0-79.152 60.275-139.401 139.762-139.401 55.531.0 88.738 26.62 97.593 34.779a11.965 11.965.0 011.936 15.322l-18.155 28.113c-3.841 5.95-11.966 7.282-17.499 2.921-8.595-6.776-31.814-22.538-61.708-22.538-48.303.0-77.916 35.33-77.916 80.082.0 41.589 26.888 83.692 78.277 83.692 32.657.0 56.843-19.039 65.726-27.225 5.27-4.857 13.596-4.039 17.82 1.738l19.865 27.17a11.947 11.947.0 01-1.152 15.518z"/></svg>2011 - 2026<a href=/ target=_blank rel="noopener noreferrer"> </a>&nbsp;|&nbsp;<a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></p><div class="flex items-center justify-center my-2"><a href=https://www.youtube.com/channel/UCC-9OqE4nfLxDf-TonKqIRw/ class="font-extrabold text-white mx-2" title="Opens in new Window">Youtube </a><a href=https://github.com/damianflynn class="font-extrabold text-white mx-2" target=_blank title="Opens in new Window">GitHub </a><a href=https://www.x.com/damian_flynn class="font-extrabold text-white mx-2" target=_blank title="Opens in new Window">X </a><a href=https://www.linkedin.com/in/damianflynn class="font-extrabold text-white mx-2" target=_blank title="Opens in new Window">Linkedin</a></div><p></p></div></div></footer><script src=/js/js-scripts.js></script><script type=speculationrules>
        {
          "prerender": [
            {
              "where": { "href_matches": "/*" },
              "eagerness": "moderate"
            }
          ]
        }
    </script><script>console.log(`Page Title: Configuration the Ubiquity EdgeRouter with WireGuard
Page URL: https://damianflynn.github.io/posts/configuration-the-ubiquity-edgerouter-with-wireguard/
Page Type: posts`)</script></body></html>